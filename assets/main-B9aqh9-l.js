const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/vendor-BGI4Jo47.js","assets/vendor-R9Y6aq4i.css"])))=>i.map(i=>d[i]);
import{v as Fe,w as qe,J as y,Z as L,z as Je,x as Me,O as ne,y as De,r as g,j as e,a as Z,L as M,h as Q,B as He,n as le,S as ie,D as Se,F as Ke,X as re,t as fe,G as Ge,I as Pe,M as Xe,s as Ye,K as Qe,Q as Ae,U as Ve,V as Ze,o as te,c as er,m as Te,W as rr,Y as tr,_ as sr,$ as or,a0 as ar,a1 as nr,a2 as lr,a3 as ir,a4 as cr,a5 as dr,a6 as G,u as ur,a7 as mr,a8 as gr}from"./vendor-BGI4Jo47.js";import{P as J,U as Ue,B as pr,L as se,D as fr,a as hr,b as xr,S as br,R as yr,O as wr,c as vr,C as jr,d as Nr,e as kr,T as Sr}from"./components-D-9NuCx3.js";import"./main-B9aqh9-l.js";(function(){const r=document.createElement("link").relList;if(r&&r.supports&&r.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))a(o);new MutationObserver(o=>{for(const i of o)if(i.type==="childList")for(const m of i.addedNodes)m.tagName==="LINK"&&m.rel==="modulepreload"&&a(m)}).observe(document,{childList:!0,subtree:!0});function s(o){const i={};return o.integrity&&(i.integrity=o.integrity),o.referrerPolicy&&(i.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?i.credentials="include":o.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function a(o){if(o.ep)return;o.ep=!0;const i=s(o);fetch(o.href,i)}})();function Ct(t){return t&&t.__esModule&&Object.prototype.hasOwnProperty.call(t,"default")?t.default:t}function Dt(...t){return Fe(qe(t))}const ye=["😀","😃","😄","😁","😆","😅","😂","🤣","😊","😇","🙂","🙃","😉","😌","😍","🥰","😘","😗","😙","😚","😋","😛","😝","😜","🤪","🤨","🧐","🤓","😎","🤩","🥳","😏","😒","😞","😔","😟","😕","🙁","☹️","😣","😖","😫","😩","🥺","😢","😭","😤","😠","😡","🤬","🤯","😳","🥵","🥶","😱","😨","😰","😥","😓","🤗","🤔","🤭","🤫","🤥","😶","😐","😑","😬","🙄","😯"],Tr=["👕","👚","👔","👗","👖","🧥","🧦","👟","👞","🧢","👒","🎩","🧣","🧤","👜","👝","👛","👓","🕶️","🥾","🥿","🌂","☂️","💼","🎒","👑","💄","💍","💎","⌚","🧸","🔮","🧩","🧶","🧵","🔭","🧬","🔬","🧪","📱","💻","🖥️","🖱️","🖨️","📷","🎮","🎧","🎵","📚","✏️"],_r=["🎉","🎊","🎁","🎈","🎀","🎐","🎇","🎆","✨","🔥","💫","⭐","🌟","💥","💯","💢","💦","💤","💨","🕊️","💝","💖","💗","💓","💞","💕","❤️","🧡","💛","💚"],Er=()=>{const t=Math.floor(Math.random()*ye.length);return ye[t]},Cr=(t,r)=>{const s=Array.from(t).reduce((i,m)=>i+m.charCodeAt(0),0),a=r==="avatar"?ye:r==="product"?Tr:_r,o=s%a.length;return a[o]},q="https://v2786182.hosted-by-vdsina.ru/api/v1",X={PRODUCTS:15e3,ORDERS:12e3,PROFILE:12e3},je={PRODUCTS_TTL:5*60*1e3,PROFILE_TTL:10*60*1e3,ORDERS_TTL:3*60*1e3},R={_store:new Map,get(t,r){const s=this._store.get(t);return s?Date.now()-s.timestamp>r?(this._store.delete(t),null):s.data:null},set(t,r){this._store.set(t,{data:r,timestamp:Date.now()})},invalidate(t){this._store.delete(t)},clear(){this._store.clear()}},Dr=t=>{console.error("API Error:",t);let r="An error occurred. Please try again.";if(t.response){const s=t.response.status;try{const a=t.response.data;a&&a.detail?r=`API Error (${s}): ${a.detail}`:r=`API Error (${s}): ${t.response.statusText}`}catch{r=`API Error (${s}): Could not parse error details`}}else t.request?r="Network Error: No response from server. Using cached data instead.":t instanceof Error&&(r=`Error: ${t.message}`);return r.includes("Using cached data")?y.info(r):y.error(r),Promise.reject(new Error(r))},W=(t="GET",r,s=X.PRODUCTS)=>{const a=new AbortController,o=setTimeout(()=>a.abort(),s),i={method:t,signal:a.signal,mode:"cors",headers:{Accept:"application/json",...r?{"Content-Type":"application/json"}:{}},...r?{body:JSON.stringify(r)}:{}};return{signal:a.signal,options:i,clearTimeout:()=>clearTimeout(o)}},Pr="modulepreload",Ar=function(t){return"/dd-app-v1/"+t},_e={},Ur=function(r,s,a){let o=Promise.resolve();if(s&&s.length>0){document.getElementsByTagName("link");const m=document.querySelector("meta[property=csp-nonce]"),u=(m==null?void 0:m.nonce)||(m==null?void 0:m.getAttribute("nonce"));o=Promise.allSettled(s.map(n=>{if(n=Ar(n),n in _e)return;_e[n]=!0;const l=n.endsWith(".css"),p=l?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${n}"]${p}`))return;const d=document.createElement("link");if(d.rel=l?"stylesheet":Pr,l||(d.as="script"),d.crossOrigin="",d.href=n,u&&d.setAttribute("nonce",u),document.head.appendChild(d),l)return new Promise((c,x)=>{d.addEventListener("load",c),d.addEventListener("error",()=>x(new Error(`Unable to preload CSS for ${n}`)))})}))}function i(m){const u=new Event("vite:preloadError",{cancelable:!0});if(u.payload=m,window.dispatchEvent(u),!u.defaultPrevented)throw m}return o.then(m=>{for(const u of m||[])u.status==="rejected"&&i(u.reason);return r().catch(i)})};function ee(){var t;if(typeof window<"u"&&((t=window.Telegram)!=null&&t.WebApp))return window.Telegram.WebApp}function Ir(){try{console.log("Initializing Telegram WebApp...");try{Je.ready(),Me.expand(),console.log("Telegram WebApp initialized successfully using SDK")}catch(t){console.warn("SDK initialization failed, falling back to direct WebApp API:",t);const r=ee();if(r)r.ready(),r.expand(),console.log("Telegram WebApp initialized successfully using direct WebApp API");else throw new Error("Telegram WebApp is not available")}}catch(t){console.error("Error initializing Telegram WebApp:",t)}}function $r(){try{const t=document.documentElement;t.classList.add("telegram-webview");const r=ee(),s=L.isDark||(r==null?void 0:r.colorScheme)==="dark";s?(t.classList.add("dark"),t.classList.remove("light")):(t.classList.add("light"),t.classList.remove("dark")),console.log(`Theme set to ${s?"dark":"light"} mode`)}catch(t){console.error("Error setting theme class:",t)}}function Ne(){var t,r,s;try{if(console.log("Attempting to get Telegram user data..."),(s=(r=(t=window.Telegram)==null?void 0:t.WebApp)==null?void 0:r.initDataUnsafe)!=null&&s.user){const a=window.Telegram.WebApp.initDataUnsafe.user;console.log("User data found in window.Telegram.WebApp.initDataUnsafe:",a);try{localStorage.setItem("telegramUser",JSON.stringify(a))}catch(o){console.error("Error storing user data in localStorage:",o)}return a}return console.log("No Telegram user data available from any source"),null}catch(a){return console.error("Error getting Telegram user:",a),null}}function zr(t){var r,s,a,o;try{console.log("Showing back button");try{ne.offClick(()=>{})}catch{console.log("No existing back button handlers to remove")}if(ne.onClick(t),ne.show(),(s=(r=window.Telegram)==null?void 0:r.WebApp)!=null&&s.BackButton)try{window.Telegram.WebApp.BackButton.onClick(t),window.Telegram.WebApp.BackButton.show()}catch(i){console.error("Error using direct WebApp API for back button:",i)}console.log("Back button shown and callback registered")}catch(i){if(console.error("Error showing back button:",i),(o=(a=window.Telegram)==null?void 0:a.WebApp)!=null&&o.BackButton)try{window.Telegram.WebApp.BackButton.onClick(t),window.Telegram.WebApp.BackButton.show(),console.log("Back button shown using direct WebApp API")}catch(m){console.error("Error using direct WebApp API for back button:",m)}}}function Ee(){var t,r,s,a;try{if(console.log("Hiding back button"),ne.hide(),(r=(t=window.Telegram)==null?void 0:t.WebApp)!=null&&r.BackButton)try{window.Telegram.WebApp.BackButton.hide()}catch(o){console.error("Error using direct WebApp API to hide back button:",o)}console.log("Back button hidden")}catch(o){if(console.error("Error hiding back button:",o),(a=(s=window.Telegram)==null?void 0:s.WebApp)!=null&&a.BackButton)try{window.Telegram.WebApp.BackButton.hide(),console.log("Back button hidden using direct WebApp API")}catch(i){console.error("Error using direct WebApp API to hide back button:",i)}}}function Ie(t){var r,s,a;try{const o=ee();o!=null&&o.postEvent?o.postEvent("web_app_trigger_haptic_feedback",JSON.stringify(t)):(s=(r=window.Telegram)==null?void 0:r.WebviewProxy)!=null&&s.postEvent?window.Telegram.WebviewProxy.postEvent("web_app_trigger_haptic_feedback",JSON.stringify(t)):(a=window.TelegramWebviewProxy)!=null&&a.postEvent?window.TelegramWebviewProxy.postEvent("web_app_trigger_haptic_feedback",JSON.stringify(t)):console.warn("No method available to send haptic feedback event")}catch(o){console.error("Error sending haptic feedback event:",o)}}const Pt=(t="medium")=>{try{try{De.impactOccurred(t),console.log(`Haptic impact triggered via SDK: ${t}`)}catch(r){console.warn("SDK haptic impact failed, falling back to direct WebApp API:",r),Ie({type:"impact",impact_style:t}),console.log(`Haptic impact triggered via WebApp API: ${t}`)}}catch(r){console.error("Error triggering haptic impact:",r)}},V=()=>{try{try{De.selectionChanged(),console.log("Haptic selection triggered via SDK")}catch(t){console.warn("SDK haptic selection failed, falling back to direct WebApp API:",t),Ie({type:"selection_change"}),console.log("Haptic selection triggered via WebApp API")}}catch(t){console.error("Error triggering haptic selection:",t)}};function oe(){try{console.log("Requesting current theme from Telegram");try{const r=L.isDark;console.log("Using current theme params, isDark:",r);return}catch(r){console.warn("SDK theme params access failed, trying fallback method:",r)}const t=ee();if(!t){console.warn("Telegram WebApp is not available, can't request theme");return}if(typeof t.postEvent!="function"){console.warn("postEvent is not available in this Telegram client"),H();return}try{t.postEvent("web_app_request_theme"),console.log("Theme request sent successfully")}catch(r){console.warn("Error requesting theme using postEvent:",r),H()}}catch(t){console.error("Error requesting Telegram theme:",t),H()}}function Or(){console.log("Setting up theme change listener for instant updates");const t=()=>{console.log("Theme change detected, updating colors and styles"),$r(),H()},r=ee();if(r)try{return r.onEvent("themeChanged",t),window.addEventListener("themechange",t),()=>{try{r.offEvent("themeChanged",t)}catch(s){console.warn("Error removing Telegram theme listener:",s)}window.removeEventListener("themechange",t)}}catch(s){return console.error("Error setting up Telegram event listener:",s),window.addEventListener("themechange",t),()=>{window.removeEventListener("themechange",t)}}return window.addEventListener("themechange",t),()=>{window.removeEventListener("themechange",t)}}function H(){var t,r,s,a,o,i,m,u,n;try{console.log("Setting Telegram Mini App colors based on Telegram's native theme");const l=ee();let p,d,c,x,j,h,k,_;if(l){console.log("WebApp theme params:",l.themeParams),p=((t=l.themeParams)==null?void 0:t.bg_color)||(l.colorScheme==="dark"?"#271a28":"#ffffff"),d=((r=l.themeParams)==null?void 0:r.secondary_bg_color)||(l.colorScheme==="dark"?"#382639":"#f7f7f7"),c=((s=l.themeParams)==null?void 0:s.text_color)||(l.colorScheme==="dark"?"#ffffff":"#000000"),x=((a=l.themeParams)==null?void 0:a.hint_color)||(l.colorScheme==="dark"?"#7d7d7d":"#999999"),j=((o=l.themeParams)==null?void 0:o.link_color)||(l.colorScheme==="dark"?"#64baff":"#2481cc"),h=((i=l.themeParams)==null?void 0:i.button_color)||(l.colorScheme==="dark"?"#3390ec":"#2481cc"),k=((m=l.themeParams)==null?void 0:m.button_text_color)||"#ffffff",_=l.colorScheme==="dark",console.log("Using native Telegram theme colors:",{bgColor:p,secondaryBgColor:d,textColor:c,hintColor:x,linkColor:j,buttonColor:h,buttonTextColor:k,isDark:_});try{if(l.setHeaderColor?(l.setHeaderColor(d),console.log("Header color set using WebApp.setHeaderColor:",d)):(l.postEvent("web_app_set_header_color",JSON.stringify({color:d})),console.log("Header color set using postEvent:",d)),(u=window.Telegram)!=null&&u.WebApp){const b=window.Telegram.WebApp;typeof b.setHeaderColor=="function"&&(b.setHeaderColor(d),console.log("Header color set using global Telegram.WebApp.setHeaderColor"))}}catch(b){console.error("Error setting header color:",b);try{(n=window.Telegram)!=null&&n.WebApp&&typeof window.Telegram.WebApp.setHeaderColor=="function"&&(window.Telegram.WebApp.setHeaderColor("secondary_bg_color"),console.log("Header color set using color_key: secondary_bg_color"))}catch(N){console.error("All attempts to set header color failed:",N)}}try{l.setBackgroundColor?(l.setBackgroundColor(d),console.log("Background color set using WebApp.setBackgroundColor:",d)):(l.postEvent("web_app_set_background_color",JSON.stringify({color:d})),console.log("Background color set using postEvent:",d))}catch(b){console.error("Error setting background color:",b)}}else{console.log("WebApp not available, using SDK theme params"),p=L.backgroundColor||(L.isDark?"#271a28":"#ffffff"),d=L.secondaryBackgroundColor||(L.isDark?"#382639":"#f7f7f7"),c=L.textColor||(L.isDark?"#ffffff":"#000000"),x=L.hintColor||(L.isDark?"#7d7d7d":"#999999"),j=L.linkColor||(L.isDark?"#64baff":"#2481cc"),h=L.buttonColor||(L.isDark?"#3390ec":"#2481cc"),k=L.buttonTextColor||"#ffffff",_=!!L.isDark,console.log("Using SDK theme colors:",{bgColor:p,secondaryBgColor:d,textColor:c,hintColor:x,linkColor:j,buttonColor:h,buttonTextColor:k,isDark:_});try{Ur(async()=>{const{postEvent:b}=await import("./vendor-BGI4Jo47.js").then(N=>N.a9);return{postEvent:b}},__vite__mapDeps([0,1])).then(({postEvent:b})=>{b("web_app_set_header_color",{color:d}),console.log("Header color set to match frontend background:",d,"via SDK"),b("web_app_set_background_color",{color:d}),console.log("Background color set to:",d,"via SDK")}).catch(b=>{console.error("Error importing SDK for postEvent:",b)})}catch(b){console.error("Error setting colors via SDK:",b)}}Lr(d,c,x,j,h,k,d,_),oe()}catch(l){console.error("Error setting Telegram colors:",l)}}function Lr(t,r,s,a,o,i,m,u){try{const n=u===!0,l=t,p=m;console.log(`Applying ${n?"dark":"light"} theme CSS with Telegram colors`),console.log(`Using main background color: ${l}`),console.log(`Using header background color: ${p}`);const d=document.documentElement;n?(d.classList.add("dark"),d.classList.remove("light")):(d.classList.add("light"),d.classList.remove("dark")),d.classList.add("telegram-webview");const c=document.createElement("style");c.textContent=`
      :root {
        --tg-theme-bg-color: ${p} !important;
        --tg-theme-secondary-bg-color: ${l} !important;
        --tg-theme-text-color: ${r} !important;
        --tg-theme-hint-color: ${s} !important;
        --tg-theme-link-color: ${a} !important;
        --tg-theme-button-color: ${o} !important;
        --tg-theme-button-text-color: ${i} !important;
        --tg-color-scheme: ${n?"dark":"light"} !important;
        
        --telegram-bg: ${l} !important;
        --telegram-header-bg: ${p} !important;
        --telegram-secondary-bg: ${p} !important;
        --telegram-text: ${r} !important;
        --telegram-hint: ${s} !important;
        --telegram-link: ${a} !important;
        --telegram-button: ${o} !important;
        --telegram-button-text: ${i} !important;
      }
      
      body, html, #root {
        background-color: ${l} !important;
        color: ${r} !important;
      }
      
      .${n?"dark":"light"} body, .${n?"dark":"light"} html, .${n?"dark":"light"} #root {
        background-color: ${l} !important;
      }
      
      /* Apply colors to common UI elements */
      .card, .popover, .dropdown-menu, .card-container {
        background-color: ${p} !important;
        color: ${r} !important;
        border: 1px solid ${n?"rgba(255, 255, 255, 0.1)":"rgba(0, 0, 0, 0.1)"} !important;
      }
      
      a {
        color: ${a} !important;
      }
      
      .hint, .text-muted {
        color: ${s} !important;
      }
      
      .btn-primary, .button-primary {
        background-color: ${o} !important;
        color: ${i} !important;
      }
      
      /* Search inputs and form controls */
      input, select, textarea {
        background-color: ${l} !important;
        color: ${r} !important;
        border-color: ${s}30 !important;
      }
      
      input:focus, select:focus, textarea:focus {
        border-color: ${o} !important;
        box-shadow: 0 0 0 2px ${o}30 !important;
      }
      
      /* Size selector buttons */
      .size-button {
        background-color: ${l} !important;
        color: ${r} !important;
        border-color: ${s}30 !important;
      }
      
      .size-button.selected {
        background-color: ${o}10 !important;
        color: ${o} !important;
        border-color: ${o} !important;
      }
      
      /* Bottom navigation bar - solid color matching the secondary background color */
      .bottom-nav-bar {
        background-color: ${p} !important;
        /* Remove border and shadow */
        border-top: none !important;
        box-shadow: none !important;
        /* Add a subtle top border for separation */
        border-top: 1px solid ${n?"rgba(255, 255, 255, 0.05)":"rgba(0, 0, 0, 0.05)"} !important;
      }
      
      /* Bottom navigation items */
      .bottom-nav-bar a {
        color: ${s} !important;
        padding: 8px 0 !important;
        transition: all 0.2s ease !important;
      }
      
      /* Active navigation items */
      .bottom-nav-bar a.active, 
      .bottom-nav-bar a.active svg,
      .bottom-nav-bar a[aria-current="page"],
      .bottom-nav-bar a[aria-current="page"] svg {
        color: ${o} !important;
      }
      
      /* Navigation item hover effect */
      .bottom-nav-bar a:hover {
        color: ${o}CC !important;
        transform: translateY(-2px) !important;
      }
      
      /* Badge styling */
      .bottom-nav-bar .badge {
        background-color: ${o} !important;
        color: ${i} !important;
      }
      
      /* Force styles for desktop view */
      @media (min-width: 768px) {
        body, html, #root, .telegram-webview, .dark body, .dark html, .dark #root {
          background-color: ${l} !important;
        }
        
        .bottom-nav-bar, .dark .bottom-nav-bar {
          background-color: ${p} !important;
          border-top: none !important;
          box-shadow: none !important;
        }
      }
    `;const x=document.getElementById("telegram-theme-style");if(x&&x.remove(),c.id="telegram-theme-style",document.head.appendChild(c),d.style.setProperty("--tg-theme-bg-color",p,"important"),d.style.setProperty("--tg-theme-secondary-bg-color",l,"important"),d.style.setProperty("--tg-theme-text-color",r,"important"),d.style.setProperty("--tg-theme-hint-color",s,"important"),d.style.setProperty("--tg-theme-link-color",a,"important"),d.style.setProperty("--tg-theme-button-color",o,"important"),d.style.setProperty("--tg-theme-button-text-color",i,"important"),d.style.setProperty("--tg-color-scheme",n?"dark":"light","important"),document.body.style.backgroundColor=l,document.body.style.setProperty("background-color",l,"important"),document.body.style.color=r,document.body.style.setProperty("color",r,"important"),document.getElementById("root")){const h=document.getElementById("root");h.style.backgroundColor=l,h.style.setProperty("background-color",l,"important")}const j=document.querySelector(".bottom-nav-bar");j&&(j.style.backgroundColor=p,j.style.setProperty("background-color",p,"important"),j.style.backdropFilter="none",j.style.setProperty("-webkit-backdrop-filter","none","important"),j.style.borderTop="none",j.style.setProperty("border-top","none","important"),j.style.boxShadow="none",j.style.setProperty("box-shadow","none","important")),document.documentElement.style.backgroundColor=l,document.documentElement.style.setProperty("background-color",l,"important"),console.log(`${n?"Dark":"Light"} theme CSS applied with Telegram colors`)}catch(n){console.error("Error applying theme CSS:",n)}}function Rr(t){var r;try{console.log("Opening URL in Telegram:",t);const s=ee();if(s&&typeof s.openLink=="function"){s.openLink(t,{try_instant_view:!0}),console.log("URL opened using WebApp.openLink");return}if((r=window.Telegram)!=null&&r.WebApp){const a=window.Telegram.WebApp;if(typeof a.openLink=="function"){a.openLink(t,{try_instant_view:!0}),console.log("URL opened using global Telegram.WebApp.openLink");return}}console.warn("No Telegram-specific method available to open URL, falling back to window.open"),window.open(t,"_blank")}catch(s){console.error("Error opening URL in Telegram:",s),window.open(t,"_blank")}}const Br={PROFILE:t=>`profile_${t}`,RANK:t=>`rank_${t}`,DD_COINS:t=>`dd_coins_${t}`,DELIVERY_RATES:"delivery_rates"},z=()=>{try{const t=Ne();if(t)return console.log("Using Telegram user data from telegramUtils"),t;if(window.Telegram&&window.Telegram.WebApp){const r=window.Telegram.WebApp.initDataUnsafe.user;if(r&&r.id)return r;console.warn("Telegram WebApp available but user data is invalid")}return console.error("No Telegram user data available"),null}catch(t){return console.error("Error getting Telegram user:",t),null}},ce=async(t=!1)=>{try{const r=z();if(!r)return console.error("No Telegram user data available for existence check"),!1;console.log(`Checking if user exists: ID=${r.id}, username=${r.username||"not set"}`);const s={telegram_user_id:r.id};r.username&&(s.telegram_username=r.username);const{options:a,clearTimeout:o}=W("POST",s,X.PROFILE);try{const i=await fetch(`${q}/users/check-exists`,a);if(o(),!i.ok){if(i.status===404)return console.log("User not found (404), considered as non-existent"),!1;const n=await i.text();let l;try{l=JSON.parse(n).detail||n}catch{l=n||`HTTP error ${i.status}`}throw new Error(l)}const m=await i.text(),u=JSON.parse(m);return console.log("User existence check result:",u),t?u:u.exists}catch(i){return console.error("Error checking if user exists:",i),!1}}catch(r){return console.error("Error in checkUserExists:",r),!1}},$e=async t=>{try{const r=z(),s=t||(r?r.id:0),a=r?r.username||`user_${s}`:`user_${s}`;if(!s)throw console.error("No user ID available for profile check"),new Error("User ID required");return{telegram_username:a,rank:0,total_orders:0}}catch(r){return console.error("Error in legacy checkUserProfile:",r),{telegram_username:`user_${t||0}`,rank:0,total_orders:0}}},ae=async()=>{try{const t=z();if(!t||!t.id)return console.error("No Telegram user data available for getting DD coins balance"),0;const r=t.id;console.log(`Getting DD coins balance for user ID: ${r}`);const s=Br.DD_COINS(r),a=R.get(s,1e4);if(a!==null)return console.log("Using cached DD coins balance:",a),a;try{console.log(`Direct API call to: ${q}/users/${r}/dd-coins`);const{options:o,clearTimeout:i}=W("GET",null,X.PROFILE),m=`${q}/users/${r}/dd-coins`;console.log("API URL for DD coins:",m);const u=await fetch(m,o);if(i(),console.log("DD coins API response status:",u.status),u.status===404)return console.log("User not found in DD coins API, using default balance 0"),R.set(s,0),0;if(!u.ok){const l=await u.text();console.error("DD coins API non-OK response:",l);let p;try{p=JSON.parse(l).detail||l}catch{p=l||`HTTP error ${u.status}`}throw new Error(p)}const n=await u.text();if(console.log("Raw DD coins response:",n),!n)return console.error("Empty response from DD coins API"),0;try{const l=JSON.parse(n);console.log("DD coins response (parsed JSON):",l),console.log("DD coins balance value:",l.dd_coins_balance),console.log("Type of DD coins balance:",typeof l.dd_coins_balance);let p=0;return l.dd_coins_balance!==void 0?(p=typeof l.dd_coins_balance=="string"?parseFloat(l.dd_coins_balance):Number(l.dd_coins_balance),console.log("Retrieved balance value:",p)):console.error("DD coins balance field not found in response"),console.log("Parsed DD coins balance:",p),console.log("Type of parsed balance:",typeof p),R.set(s,p),p}catch(l){return console.error("Error parsing DD coins response:",l),0}}catch(o){return console.error("Error getting DD coins balance:",o),o.message.includes("User not found")||y.error(`Error getting DD coins balance: ${o.message}`),0}}catch(t){return console.error("Error in getDDCoinsBalance:",t),0}},he=[{sku:"TS001-BLK",item_name:"Basic T-Shirt",color_code:"BLK",brand:"FashionBrand",description:"Original SKU: TS001-BLK",price_rub:500,sizes:[{size:"M",quantity:2},{size:"L",quantity:2}],photos:[{photo_url:"https://example.com/photos/ts001_front.jpg",photo_category:"front"},{photo_url:"https://example.com/photos/ts001_side.jpg",photo_category:"side"}]},{sku:"JN002-BLU",item_name:"Slim Jeans",color_code:"BLU",brand:"DenimCo",description:"Original SKU: JN002-BLU",price_rub:1200,sizes:[{size:"32",quantity:2}],photos:[{photo_url:"https://example.com/photos/jn002_front.jpg",photo_category:"front"}]},{sku:"SW003-RED",item_name:"Wool Sweater",color_code:"RED",brand:"WinterWear",description:"Original SKU: SW003-RED",price_rub:1500,sizes:[{size:"S",quantity:1},{size:"M",quantity:3}],photos:[{photo_url:"https://example.com/photos/sw003_front.jpg",photo_category:"front"}]}],de={PRODUCTS:"products",CATEGORIES:"categories"},ke=async()=>{var t;console.log("Fetching products...");try{const r=R.get(de.PRODUCTS,je.PRODUCTS_TTL);if(r)return console.log("Using cached products data"),r;console.log("No cached products, fetching from API...");const{options:s,clearTimeout:a}=W("GET",void 0,X.PRODUCTS);try{const o=await fetch(`${q}/stock/in-stock`,s);if(a(),!o.ok){const n=await o.text();let l;try{l=JSON.parse(n).detail||n}catch{l=n||`HTTP error ${o.status}`}throw new Error(l)}const i=await o.text(),m=JSON.parse(i);if(console.log("Products fetched successfully, count:",((t=m.items)==null?void 0:t.length)||0),!m.items||!Array.isArray(m.items))return console.error("API returned invalid products data"),y.error("Invalid products data received from API"),he;const u=m.items.map(n=>{const l=typeof n.price_rub=="string"?parseFloat(n.price_rub.replace(/[^\d.-]/g,"")):Number(n.price_rub),p=Array.isArray(n.photos)?n.photos:[],d=Array.isArray(n.sizes)?n.sizes.map(c=>({...c,quantity:typeof c.quantity=="string"?parseInt(c.quantity,10):c.quantity})):[];return{...n,price_rub:isNaN(l)?0:l,photos:p,sizes:d}});return R.set(de.PRODUCTS,u),u}catch(o){return console.error("Error fetching products:",o),y.error(`Error loading products: ${o.message}`),he}}catch(r){return console.error("Error in fetchProducts:",r),y.error(`Error: ${r.message}`),he}},ze=async()=>{var t;console.log("Fetching categories...");try{const r=R.get(de.CATEGORIES,je.PRODUCTS_TTL);if(r)return console.log("Using cached categories data"),r;console.log("No cached categories, fetching from API...");const{options:s,clearTimeout:a}=W("GET",void 0,X.PRODUCTS);try{const o=await fetch(`${q}/stock/get-categories`,s);if(a(),!o.ok){const u=await o.text();let n;try{n=JSON.parse(u).detail||u}catch{n=u||`HTTP error ${o.status}`}throw new Error(n)}const i=await o.text(),m=JSON.parse(i);return console.log("Categories fetched successfully, count:",((t=m.categories)==null?void 0:t.length)||0),!m.categories||!Array.isArray(m.categories)?(console.error("API returned invalid categories data"),y.error("Invalid categories data received from API"),[]):(R.set(de.CATEGORIES,m.categories),m.categories)}catch(o){throw console.error("Error fetching categories:",o),o}}catch(r){return console.error("Failed to fetch categories:",r),Dr("Failed to fetch categories"),[]}},Wr={ORDERS:t=>`orders_${t}`},Oe=async()=>{try{const t=z();if(!t||!t.id)return console.error("No user data available when fetching orders"),[];console.log(`Fetching orders for user ID: ${t.id}...`);const r=Wr.ORDERS(t.id),s=R.get(r,je.ORDERS_TTL);if(s)return console.log("Using cached orders data"),s;console.log("No cached orders, fetching from API...");const a={telegram_user_id:t.id},{options:o,clearTimeout:i}=W("POST",a,X.ORDERS);try{const m=await fetch(`${q}/users/orders`,o);if(i(),m.status===404)return console.log("User has no orders or not found in orders API"),R.set(r,[]),[];if(!m.ok){const l=await m.text();let p;try{p=JSON.parse(l).detail||l}catch{p=l||`HTTP error ${m.status}`}throw new Error(p)}const u=await m.text(),n=JSON.parse(u);return console.log("Orders fetched successfully:",n),!n.orders||!Array.isArray(n.orders)?(console.error("API returned invalid orders data"),[]):(R.set(r,n.orders),n.orders)}catch(m){return console.error("Error fetching orders:",m),m.message.includes("User not found")||y.error("Данные пользователя недоступны. Попробуйте еще раз."),[]}}catch(t){return console.error("Error in fetchOrders:",t),t.message.includes("User not found")||y.error("Данные пользователя недоступны. Попробуйте еще раз."),[]}},Fr=async(t,r)=>{try{return console.log(`[MOCK API] Added product to cart - Product ID: ${t}, Size: ${r}`),!0}catch(s){return console.error("Error adding product to cart:",s),!1}},qr=async(t,r,s)=>{try{const o={price_cny:t,shipping_type:r==="car"?"cargo":r==="plane"?"aero":r,category:s};console.log("Shipping calculation request:",o);const{options:i,clearTimeout:m}=W("POST",o,X.PRODUCTS),u=await fetch(`${q}/orders/calculate-shipping`,i);if(m(),console.log(`Response status: ${u.status} ${u.statusText}`),!u.ok){const l=await u.json().catch(()=>null);throw console.error("API response not OK:",u.status,u.statusText),console.error("Error data:",l),new Error(`Failed to calculate shipping: ${(l==null?void 0:l.message)||u.statusText}`)}const n=await u.json();return console.log("Shipping calculation response:",n),n.shipping_cost}catch(a){throw console.error("Error calculating shipping:",a),new Error(`Error calculating shipping: ${a.message}`)}},Jr=async t=>{var r;try{if(!((r=t.items)!=null&&r.length))throw new Error("Order must contain at least one item");const s=t.items.map(n=>{if(n.item_type==="preorder"){if(!n.dewu_url)throw new Error("Preorder item must have a URL");if(!n.category_type)throw new Error("Preorder item must have a category type");if(!n.shipping_type)throw new Error("Preorder item must have a shipping type");if(!n.price_cny)throw new Error("Preorder item must have a price in CNY");const l=["обувь","одежда","аксессуары"];if(!l.includes(n.category_type))throw new Error(`Invalid category type for preorder. Must be one of: ${l.join(", ")}`);const p=["cargo","aero"];if(!p.includes(n.shipping_type))throw new Error(`Invalid shipping type for preorder. Must be one of: ${p.join(", ")}`);return{item_type:"preorder",dewu_url:n.dewu_url,size:n.size||"",price_cny:n.price_cny,category_type:n.category_type,shipping_type:n.shipping_type,quantity:n.quantity||1}}else{if(n.stock_id)return{item_type:"stock",stock_id:n.stock_id};if(!n.sku)throw new Error("Stock item must have a SKU");return{item_type:"stock",sku:n.sku,size:n.size||"",quantity:n.quantity||1}}});if((t.delivery_method==="courier"||t.delivery_method==="shipping")&&!t.delivery_address)throw new Error("Delivery address is required for courier or shipping delivery method");const a={telegram_user_id:t.telegram_user_id,items:s,delivery_method:t.delivery_method,delivery_address:t.delivery_address||"",promocode_text:t.promocode_text,dd_coins_amount:t.dd_coins_amount,final_price:t.final_price};console.log("Sending unified order request:",JSON.stringify(a,null,2));const{options:o,clearTimeout:i}=W("POST",a),m=await fetch(`${q}/orders/create-order`,o);if(i(),!m.ok){const n=await m.text();let l;try{l=JSON.parse(n).detail||n}catch{l=n}throw new Error(l)}return await m.json()}catch(s){throw console.error("Error creating unified order:",s),s}},At=async()=>{try{const{options:t,clearTimeout:r}=W("GET",void 0,X.PRODUCTS),s=await fetch(`${q}/orders/delivery-types`,t);if(r(),!s.ok){const o=await s.json().catch(()=>null);throw console.error("API response not OK:",s.status,s.statusText),console.error("Error data:",o),new Error(`Failed to fetch delivery types: ${(o==null?void 0:o.message)||s.statusText}`)}return(await s.json()).delivery_types||[]}catch(t){throw console.error("Error fetching delivery types:",t),t}},we=async t=>{try{const r=z(),s=t||(r?r.id:null);if(!s)return console.error("No Telegram user ID available for client info"),y.error("User data not available"),null;console.log(`Fetching client info for Telegram ID: ${s}`);const{options:a,clearTimeout:o}=W("GET"),i=await fetch(`${q}/clients/by-telegram/${s}`,a);if(o(),!i.ok){if(i.status===404)return console.log("Client info not found (404)"),null;const n=await i.text();return console.error(`API Error (${i.status}): ${n}`),y.error("Failed to fetch client information"),null}const m=await i.text(),u=JSON.parse(m);return console.log("Client info fetched:",u),u}catch(r){return console.error("Error fetching client info:",r),y.error("Failed to fetch client information"),null}},Mr=async(t,r,s)=>{try{const a=z();if(!a)return console.error("No Telegram user data available"),y.error("User data not available"),!1;console.log(`Updating client info for Telegram ID: ${a.id}`);const o={telegram_id:a.id};t&&(o.phone_number=t),r&&(o.email=r),s&&(o.address=s),console.log("Update client info request:",o);const{options:i,clearTimeout:m}=W("POST",o),u=await fetch(`${q}/clients/update-info`,i);if(m(),u.ok)return console.log(`Client info update successful with status: ${u.status}`),y.success("Client information updated successfully"),!0;{const n=await u.text();return console.error(`API Error (${u.status}): ${n}`),y.error("Failed to update client information"),!1}}catch(a){return console.error("Error updating client info:",a),y.error("Failed to update client information"),!1}},ue=`${q}/referrals`,Ce=async(t=0)=>{try{const r=z();if(!r)return console.error("No Telegram user data available"),y.error("User data not available"),null;console.log(`Getting referral info for Telegram ID: ${r.id}`);const{options:s,clearTimeout:a}=W("GET"),o=await fetch(`${ue}/info/${r.id}`,s);if(a(),!o.ok){const u=await o.text();if(console.error(`API Error (${o.status}): ${u}`),o.status===404){console.log("No referral code found, creating one...");const n=await Hr();if(n)return n;if(t===0)return console.log("Retrying to get referral info after creation..."),Ce(1)}return(t>0||o.status!==404)&&y.error("Failed to fetch referral information"),null}const i=await o.text(),m=JSON.parse(i);return console.log("Referral info fetched:",m),m}catch(r){return console.error("Error fetching referral info:",r),t===0?(console.log("Retrying to get referral info after error..."),Ce(1)):(y.error("Failed to fetch referral information"),null)}},Hr=async()=>{try{const t=z();if(!t)return console.error("No Telegram user data available"),y.error("User data not available"),null;console.log(`Creating referral code for Telegram ID: ${t.id}`);const{options:r,clearTimeout:s}=W("POST",{telegram_id:t.id}),a=await fetch(`${ue}/create`,r);if(s(),!a.ok){const m=await a.text();return console.error(`API Error (${a.status}): ${m}`),y.error("Failed to create referral code"),null}const o=await a.text(),i=JSON.parse(o);return console.log("Referral code created:",i),i}catch(t){return console.error("Error creating referral code:",t),y.error("Failed to create referral code"),null}},Ut=async()=>{try{const t=z();if(!t)return console.error("No Telegram user data available"),y.error("User data not available"),null;console.log(`Getting referral stats for Telegram ID: ${t.id}`);const{options:r,clearTimeout:s}=W("GET"),a=await fetch(`${ue}/stats/${t.id}`,r);if(s(),!a.ok){const m=await a.text();return console.error(`API Error (${a.status}): ${m}`),y.error("Failed to fetch referral statistics"),null}const o=await a.text(),i=JSON.parse(o);return console.log("Referral stats fetched:",i),i}catch(t){return console.error("Error fetching referral stats:",t),y.error("Failed to fetch referral statistics"),null}},It=async t=>{try{return navigator.share?(await navigator.share({title:"Join me on DD Store",text:"Use my referral link to join DD Store",url:t.telegram_deep_link}),y.success("Referral link shared successfully"),!0):(await navigator.clipboard.writeText(t.telegram_deep_link),y.success("Referral link copied to clipboard"),!0)}catch(r){console.error("Error sharing referral link:",r);try{return await navigator.clipboard.writeText(t.telegram_deep_link),y.success("Referral link copied to clipboard"),!0}catch{return y.error("Failed to share referral link"),!1}}},Kr=async t=>{try{const r=z();if(!r)return console.error("No Telegram user data available"),!1;console.log(`Registering referral for user ${r.id} with code ${t}`);const{options:s,clearTimeout:a}=W("POST",{telegram_id:r.id,referral_code:t}),o=await fetch(`${ue}/register`,s);if(a(),!o.ok){const u=await o.text();return console.error(`API Error (${o.status}): ${u}`),!1}const i=await o.text(),m=JSON.parse(i);return console.log("Referral registration result:",m),m.success}catch(r){return console.error("Error registering referral:",r),!1}},ve={DD_COINS:t=>`dd_coins_${t}`,DD_COINS_TTL:5*60*1e3},Gr=async t=>{const r=ve.DD_COINS(t),s=R.get(r,ve.DD_COINS_TTL);if(s!==null)return console.log("Using cached DD coins balance from optimized service:",s),s;try{const a=await ae();return R.set(r,a),a}catch(a){return console.error("Error fetching DD coins in optimized service:",a),0}},Le=async t=>{console.log("Fetching initial data in parallel...");try{const r=await Promise.allSettled([$e(t),Oe(),ke(),Gr(t)]),s=r[0].status==="fulfilled"?r[0].value:null,a=r[1].status==="fulfilled"?r[1].value:[],o=r[2].status==="fulfilled"?r[2].value:[],i=r[3].status==="fulfilled"?r[3].value:0;return r[0].status==="rejected"&&console.error("Failed to fetch profile:",r[0].reason),r[1].status==="rejected"&&console.error("Failed to fetch orders:",r[1].reason),r[2].status==="rejected"&&console.error("Failed to fetch products:",r[2].reason),r[3].status==="rejected"&&console.error("Failed to fetch DD coins balance:",r[3].reason),{profile:s,orders:a,products:o,ddCoinsBalance:i}}catch(r){return console.error("Error in parallel fetch:",r),y.error("Error loading data. Some features may be limited."),{profile:null,orders:[],products:[],ddCoinsBalance:0}}},Xr=async t=>{try{Le(t).then(()=>console.log("Background prefetch completed")).catch(r=>console.error("Background prefetch failed:",r));return}catch(r){console.error("Error starting prefetch:",r)}},Yr=async t=>{try{const r=`profile_${t}`,s=`orders_${t}`,a=ve.DD_COINS(t);R.invalidate(r),R.invalidate(s),R.invalidate(a),R.invalidate("products"),await Le(t),y.success("Data refreshed successfully")}catch(r){console.error("Error refreshing data:",r),y.error("Failed to refresh data")}},Re=g.createContext(void 0),Qr=({children:t})=>{const[r,s]=g.useState(null),[a,o]=g.useState(""),[i,m]=g.useState(""),[u,n]=g.useState(null),[l,p]=g.useState(Er()),[d,c]=g.useState(!0),[x,j]=g.useState(!1),h=g.useCallback(b=>{if(!b)return;console.log("Updating Telegram user data:",b),s(b),b.username?o(b.username):o(`user_${b.id}`);let N=b.first_name;b.last_name&&(N+=` ${b.last_name}`),m(N);try{localStorage.setItem("telegramUser",JSON.stringify(b)),localStorage.getItem("telegramUserData")&&localStorage.removeItem("telegramUserData")}catch{console.warn("Failed to store user data in localStorage")}const E=b.username||`user_${b.id}`;Xr(E,b.id).then(()=>{k(E,b.id)}).catch(P=>{console.error("Error during prefetch:",P),k(E,b.id)})},[]),k=g.useCallback(async(b,N)=>{try{console.log("Checking user profile...");const E=await $e(b,N);console.log("User profile loaded"),n(E)}catch(E){console.error("Error fetching user profile:",E);const P={telegram_username:b,rank:1,total_orders:0};console.log("Using default profile"),n(P)}},[]),_=g.useCallback(async()=>{try{if(c(!0),r){const b=r.username||`user_${r.id}`;await Yr(b,r.id),await k(b,r.id)}else y.error("No user data available for refresh")}catch(b){console.error("Error refreshing user data:",b),y.error(`Error refreshing data: ${b.message}`)}finally{c(!1)}},[r,k]);return g.useCallback(()=>{if(console.log("DEBUG - RAW TELEGRAM DATA:"),window.Telegram)if(console.log("window.Telegram exists"),window.Telegram.WebApp){if(console.log("window.Telegram.WebApp exists"),console.log("initData:",window.Telegram.WebApp.initData),window.Telegram.WebApp.initDataUnsafe)if(console.log("initDataUnsafe contents:",JSON.stringify(window.Telegram.WebApp.initDataUnsafe||{},null,2)),window.Telegram.WebApp.initDataUnsafe.user){const b=window.Telegram.WebApp.initDataUnsafe.user;return console.log("RAW USER OBJECT:",b),b}else console.log("No user data in initDataUnsafe");else console.log("No initDataUnsafe available");if(window.Telegram.WebApp.initData)try{const b=new URLSearchParams(window.Telegram.WebApp.initData);if(console.log("Parsed initData params:",Array.from(b.entries())),b.has("user"))try{const N=JSON.parse(decodeURIComponent(b.get("user")||"{}"));return console.log("User data parsed from initData:",N),N}catch(N){console.error("Error parsing user data from initData:",N)}else console.log("No user param in initData")}catch(b){console.error("Error parsing initData:",b)}else console.log("initData is empty")}else console.log("No WebApp in Telegram object");else console.log("No Telegram object in window");return null},[]),g.useEffect(()=>{if(x)return;(async()=>{try{c(!0),j(!0),console.log("Initializing user data...");const N=Ne();if(N){console.log("User data retrieved from Telegram WebApp:",N),h(N),c(!1);return}try{const E=localStorage.getItem("telegramUser")||localStorage.getItem("telegramUserData");if(E){const P=JSON.parse(E);console.log("Using stored user data:",P),h(P),c(!1);return}}catch{console.warn("Failed to retrieve user data from localStorage")}try{const E=await z();if(E){console.log("User data retrieved from API:",E),h(E),c(!1);return}}catch(E){console.error("Error getting user data from API:",E)}console.log("No user data available, using default values"),o("guest"),m("Guest User"),c(!1)}catch(N){console.error("Error initializing user data:",N),o("guest"),m("Guest User"),c(!1)}})()},[h,x]),e.jsx(Re.Provider,{value:{username:a,displayName:i,telegramUser:r,profile:u,avatarEmoji:l,loading:d,setUsername:o,setAvatarEmoji:p,updateTelegramUser:h,refreshUserData:_},children:t})},me=()=>{const t=g.useContext(Re);if(t===void 0)throw new Error("useUser must be used within a UserProvider");return t},Be=g.createContext(void 0),Vr=({children:t})=>{const[r,s]=g.useState([]),a=r.reduce((d,c)=>d+c.quantity,0),o=r.reduce((d,c)=>d+c.price*c.quantity,0);g.useEffect(()=>{const d=localStorage.getItem("cart");if(d)try{s(JSON.parse(d))}catch(c){console.error("Failed to parse cart from localStorage:",c)}},[]),g.useEffect(()=>{localStorage.setItem("cart",JSON.stringify(r))},[r]);const i=(d,c)=>{s(x=>{const j=x.findIndex(h=>h.productId===d.id&&h.size===c);if(j>=0){const h=[...x];return h[j].quantity+=1,h}else return[...x,{productId:d.id,name:d.name,color:d.color,size:c,price:d.price,quantity:1,item_type:"stock",photo_url:d.photo_url}]})},m=d=>{const c=`preorder-${btoa(d.dewu_url)}-${d.size}`;s(x=>{const j=x.findIndex(h=>h.productId===c);if(j>=0){const h=[...x];return h[j].quantity+=1,h}else return[...x,{productId:c,name:d.name,color:"",size:d.size,price:d.price,quantity:1,item_type:"preorder",dewu_url:d.dewu_url,category_type:d.category_type,delivery_type:d.delivery_type,shipping_type:d.shipping_type,price_cny:d.price_cny,photo_url:d.photo_url}]})},u=(d,c)=>{s(x=>{const j=x.findIndex(h=>h.productId===d&&h.size===c);if(j>=0){const h=[...x];return h[j].quantity>1?h[j].quantity-=1:h.splice(j,1),h}return x})},n=(d,c,x)=>{s(j=>{const h=j.findIndex(k=>k.productId===d&&k.size===c);if(h>=0){const k=[...j];return x<=0?k.splice(h,1):k[h].quantity=x,k}else x>0&&console.warn("Attempted to update quantity for non-existent item");return j})},l=(d,c)=>{const x=r.find(j=>j.productId===d&&j.size===c);return x?x.quantity:0},p=()=>{s([]),y.info("Cart cleared")};return e.jsx(Be.Provider,{value:{items:r,addToCart:i,addPreorderToCart:m,removeFromCart:u,clearCart:p,itemCount:a,totalPrice:o,updateQuantity:n,getItemQuantity:l},children:t})},ge=()=>{const t=g.useContext(Be);if(t===void 0)throw new Error("useCart must be used within a CartProvider");return t},Zr=()=>{const[t,r]=g.useState(null),[s,a]=g.useState(!1),[o,i]=g.useState(!1);return g.useEffect(()=>{(()=>{try{const u=new URL(window.location.href),n=u.searchParams.get("ref"),l=u.searchParams.get("start");if(l&&l.startsWith("ref_")){const d=l.substring(4);if(d){console.log("Referral code detected from Telegram deep link:",d),r(d),u.searchParams.delete("start"),window.history.replaceState({},document.title,u.toString());return}}const p=window.location.pathname.split("/");if(p.length>=3&&p[1]==="ref"){const d=p[2];if(d){console.log("Referral code detected from path:",d),r(d);const c=window.location.pathname.replace(/\/ref\/[^\/]+/,"");window.history.replaceState({},document.title,c+window.location.search);return}}n&&(console.log("Referral code detected from query parameter:",n),r(n),u.searchParams.delete("ref"),window.history.replaceState({},document.title,u.toString()))}catch(u){console.error("Error detecting referral code:",u)}})()},[]),g.useEffect(()=>{(async()=>{if(!(!t||o||s)){a(!0);try{const u=JSON.parse(localStorage.getItem("processedReferrals")||"[]");if(u.includes(t)){console.log("Referral already processed:",t),i(!0),a(!1);return}await Kr(t)&&(console.log("Referral registered successfully"),u.push(t),localStorage.setItem("processedReferrals",JSON.stringify(u))),i(!0)}catch(u){console.error("Error processing referral:",u)}finally{a(!1)}}})()},[t,o,s]),{referralCode:t,isProcessing:s,isProcessed:o}},xe=async t=>{try{const r=await fetch("https://v2786182.hosted-by-vdsina.ru/api/v1/users/dd-coins",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({telegram_user_id:t,reason_code:"WELCOME"})});if(!r.ok){const a=await r.text();return console.error(`Error adding DD coins: ${a}`),!1}const s=await r.json();return console.log("DD coins added successfully:",s),!0}catch(r){return console.error("Error adding DD coins:",r),!1}},be=()=>{setTimeout(()=>{const t=document.createElement("div");t.className="fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-black text-white p-6 rounded-lg shadow-lg z-50 w-80 text-center",t.innerHTML=`
      <div class="flex flex-col items-center">
        <div class="text-yellow-400 text-xl mb-2">🎁 Welcome Bonus!</div>
        <div class="text-lg font-bold mb-2">500 DD Coins Added</div>
        <div class="text-sm">Your welcome bonus has been added to your account.</div>
      </div>
    `,document.body.appendChild(t),setTimeout(()=>{t.classList.add("opacity-0","transition-opacity","duration-500"),setTimeout(()=>{document.body.removeChild(t)},500)},4e3)},1500)},et=t=>{const[r,s]=g.useState(!1),[a,o]=g.useState(!1),[i,m]=g.useState(!1);return g.useEffect(()=>{(async()=>{if(!(i||a)){o(!0);try{const n=z();if(!n){console.log("No Telegram user available, cannot check registration status"),o(!1);return}const l=await ce(!0);if(console.log("User check response:",l),l&&typeof l=="object"){const p=l;p.status==="created"?(console.log("New user created"),s(!0),t!=null&&t.onNewUser&&t.onNewUser(!0),await xe(n.id)&&(y.success("Добро пожаловать! 500 DD coins добавлены на ваш счет в качестве бонуса!",{duration:6e3,id:"welcome-bonus"}),be())):p.status==="updated"?(console.log("User updated"),await xe(n.id)&&(y.success("С возвращением! 500 DD coins добавлены на ваш счет!",{duration:6e3,id:"welcome-back-bonus"}),be())):s(!1)}else l===!1?(console.log("New user detected (boolean response)"),s(!0),t!=null&&t.onNewUser&&t.onNewUser(!0),await xe(n.id)&&(y.success("Добро пожаловать! 500 DD coins добавлены на ваш счет в качестве бонуса!",{duration:6e3,id:"welcome-bonus"}),be())):s(!1);m(!0)}catch(n){console.error("Error checking user registration:",n)}finally{o(!1)}}})()},[i,a,t]),{isNewUser:r,isChecking:a,hasChecked:i}},$t="/dd-app-v1/assets/managerbg-C5Ov9nHO.webp",rt="/dd-app-v1/assets/jointgbanner-z8r3ZTiB.webp",tt="/dd-app-v1/assets/buycatsofabanner-B10ET0Ew.webp",st="/dd-app-v1/assets/ddcoinsbanner-CoK16W-f.webp",ot="/dd-app-v1/assets/calcbanner-DYKRYP7q.webp",at="/dd-app-v1/assets/gotoshopbanner-BBwQ6dpk.webp",nt="/dd-app-v1/assets/sneakers_category_banner-DKr6-pVn.webp",lt="/dd-app-v1/assets/clothes_category_banner-v623PAGN.webp",it="/dd-app-v1/assets/jeans_category_banner-DZUGsAeq.webp",ct="/dd-app-v1/assets/belt_category_banner-hZV84ikf.webp",dt=()=>{const{username:t,displayName:r,telegramUser:s,avatarEmoji:a,updateTelegramUser:o}=me(),i=Z(),[m,u]=g.useState(0),[n,l]=g.useState(!1);g.useEffect(()=>{s!=null&&s.id&&p(s.id)},[s]);const p=async j=>{if(j){l(!0);try{console.log(`Fetching DD coins for user ID: ${j}`);const h=await ae();console.log("Home page: DD coins balance received:",h),u(h)}catch(h){console.error("Error fetching DD coins balance:",h),y.error("Failed to load DD coins balance")}finally{l(!1)}}},d=[{image:rt,link:"https://t.me/dd_concept",external:!0},{image:tt,link:"/shop?brand=Cat%26Sofa"},{image:st,link:"/profile"}],c=(s==null?void 0:s.username)||t,x=j=>{j.preventDefault(),V(),i("/profile")};return e.jsxs(J,{fullHeight:!0,className:"p-4 pb-20",children:[e.jsx("header",{className:"mb-6",children:e.jsxs(M,{to:"/profile",className:"flex items-center gap-3 hover:opacity-90 transition-opacity",onClick:x,children:[e.jsx(Ue,{user:s,emoji:a,size:"md",className:"hover-lift"}),e.jsxs("div",{children:[e.jsxs("h1",{className:"text-2xl font-semibold",children:["Привет, ",r,"!"]}),c&&e.jsxs("p",{className:"text-gray-600 dark:text-gray-400",children:["@",c]})]})]})}),e.jsx("section",{className:"mb-8 animate-slide-up",children:e.jsx(pr,{banners:d})}),e.jsxs("section",{className:"mb-8",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsx(M,{to:"/shop",className:"bg-cover bg-center rounded-lg p-4 h-full col-span-1 shadow-sm hover-lift flex flex-col justify-end",style:{backgroundImage:`url(${at})`},children:e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("h3",{className:"text-xl font-medium text-white",children:"Заказать"}),e.jsx(Q,{size:20,className:"text-white"})]})}),e.jsxs("div",{className:"col-span-1 space-y-4",children:[e.jsxs(M,{to:"/profile",className:"bg-telegram-blue text-white dark:bg-telegram-blue rounded-lg p-4 shadow-sm hover:shadow-md transition-all duration-300 transform hover:-translate-y-1 flex flex-col justify-between",children:[e.jsx("h3",{className:"font-medium text-white",children:"$DD COINS:"}),e.jsx("div",{className:"text-4xl font-bold mb-1 text-white",children:n?e.jsx("div",{className:"flex items-center justify-center h-10",children:e.jsx(se,{size:"md",className:"text-white"})}):m||0}),e.jsx("p",{className:"text-xs text-white/80",children:"Баланс и реферальная программа"}),e.jsx("div",{className:"flex justify-end mt-1",children:e.jsx(Q,{size:20,className:"text-white"})})]}),e.jsx(fr,{})]})]}),e.jsxs(M,{to:"/calculator",className:"w-full rounded-lg overflow-hidden relative hover-lift h-16 block mt-4",style:{backgroundImage:`url(${ot})`,backgroundSize:"cover",backgroundPosition:"center"},children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-t from-black/70 to-transparent"}),e.jsxs("div",{className:"absolute inset-0 flex items-center p-4",children:[e.jsx("h3",{className:"font-medium text-white text-lg flex-1 text-center",children:"Рассчитать доставку"}),e.jsx(Q,{className:"text-white",size:20})]})]})]}),e.jsxs("section",{className:"mb-8",children:[e.jsx("h2",{className:"text-xl font-medium mb-4",children:"Что купить?"}),e.jsxs("div",{className:"grid grid-cols-2 gap-4 mb-4",children:[e.jsxs(M,{to:"/shop?category=sneakers",className:"rounded-lg overflow-hidden relative hover-lift aspect-[5/3]",style:{backgroundImage:`url(${nt})`,backgroundSize:"cover",backgroundPosition:"center"},children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-t from-black/70 to-transparent"}),e.jsxs("div",{className:"absolute bottom-0 w-full p-4 flex justify-between items-center",children:[e.jsx("h3",{className:"font-medium text-white",children:"Кроссовки"}),e.jsx(Q,{className:"text-white",size:20})]})]}),e.jsxs(M,{to:"/shop?category=tops",className:"rounded-lg overflow-hidden relative hover-lift aspect-[5/3]",style:{backgroundImage:`url(${lt})`,backgroundSize:"cover",backgroundPosition:"center"},children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-t from-black/70 to-transparent"}),e.jsxs("div",{className:"absolute bottom-0 w-full p-4 flex justify-between items-center",children:[e.jsx("h3",{className:"font-medium text-white",children:"Верх"}),e.jsx(Q,{className:"text-white",size:20})]})]}),e.jsxs(M,{to:"/shop?category=bottoms",className:"rounded-lg overflow-hidden relative hover-lift aspect-[5/3]",style:{backgroundImage:`url(${it})`,backgroundSize:"cover",backgroundPosition:"center"},children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-t from-black/70 to-transparent"}),e.jsxs("div",{className:"absolute bottom-0 w-full p-4 flex justify-between items-center",children:[e.jsx("h3",{className:"font-medium text-white",children:"Низ"}),e.jsx(Q,{className:"text-white",size:20})]})]}),e.jsxs(M,{to:"/shop?category=accessories",className:"rounded-lg overflow-hidden relative hover-lift aspect-[5/3]",style:{backgroundImage:`url(${ct})`,backgroundSize:"cover",backgroundPosition:"center"},children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-t from-black/70 to-transparent"}),e.jsxs("div",{className:"absolute bottom-0 w-full p-4 flex justify-between items-center",children:[e.jsx("h3",{className:"font-medium text-white",children:"Аксессуары"}),e.jsx(Q,{className:"text-white",size:20})]})]})]})]})]})},ut=t=>{const r=u=>/^[\d.,]+$/.test(u),s=u=>{const n={XXXS:1,XXS:2,XS:3,S:4,M:5,L:6,XL:7,XXL:8,XXXL:9,"3XS":1,"2XS":2,"3XL":9},l=u.toUpperCase().trim();return n[l]||999},a=t.filter(r),o=t.filter(u=>!r(u)),i=a.sort((u,n)=>parseFloat(u)-parseFloat(n)),m=o.sort((u,n)=>s(u)-s(n));return[...i,...m]},mt=()=>{const[t,r]=He();Z();const[s,a]=g.useState(""),[o,i]=g.useState([]),[m,u]=g.useState([]),[n,l]=g.useState([]),[p,d]=g.useState(!1),{itemCount:c}=ge(),{data:x,isLoading:j,error:h,isError:k,refetch:_}=le({queryKey:["products"],queryFn:ke,staleTime:5*60*1e3,retry:1,retryDelay:1e3});le({queryKey:["categories"],queryFn:ze,staleTime:5*60*1e3,retry:1,retryDelay:1e3}),g.useEffect(()=>{const f=t.get("brand"),w=t.get("category"),v=t.get("size"),I=t.get("search");f&&u(f.split(",")),w&&l(w.split(",")),v&&i(v.split(",")),I&&a(I)},[t]),g.useEffect(()=>{const f=new URLSearchParams;m.length>0&&f.set("brand",m.join(",")),n.length>0&&f.set("category",n.join(",")),o.length>0&&f.set("size",o.join(",")),s&&f.set("search",s),f.toString()!==t.toString()&&r(f)},[m,n,o,s,r,t]),g.useEffect(()=>{k&&h instanceof Error&&y.error(`Shop error: ${h.message}`)},[k,h]);const b=g.useMemo(()=>{if(!x)return[];const f=new Set;return x.forEach(w=>{Array.isArray(w.sizes)&&w.sizes.forEach(v=>{v.quantity>0&&f.add(v.size)})}),Array.from(f).sort()},[x]),N=g.useMemo(()=>{if(!x)return[];const f=new Set;return x.forEach(w=>{w.brand&&f.add(w.brand)}),Array.from(f).sort()},[x]),E=g.useMemo(()=>{if(!x)return[];const f=new Set;return x.forEach(w=>{w.category&&f.add(w.category)}),Array.from(f).sort()},[x]),P=f=>{i(w=>w.includes(f)?w.filter(v=>v!==f):[...w,f])},C=f=>{u(w=>w.includes(f)?w.filter(v=>v!==f):[...w,f])},D=f=>{l(w=>w.includes(f)?w.filter(v=>v!==f):[...w,f])},B=g.useMemo(()=>x?x.filter(f=>{const w=s===""||f.item_name.toLowerCase().includes(s.toLowerCase())||f.color_code.toLowerCase().includes(s.toLowerCase())||f.brand&&f.brand.toLowerCase().includes(s.toLowerCase()),v=o.length===0||Array.isArray(f.sizes)&&f.sizes.some(S=>o.includes(S.size)&&S.quantity>0),I=m.length===0||f.brand&&m.includes(f.brand),T=n.length===0||f.category&&n.includes(f.category);return w&&v&&I&&T}):[],[x,s,o,m,n]),U=()=>{i([]),u([]),l([]),a("")},F=f=>{i(w=>w.filter(v=>v!==f))},$=f=>{u(w=>w.filter(v=>v!==f))},K=f=>{l(w=>w.filter(v=>v!==f))},Y=o.length>0||m.length>0||n.length>0||s.length>0;return e.jsx(J,{children:e.jsxs("div",{className:"p-4",children:[e.jsxs("header",{className:"mb-6",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h1",{className:"text-2xl font-semibold",children:"Shop"}),e.jsxs(M,{to:"/cart",className:"relative flex items-center justify-center w-10 h-10 bg-telegram-button text-white rounded-full hover:bg-telegram-button/90 transition-colors","aria-label":"View Cart",children:[e.jsx(ie,{size:20,className:"text-white"}),c>0&&e.jsx("span",{className:"absolute -top-1 -right-1 bg-red-500 text-white text-xs font-bold w-5 h-5 flex items-center justify-center rounded-full",children:c})]})]}),e.jsxs("div",{className:"relative mb-4",children:[e.jsx("div",{className:"absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none",children:e.jsx(Se,{size:20,className:"text-telegram-hint"})}),e.jsx("input",{type:"text",placeholder:"Search products...",className:"w-full p-3 pl-10 pr-4 border border-telegram-hint/30 rounded-lg bg-telegram-bg text-telegram-text focus:outline-none focus:ring-2 focus:ring-telegram-button focus:border-transparent",value:s,onChange:f=>a(f.target.value)})]}),e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("button",{className:"flex items-center gap-2 text-sm text-telegram-text",onClick:()=>d(!p),children:[e.jsx(Ke,{size:18,className:"text-telegram-hint"}),e.jsx("span",{children:p?"Hide filters":"Show filters"})]}),Y&&e.jsxs("button",{className:"flex items-center gap-1 text-xs text-red-500",onClick:U,children:[e.jsx(re,{size:14}),e.jsx("span",{children:"Clear filters"})]})]}),Y&&e.jsxs("div",{className:"flex flex-wrap gap-2 mb-4",children:[o.map(f=>e.jsxs("span",{className:"inline-flex items-center gap-1 px-2 py-1 bg-telegram-light text-telegram-blue text-xs rounded-full",children:[e.jsx(fe,{size:12}),"Size: ",f,e.jsx("button",{className:"ml-1",onClick:()=>F(f),children:e.jsx(re,{size:12})})]},`filter-size-${f}`)),m.map(f=>e.jsxs("span",{className:"inline-flex items-center gap-1 px-2 py-1 bg-telegram-light text-telegram-blue text-xs rounded-full",children:[e.jsx(fe,{size:12}),"Brand: ",f,e.jsx("button",{className:"ml-1",onClick:()=>$(f),children:e.jsx(re,{size:12})})]},`filter-brand-${f}`)),n.map(f=>e.jsxs("span",{className:"inline-flex items-center gap-1 px-2 py-1 bg-telegram-light text-telegram-blue text-xs rounded-full",children:[e.jsx(fe,{size:12}),"Category: ",f,e.jsx("button",{className:"ml-1",onClick:()=>K(f),children:e.jsx(re,{size:12})})]},`filter-category-${f}`)),s&&e.jsxs("span",{className:"inline-flex items-center gap-1 px-2 py-1 bg-telegram-light text-telegram-blue text-xs rounded-full",children:[e.jsx(Se,{size:12}),'"',s,'"',e.jsx("button",{className:"ml-1",onClick:()=>a(""),children:e.jsx(re,{size:12})})]})]}),p&&e.jsxs("div",{className:"mb-4 p-4 bg-telegram-secondary-bg rounded-lg animate-slide-down space-y-4",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-sm font-medium mb-2 text-telegram-text",children:"Filter by Size (Select Multiple)"}),e.jsx("div",{className:"flex flex-wrap gap-2",children:b.map(f=>e.jsx("button",{className:`px-3 py-1 text-sm rounded-full border transition-colors ${o.includes(f)?"bg-telegram-button text-telegram-button-text border-telegram-button":"bg-telegram-bg text-telegram-text border-telegram-hint/30 hover:border-telegram-hint/50"}`,onClick:()=>P(f),children:f},f))})]}),N.length>0&&e.jsxs("div",{children:[e.jsx("h3",{className:"text-sm font-medium mb-2 text-telegram-text",children:"Filter by Brand (Select Multiple)"}),e.jsx("div",{className:"flex flex-wrap gap-2",children:N.map(f=>e.jsx("button",{className:`px-3 py-1 text-sm rounded-full border transition-colors ${m.includes(f)?"bg-telegram-button text-telegram-button-text border-telegram-button":"bg-telegram-bg text-telegram-text border-telegram-hint/30 hover:border-telegram-hint/50"}`,onClick:()=>C(f),children:f},f))})]}),E.length>0&&e.jsxs("div",{children:[e.jsx("h3",{className:"text-sm font-medium mb-2 text-telegram-text",children:"Filter by Category (Select Multiple)"}),e.jsx("div",{className:"flex flex-wrap gap-2",children:E.map(f=>e.jsx("button",{className:`px-3 py-1 text-sm rounded-full border transition-colors ${n.includes(f)?"bg-telegram-button text-telegram-button-text border-telegram-button":"bg-telegram-bg text-telegram-text border-telegram-hint/30 hover:border-telegram-hint/50"}`,onClick:()=>D(f),children:f},f))})]})]})]}),k&&e.jsxs("div",{className:"p-3 bg-red-50 border border-red-300 rounded-lg mb-4",children:[e.jsx("h3",{className:"text-sm font-medium text-red-700",children:"Error Loading Products:"}),e.jsx("p",{className:"text-xs text-red-600",children:h instanceof Error?h.message:"Unknown error"})]}),j?e.jsx("div",{className:"flex justify-center items-center h-64",children:e.jsx(se,{size:"lg"})}):k?e.jsxs("div",{className:"text-center py-10",children:[e.jsx("h2",{className:"text-lg font-medium text-red-600 mb-2",children:"Error loading products"}),e.jsx("p",{className:"text-gray-600 mb-4",children:"Please try again later"}),e.jsx("button",{className:"px-4 py-2 bg-telegram-blue text-white rounded-lg",onClick:()=>_(),children:"Retry"})]}):B.length===0?e.jsxs("div",{className:"text-center py-10",children:[e.jsx("h2",{className:"text-lg font-medium text-gray-700",children:"No products found"}),e.jsx("p",{className:"text-gray-500 mt-2",children:"Try changing your filters or search term"}),Y&&e.jsx("button",{className:"mt-4 px-4 py-2 bg-telegram-blue text-white rounded-lg",onClick:U,children:"Clear all filters"})]}):e.jsx("div",{className:"grid grid-cols-2 gap-4",children:B.map(f=>e.jsx(hr,{product:f,className:"animate-fade-in"},f.sku))})]})})},gt=()=>{const{productId:t}=Ge(),r=Z(),{addToCart:s,updateQuantity:a,getItemQuantity:o}=ge(),[i,m]=g.useState(""),{data:u,isLoading:n,error:l,isError:p,refetch:d}=le({queryKey:["products"],queryFn:ke,staleTime:5*60*1e3,retry:1,retryDelay:1e3}),c=u==null?void 0:u.find(C=>C.sku===t),x=g.useMemo(()=>{if(!c)return[];if(Array.isArray(c.sizes)){const C=c.sizes.filter(D=>D.quantity>0).map(D=>D.size);return ut(C)}return[]},[c]);g.useEffect(()=>{x.length>0&&!i&&m(x[0])},[x,i]);const j=c?Cr(`${c.item_name}-${c.color_code}`,"product"):"📦",h=g.useMemo(()=>!c||!i?0:o(c.sku,i),[c,i,o]),k=g.useMemo(()=>!c||!c.photos?[]:Array.isArray(c.photos)?c.photos.map(C=>typeof C=="string"?C:C.photo_url||"").filter(C=>C):[],[c]),_=g.useMemo(()=>{if(!c||!i)return 0;const C=c.sizes.find(D=>D.size===i);return C?C.quantity:0},[c,i]),b=()=>{if(!c||!i)return;if(h>=_){y.error(`Извините, доступно только ${_} шт. размера ${i}`);return}V();const C=typeof c.price_rub=="string"?parseFloat(c.price_rub.replace(/[^\d.-]/g,"")):c.price_rub,D={id:c.sku,name:c.item_name,color:c.color_code,sizes:x,price:C,quantity:1};s(D,i),Fr(c.sku,i)},N=()=>{if(!(!c||!i)){if(h>=_){y.error(`Извините, доступно только ${_} шт. размера ${i}`);return}V(),a(c.sku,i,h+1)}},E=()=>{!c||!i||h<=0||(V(),a(c.sku,i,h-1))},P=()=>{V(),r("/cart")};return n?e.jsx(J,{children:e.jsx("div",{className:"flex justify-center items-center h-screen",children:e.jsx(se,{size:"lg"})})}):p||!c?e.jsx(J,{children:e.jsxs("div",{className:"p-4 text-center",children:[e.jsx("h2",{className:"text-lg font-medium text-red-600 mb-2",children:p?"Ошибка загрузки товара":"Товар не найден"}),e.jsx("p",{className:"text-gray-600 dark:text-gray-400 mb-4",children:p?"Пожалуйста, попробуйте позже":"Этот товар может быть больше не доступен"}),e.jsxs("div",{className:"flex justify-center gap-4",children:[p&&e.jsx("button",{className:"px-4 py-2 bg-telegram-blue text-white rounded-lg",onClick:()=>d(),children:"Повторить"}),e.jsx("button",{className:"px-4 py-2 bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 rounded-lg",onClick:()=>r("/shop"),children:"В магазин"})]})]})}):e.jsx(J,{children:e.jsxs("div",{className:"flex flex-col min-h-screen",children:[e.jsx(xr,{photos:k,productName:c.item_name,fallbackEmoji:j}),e.jsxs("div",{className:"p-4 flex-1",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h1",{className:"text-xl font-bold",children:c.item_name}),e.jsxs(M,{to:"/cart",className:"relative flex items-center justify-center w-10 h-10 bg-telegram-button text-white rounded-full hover:bg-telegram-button/90 transition-colors","aria-label":"View Cart",children:[e.jsx(ie,{size:20,className:"text-white"}),x.reduce((C,D)=>C+o(c.sku,D),0)>0&&e.jsx("span",{className:"absolute -top-1 -right-1 bg-red-500 text-white text-xs font-bold w-5 h-5 flex items-center justify-center rounded-full",children:x.reduce((C,D)=>C+o(c.sku,D),0)})]})]}),e.jsxs("div",{className:"mb-6",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[c.brand&&e.jsx("span",{className:"px-2 py-1 bg-gray-100 dark:bg-gray-800 text-gray-800 dark:text-gray-200 text-xs rounded-full",children:c.brand}),e.jsx("span",{className:"px-2 py-1 bg-telegram-light dark:bg-telegram-dark/20 text-telegram-blue dark:text-telegram-blue text-xs rounded-full",children:c.color_code})]}),e.jsxs("p",{className:"text-lg font-semibold text-telegram-blue",children:["₽",typeof c.price_rub=="string"?parseFloat(c.price_rub.replace(/[^\d.-]/g,"")).toLocaleString():c.price_rub.toLocaleString()]})]}),e.jsxs("div",{className:"mb-6",children:[e.jsx("h2",{className:"font-medium mb-2",children:"Выберите размер"}),e.jsx(br,{availableSizes:x,selectedSize:i,onChange:m})]}),e.jsx("div",{className:"mb-6",children:c.description&&e.jsxs(e.Fragment,{children:[e.jsx("h2",{className:"font-medium mb-2",children:"Описание"}),e.jsx("p",{className:"text-gray-700 dark:text-gray-300 text-sm",children:c.description})]})}),e.jsxs("div",{className:"sticky bottom-0 pt-4 pb-2 bg-white dark:bg-sidebar-primary",children:[i&&e.jsxs("div",{className:"mb-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("span",{className:"font-medium",children:["Размер: ",i]}),o(c.sku,i)>0&&e.jsxs("span",{className:"text-sm text-gray-500",children:["В корзине: ",o(c.sku,i)," шт."]})]}),o(c.sku,i)===0?e.jsxs("button",{onClick:b,disabled:!i||x.length===0,className:"w-full py-3 px-4 bg-telegram-blue text-white rounded-lg flex items-center justify-center gap-2 hover:bg-telegram-dark transition-colors disabled:opacity-50 disabled:cursor-not-allowed",children:[e.jsx(Pe,{size:20}),e.jsx("span",{children:"Добавить в корзину"})]}):e.jsxs("div",{className:"flex items-center justify-between border border-gray-200 dark:border-gray-700 rounded-lg p-1",children:[e.jsx("button",{onClick:E,className:"w-10 h-10 flex items-center justify-center text-telegram-text bg-gray-100 dark:bg-gray-800 rounded-md",children:e.jsx(Xe,{size:18})}),e.jsx("span",{className:"font-medium",children:o(c.sku,i)}),e.jsx("button",{onClick:N,className:"w-10 h-10 flex items-center justify-center text-telegram-text bg-gray-100 dark:bg-gray-800 rounded-md",children:e.jsx(Ye,{size:18})})]})]}),e.jsxs("button",{onClick:P,className:"w-full py-3 px-4 bg-telegram-blue text-white rounded-lg flex items-center justify-center gap-2 hover:bg-telegram-dark transition-colors",children:[e.jsx(ie,{size:20}),e.jsx("span",{children:"Перейти в корзину"})]})]})]})]})})},We=g.createContext(null),pt=({children:t})=>{var u,n,l;const r=typeof window<"u"?(u=window.Telegram)==null?void 0:u.WebApp:void 0,m={tg:r,onClose:()=>{r&&r.close()},onToggleButton:()=>{var p;(p=r==null?void 0:r.MainButton)!=null&&p.isVisible?r.MainButton.hide():r!=null&&r.MainButton&&r.MainButton.show()},initWebApp:()=>{console.log("Initializing Telegram WebApp with direct access..."),r?(r.ready(),console.log("Telegram WebApp initialized successfully")):console.error("Telegram WebApp is not available")},getUserData:()=>{var p;if((p=r==null?void 0:r.initDataUnsafe)!=null&&p.user){console.log("User data found in initDataUnsafe:",r.initDataUnsafe.user);try{localStorage.setItem("telegramUser",JSON.stringify(r.initDataUnsafe.user))}catch(d){console.error("Error storing user data in localStorage:",d)}return r.initDataUnsafe.user}console.log("No user data found in initDataUnsafe");try{const d=localStorage.getItem("telegramUser");if(d){const c=JSON.parse(d);return console.log("Using stored user data from localStorage:",c),c}}catch(d){console.error("Error retrieving user data from localStorage:",d)}return null},user:(n=r==null?void 0:r.initDataUnsafe)==null?void 0:n.user,queryId:(l=r==null?void 0:r.initDataUnsafe)==null?void 0:l.query_id};return e.jsx(We.Provider,{value:m,children:t})},ft=()=>{const t=g.useContext(We);if(!t)throw new Error("useTelegram must be used within a TelegramProvider");return t},ht=()=>{const{username:t,displayName:r,telegramUser:s,profile:a,avatarEmoji:o,updateTelegramUser:i}=me(),[m,u]=g.useState(!0),[n,l]=g.useState(0),[p,d]=g.useState(!1),[c,x]=g.useState(!1),j=Z(),{tg:h,initWebApp:k,getUserData:_}=ft();g.useEffect(()=>{(async()=>{if(z()){d(!0);try{const $=await ae();console.log("Profile page - DD coins direct API call:",$),l($)}catch($){console.error("Error fetching DD coins balance:",$)}finally{d(!1)}}})()},[]);const b=async()=>{if(s){d(!0);try{const U=await ae();console.log("Profile page: DD coins balance received:",U),l(U)}catch(U){console.error("Error fetching DD coins balance:",U)}finally{d(!1)}}};g.useEffect(()=>{(async()=>{try{console.log("Initializing Telegram WebApp on Profile page..."),k();const F=_();if(F){console.log("Telegram user found on Profile page:",F),i(F);const $=await ce();u(typeof $=="boolean"?$:$.exists||!1),await b()}else console.log("No Telegram user data found on Profile page"),setTimeout(async()=>{const $=_();if($){console.log("Telegram user found after delay:",$),i($);const K=await ce();u(typeof K=="boolean"?K:K.exists||!1),await b()}else console.log("Still no Telegram user data after retry")},500)}catch(F){console.error("Error initializing Telegram on Profile page:",F)}})()},[i,k,_,h]);const{data:N,isLoading:E,error:P,isError:C,refetch:D}=le({queryKey:["orders"],queryFn:Oe,staleTime:60*1e3,retry:1,retryDelay:1e3,enabled:m});if(E)return e.jsx(J,{children:e.jsx("div",{className:"flex justify-center items-center h-64",children:e.jsx(se,{size:"lg"})})});if(C&&P instanceof Error&&!P.message.includes("not found"))return e.jsx(J,{children:e.jsxs("div",{className:"p-4 text-center",children:[e.jsx("h2",{className:"text-lg font-medium text-red-600 dark:text-red-400 mb-2",children:"Error loading profile"}),e.jsx("p",{className:"text-gray-600 dark:text-gray-400 mb-4",children:P instanceof Error?P.message:"Please try again later"}),e.jsx("button",{className:"px-4 py-2 bg-telegram-blue text-white rounded-lg",onClick:()=>D(),children:"Retry"})]})});const B=N||[];return e.jsx(J,{className:"pb-32",children:e.jsxs("div",{className:"p-4 relative",children:[e.jsxs("div",{className:"flex items-center justify-between mb-8 animate-fade-in",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx(Ue,{user:s,emoji:o,size:"lg",className:"hover-lift"}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-semibold",children:s!=null&&s.username?`@${s.username}`:r}),s&&e.jsxs("p",{className:"text-gray-600 dark:text-gray-400",children:[s.first_name," ",s.last_name||""]})]})]}),e.jsx("button",{onClick:()=>j("/settings"),className:"w-10 h-10 flex items-center justify-center rounded-full bg-telegram-light dark:bg-sidebar-accent hover:bg-telegram-secondary-bg dark:hover:bg-sidebar-primary transition-colors","aria-label":"Settings",children:e.jsx(Qe,{size:20,className:"text-telegram-blue"})})]}),e.jsx("div",{className:"mb-8 bg-telegram-blue dark:bg-telegram-blue rounded-lg p-5 shadow-sm animate-slide-up text-white",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(Ae,{size:28,className:"text-yellow-400"}),e.jsxs("div",{className:"flex items-baseline gap-3",children:[e.jsx("h2",{className:"text-xl font-semibold text-white",children:"$DD Баланс:"}),p?e.jsx(se,{size:"sm",className:"text-white ml-2"}):e.jsx("span",{className:"text-3xl font-bold text-white",children:n||0})]})]}),e.jsx("button",{onClick:()=>x(!0),className:"text-white hover:bg-white/20 rounded-full p-2 transition-colors","aria-label":"DD Coins Information",children:e.jsx(Ve,{size:22})})]})}),e.jsxs("div",{className:"grid grid-cols-3 gap-4 mb-8 animate-slide-up",children:[e.jsxs("div",{className:"bg-white dark:bg-sidebar-accent rounded-lg p-4 text-center shadow-sm",children:[e.jsx("h2",{className:"text-xl font-semibold text-telegram-blue",children:B.length}),e.jsx("p",{className:"text-gray-600 dark:text-gray-400 text-sm",children:"Orders"})]}),e.jsxs("div",{className:"bg-white dark:bg-sidebar-accent rounded-lg p-4 text-center shadow-sm",children:[e.jsx("h2",{className:"text-xl font-semibold text-telegram-blue",children:B.filter(U=>U.status==="delivered").length}),e.jsx("p",{className:"text-gray-600 dark:text-gray-400 text-sm",children:"Completed"})]}),e.jsxs("div",{className:"bg-white dark:bg-sidebar-accent rounded-lg p-4 text-center shadow-sm",children:[e.jsx("h2",{className:"text-xl font-semibold text-telegram-blue",children:B.filter(U=>U.status!=="delivered").length}),e.jsx("p",{className:"text-gray-600 dark:text-gray-400 text-sm",children:"Pending"})]})]}),e.jsxs("div",{className:"mb-8",children:[e.jsx("h2",{className:"text-xl font-medium mb-4",children:"Invite Friends"}),e.jsxs("div",{className:"bg-white dark:bg-sidebar-accent rounded-lg shadow-sm overflow-hidden",children:[e.jsx("div",{className:"p-4 border-b border-gray-100 dark:border-gray-800/50",children:e.jsx("p",{className:"text-sm text-gray-600 dark:text-gray-400",children:"Share your referral link with friends and earn rewards when they join and make purchases!"})}),e.jsx(yr,{className:"animate-fade-in"})]})]}),e.jsxs("div",{className:"mb-8",children:[e.jsx("h2",{className:"text-xl font-medium mb-4",children:"Order History"}),N&&N.length>0?e.jsx("div",{className:"space-y-4",children:N.map(U=>e.jsx(wr,{order:U},U.order_id))}):e.jsxs("div",{className:"p-6 text-center bg-telegram-secondary-bg rounded-lg",children:[e.jsx("h3",{className:"font-medium text-lg mb-2",children:"No Orders Yet"}),e.jsx("p",{className:"text-gray-600 dark:text-gray-400 mb-4",children:"You haven't placed any orders yet. Start shopping to see your orders here."}),e.jsx("button",{onClick:()=>j("/shop"),className:"px-4 py-2 bg-telegram-blue text-white rounded-lg",children:"Browse Products"})]})]}),e.jsx("div",{className:"h-16"}),e.jsx(vr,{isOpen:c,onClose:()=>x(!1)})]})})},zt=async t=>{try{const r=z();if(!r)throw new Error("No Telegram user data available");const{options:s,clearTimeout:a}=W("POST",{telegram_id:r.id,promocode_text:t}),o=await fetch(`${q}/promocodes/validate`,s);if(a(),!o.ok){const m=await o.text();throw new Error(m||"Failed to validate promocode")}return await o.json()}catch(r){throw console.error("Error validating promocode:",r),r}},Ot=(t,r)=>{let s=t;if(r.discount_fixed>0&&(s=Math.max(0,s-r.discount_fixed)),r.discount_percent&&r.discount_percent!=="null"){const a=s*parseFloat(r.discount_percent)/100;s=Math.max(0,s-a)}return Math.round(s)},xt=()=>{const{items:t,removeFromCart:r,clearCart:s}=ge(),[a,o]=g.useState(!1),[i,m]=g.useState(!1),[u,n]=g.useState(!1),[l,p]=g.useState(),[d,c]=g.useState(0),[x,j]=g.useState(0),[h,k]=g.useState(0),[_,b]=g.useState(!1),[N,E]=g.useState(null),[P,C]=g.useState(null);g.useEffect(()=>{(async()=>{if(z()){b(!0);try{const I=await ae();j(I)}catch(I){console.error("Error fetching DD coins balance:",I)}finally{b(!1)}}})()},[]),g.useEffect(()=>{const w=t.reduce((v,I)=>v+(I.sale_price||I.price)*I.quantity,0);if(l){let v=w;if(l.discount_fixed&&(v=Math.max(0,v-l.discount_fixed)),l.discount_percent&&l.discount_percent!=="null"){const I=v*parseFloat(l.discount_percent)/100;v=Math.max(0,v-I)}N&&(v+=N.price_rub),c(Math.round(v))}else{let v=w;N&&(v+=N.price_rub),c(v)}k(0)},[t,l,N]);const D=Math.min(x,Math.floor(d*.5)),B=d-h,U=w=>{const v=parseInt(w.target.value);k(v)},F=(w,v)=>{p(w),c(Math.round(v))},$=()=>{p(void 0),c(t.reduce((w,v)=>w+(v.sale_price||v.price)*v.quantity,0))},K=async()=>{try{if(o(!0),t.length===0){y.error("Ваша корзина пуста!"),o(!1);return}if(!z()){y.error("Пожалуйста, войдите, чтобы создать заказ"),o(!1);return}try{const v=await we();C(v?{email:v.email||"",phone_number:v.phone_number||"",address:v.address||""}:null),n(!0),o(!1)}catch(v){console.error("Error getting client information:",v),y.error("Ошибка загрузки данных. Пожалуйста, попробуйте позже."),o(!1)}}catch(w){console.error("Error in order creation process:",w),y.error(`Error: ${w.message}`),o(!1)}},Y=w=>{n(!1),w?E(w):alert("No delivery rate provided"),f(w)},f=async w=>{try{o(!0);const v=z();if(!v){y.error("Пожалуйста, войдите, чтобы создать заказ");return}const I=await we(),T=t.map(A=>{if(A.item_type==="preorder"){let pe=A.category_type;return pe==="shoes"&&(pe="sneakers"),{item_type:"preorder",dewu_url:A.dewu_url,size:A.size,category_type:pe,shipping_type:A.shipping_type||(A.delivery_type==="cargo"?"cargo":"aero"),price_cny:A.price_cny||Math.round(A.price/12),quantity:A.quantity}}else return{item_type:"stock",stock_id:parseInt(A.productId)||void 0,sku:parseInt(A.productId)?void 0:A.productId,size:A.size,quantity:A.quantity}}),S={telegram_user_id:v.id,delivery_method:(w==null?void 0:w.delivery_type)||"self_pickup",delivery_address:(I==null?void 0:I.address)||"",promocode_text:l==null?void 0:l.promocode_text,dd_coins_amount:h,items:T,final_price:B};console.log("Creating unified order with data:",JSON.stringify(S));const O=await Jr(S);O.success?(s(),y.success("Заказ создан успешно")):y.error(O.message||"Не удалось создать заказ. Пожалуйста, попробуйте позже.")}catch(v){console.error("Error creating order:",v),y.error("Ошибка при создании заказа. Пожалуйста, попробуйте позже."),o(!1)}};return e.jsxs(J,{children:[e.jsxs("div",{className:"max-w-4xl mx-auto px-4 py-6",children:[e.jsx("h1",{className:"text-2xl font-bold mb-6",children:"Корзина"}),t.length===0?e.jsxs("div",{className:"text-center py-12",children:[e.jsx(ie,{className:"mx-auto h-12 w-12 text-gray-400"}),e.jsx("h3",{className:"mt-4 text-lg font-medium text-gray-900 dark:text-gray-100",children:"Ваша корзина пуста"}),e.jsx("p",{className:"mt-2 text-sm text-gray-500 dark:text-gray-400",children:"Добавьте товары в корзину, чтобы продолжить покупки"}),e.jsxs(M,{to:"/shop",className:"mt-6 inline-flex items-center text-sm font-medium text-telegram-blue hover:text-telegram-dark",children:[e.jsx(Ze,{className:"mr-2 h-4 w-4"}),"Продолжить покупки"]})]}):e.jsxs("div",{children:[e.jsx("div",{className:"space-y-4",children:t.map(w=>e.jsx(jr,{item:w,onRemove:()=>r(w.productId,w.size)},`${w.productId}-${w.size}`))}),e.jsxs("div",{className:"bg-white dark:bg-sidebar-accent rounded-lg p-4 shadow-sm mb-6 mt-6",children:[e.jsx("h3",{className:"text-sm font-medium mb-2",children:"У вас есть промокод?"}),e.jsx(Nr,{originalPrice:t.reduce((w,v)=>w+(v.sale_price||v.price)*v.quantity,0),onPromocodeApplied:F,onPromocodeRemoved:$,currentPromocode:l})]}),e.jsxs("div",{className:"bg-white dark:bg-sidebar-accent rounded-lg p-4 shadow-sm",children:[e.jsx("h3",{className:"text-lg font-medium mb-4",children:"Информация о заказе"}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-600 dark:text-gray-400",children:"Сумма товаров"}),e.jsxs("span",{children:["₽",t.reduce((w,v)=>w+(v.sale_price||v.price)*v.quantity,0)]})]}),N&&e.jsxs("div",{className:"flex justify-between",children:[e.jsxs("span",{className:"text-gray-600 dark:text-gray-400",children:["Доставка (",N.delivery_type==="self_pickup"?"Самовывоз":N.delivery_type==="courier"?"Курьер":"Почта",")"]}),e.jsx("span",{children:N.price_rub>0?`₽${N.price_rub.toLocaleString()}`:"Бесплатно"})]}),l&&e.jsxs("div",{className:"flex justify-between text-telegram-blue",children:[e.jsx("span",{children:"Скидка по промокоду"}),e.jsx("span",{children:l.discount_fixed?`-₽${l.discount_fixed}`:l.discount_percent&&l.discount_percent!=="null"?`-${l.discount_percent}%`:""})]}),x>0&&d>0&&e.jsxs("div",{className:"pt-3 border-t border-gray-200 dark:border-gray-700",children:[e.jsxs("div",{className:"flex justify-between items-center mb-2",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(Ae,{size:16,className:"text-yellow-500"}),e.jsx("span",{className:"font-medium",children:"DD Коины"})]}),e.jsxs("span",{className:"text-sm text-gray-600 dark:text-gray-400",children:["Баланс: ",x]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{children:"Использовать DD Коины для оплаты"}),e.jsxs("span",{className:"text-telegram-blue",children:[h," коинов (-₽",h,")"]})]}),e.jsx("input",{type:"range",min:"0",max:D,value:h,onChange:U,className:"w-full",disabled:D<=0}),e.jsxs("div",{className:"flex justify-between text-xs text-gray-500",children:[e.jsx("span",{children:"0"}),e.jsxs("span",{children:["Макс: ",D," коинов (50% от суммы)"]})]})]})]}),e.jsxs("div",{className:"flex justify-between font-medium pt-2 border-t border-gray-200 dark:border-gray-700",children:[e.jsx("span",{children:"Итого"}),e.jsxs("span",{children:["₽",B]})]})]}),e.jsx("button",{onClick:K,disabled:a||i,className:"w-full mt-4 bg-telegram-blue text-white py-3 rounded-lg font-medium hover:bg-telegram-dark transition-colors disabled:opacity-50 disabled:cursor-not-allowed",children:a||i?e.jsxs(e.Fragment,{children:[e.jsx(te,{className:"inline-block mr-2 h-4 w-4 animate-spin"}),i?"Проверка данных...":"Создание заказа..."]}):"Оформить заказ"})]})]})]}),u&&e.jsx(kr,{onComplete:Y,onCancel:()=>n(!1),clientInfo:P})]})},bt=()=>{const t=Z();return e.jsx(J,{fullHeight:!0,children:e.jsxs("div",{className:"min-h-screen flex flex-col items-center justify-center p-4 text-center",children:[e.jsx("div",{className:"text-8xl mb-4 animate-float",children:"🔍"}),e.jsx("h1",{className:"text-4xl font-bold mb-4",children:"404"}),e.jsx("p",{className:"text-xl text-gray-600 mb-6",children:"Oops! We couldn't find that page"}),e.jsx("button",{onClick:()=>t("/"),className:"px-6 py-3 bg-telegram-blue text-white rounded-lg hover:bg-telegram-dark transition-colors",children:"Return to Home"})]})})},yt=t=>t.split(" ").map(r=>r.charAt(0).toUpperCase()+r.slice(1).toLowerCase()).join(" "),wt=()=>{const{addPreorderToCart:t}=ge(),[r,s]=g.useState(""),[a,o]=g.useState(""),[i,m]=g.useState("car"),[u,n]=g.useState(""),[l,p]=g.useState(""),[d,c]=g.useState(!1),[x,j]=g.useState(!1),[h,k]=g.useState([]),[_,b]=g.useState(!1),[N,E]=g.useState(""),[P,C]=g.useState(""),[D,B]=g.useState(null);g.useEffect(()=>{(async()=>{b(!0);try{const S=await ze();k(S);const O=S.find(A=>A.name.toLowerCase()==="обувь");O?o(O.name):S.length>0&&o(S[0].name)}catch(S){console.error("Failed to load categories:",S),y.error("Failed to load item categories")}finally{b(!1)}})()},[]);const U=async()=>{if(!r||N){y.error("Введите корректную цену для расчёта");return}if(!a){y.error("Выберите категорию товара");return}const T=F(a);if(!T){y.error("Неверный тип категории");return}c(!0);try{const S=parseInt(r),O=await qr(S,i,T);B(O)}catch(S){console.error("Error calculating shipping:",S),y.error(`Ошибка расчёта доставки: ${S.message}`),B(null)}finally{c(!1)}},F=T=>T.toLowerCase(),$=T=>{const S=T.target.value;if(S&&!/^\d+$/.test(S)){E("Введите только цифры"),s(S);return}const O=parseInt(S);S&&(O<=0||O>=1e6)?E("Цена должна быть от 1 до 999,999 юаней"):E(""),s(S)},K=T=>{const S=T.target.value,O=Y(S),A=O||S;A&&!f(A)?C("Введите корректную ссылку"):C(""),n(O||S)},Y=T=>{const S=[/https?:\/\/dw4\.co\/[^\s]+/i,/https?:\/\/m\.dewu\.com\/[^\s]+/i,/https?:\/\/www\.dewu\.com\/[^\s]+/i,/https?:\/\/dewu\.com\/[^\s]+/i];for(const O of S){const A=T.match(O);if(A&&A[0])return console.log("Extracted DEWU URL:",A[0]),A[0]}return null},f=T=>{try{return new URL(T),!0}catch{return!1}},w=T=>{V(),o(T.target.value),B(null)},v=T=>{V(),m(T),B(null)},I=async()=>{if(!u){y.error("Введите ссылку на товар");return}if(P){y.error("Введите корректную ссылку на товар");return}if(!D){y.error("Сначала рассчитайте стоимость");return}const T=F(a);if(!T){y.error("Неверный тип категории");return}j(!0);try{const S=r?parseInt(r):0;t({dewu_url:u,size:l||"Не указан",category_type:T,shipping_type:i==="car"?"cargo":"aero",price:D,price_cny:S,name:`Предзаказ - ${T==="обувь"?"Обувь":T==="одежда"?"Одежда":T==="аксессуары"?"Аксессуары":a} - ${l||"Размер не указан"}`}),y.success("Предзаказ добавлен в корзину"),n(""),p(""),B(null)}catch(S){console.error("Error adding preorder to cart:",S),y.error("Ошибка при добавлении предзаказа в корзину")}finally{j(!1)}};return e.jsx(J,{children:e.jsxs("div",{className:"p-4",children:[e.jsxs("div",{className:"flex items-center mb-6",children:[e.jsx(er,{className:"mr-2 text-telegram-blue",size:24}),e.jsx("h1",{className:"text-2xl font-semibold",children:"Калькулятор доставки"})]}),e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"block text-sm font-medium",children:"Цена товара (юани)"}),e.jsx("input",{type:"text",value:r,onChange:$,placeholder:"Введите цену в юанях",className:`w-full p-3 rounded-lg border ${N?"border-red-500":"border-gray-300 dark:border-gray-700"} bg-white dark:bg-sidebar-accent`}),N&&e.jsx("p",{className:"text-red-500 text-sm",children:N}),e.jsx("div",{className:"flex items-center text-xs text-telegram-hint",children:e.jsxs("button",{onClick:()=>Rr("https://telegra.ph/Poisk-i-kartochka-tovara-ceny-razmernaya-setka-i-sroki-dostavki-04-11"),className:"flex items-center text-telegram-link",children:["Как проверить цену? ",e.jsx(Te,{size:12,className:"ml-1"})]})})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"block text-sm font-medium",children:"Категория товара"}),e.jsx("select",{value:a,onChange:w,className:"w-full p-3 rounded-lg border border-gray-300 dark:border-gray-700 bg-white dark:bg-sidebar-accent",disabled:_,children:_?e.jsx("option",{value:"",children:"Загрузка категорий..."}):h.length===0?e.jsx("option",{value:"",children:"Нет доступных категорий"}):h.map(T=>e.jsx("option",{value:T.name,children:yt(T.name)},T.id))})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"block text-sm font-medium",children:"Тип доставки"}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("button",{type:"button",onClick:()=>v("car"),className:`p-3 rounded-lg flex flex-col items-center justify-center ${i==="car"?"bg-telegram-blue text-white":"bg-white dark:bg-sidebar-accent border border-gray-300 dark:border-gray-700"}`,children:[e.jsx(rr,{size:24,className:"mb-2"}),e.jsx("span",{className:"font-medium",children:"Автомобиль"}),e.jsx("span",{className:"text-xs mt-1 opacity-80",children:"21-35 дней"})]}),e.jsxs("button",{type:"button",onClick:()=>v("plane"),className:`p-3 rounded-lg flex flex-col items-center justify-center ${i==="plane"?"bg-telegram-blue text-white":"bg-white dark:bg-sidebar-accent border border-gray-300 dark:border-gray-700"}`,children:[e.jsx(tr,{size:24,className:"mb-2"}),e.jsx("span",{className:"font-medium",children:"Самолет"}),e.jsx("span",{className:"text-xs mt-1 opacity-80",children:"5-10 дней"})]})]})]}),e.jsx("button",{type:"button",onClick:U,disabled:d||!r||!!N||!a,className:"w-full bg-green-600 text-white p-4 rounded-lg font-medium disabled:opacity-50 disabled:cursor-not-allowed",children:d?e.jsxs(e.Fragment,{children:[e.jsx(te,{className:"inline-block mr-2 h-4 w-4 animate-spin"}),"Идет расчет..."]}):"Рассчитать стоимость доставки"}),D!==null&&e.jsxs("div",{className:"mt-8 p-4 bg-telegram-secondary-bg rounded-lg",children:[e.jsx("h2",{className:"text-lg font-medium mb-2",children:"Предварительная стоимость"}),e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{children:"Итоговая цена:"}),e.jsxs("span",{className:"text-2xl font-bold text-telegram-blue",children:["₽",D.toLocaleString()]})]}),e.jsx("div",{className:"mt-4 text-xs text-telegram-hint",children:e.jsx("p",{children:"Включает стоимость товара, доставки и комиссии"})})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("label",{className:"block text-sm font-medium",children:["Ссылка на товар ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx("input",{type:"text",value:u,onChange:K,placeholder:"Вставьте ссылку Poizon (DEWU)",className:`w-full p-3 rounded-lg border ${P?"border-red-500":"border-gray-300 dark:border-gray-700"} bg-white dark:bg-sidebar-accent`}),P&&e.jsx("p",{className:"text-red-500 text-sm",children:P}),e.jsx("div",{className:"flex items-center text-xs text-telegram-hint",children:e.jsxs("a",{href:"https://teletype.in/@poizonshop/link",target:"_blank",rel:"noopener noreferrer",className:"flex items-center text-telegram-link",children:["Как получить ссылку? ",e.jsx(Te,{size:12,className:"ml-1"})]})})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"block text-sm font-medium",children:"Размер (Необязательно)"}),e.jsx("input",{type:"text",value:l,onChange:T=>p(T.target.value),placeholder:"например, 42, XL и т.д.",className:"w-full p-3 rounded-lg border border-gray-300 dark:border-gray-700 bg-white dark:bg-sidebar-accent"})]}),D!==null&&e.jsx("button",{onClick:I,disabled:x||!u||!!P,className:"w-full mt-4 bg-telegram-blue text-white py-3 rounded-lg font-medium hover:bg-telegram-dark transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2",children:x?e.jsxs(e.Fragment,{children:[e.jsx(te,{className:"h-5 w-5 animate-spin"}),"Добавление в корзину..."]}):e.jsxs(e.Fragment,{children:[e.jsx(Pe,{size:20}),"Добавить в корзину"]})})]})]})})},vt=()=>{const t=Z();me();const[r,s]=g.useState(""),[a,o]=g.useState(""),[i,m]=g.useState(""),[u,n]=g.useState(!1),[l,p]=g.useState(!0);g.useEffect(()=>{(async()=>{p(!0);try{const x=await we();x&&(s(x.email||""),o(x.phone_number||""),m(x.address||""))}catch(x){console.error("Error loading client info:",x)}finally{p(!1)}})()},[]);const d=async c=>{c.preventDefault(),n(!0);try{if(!r.trim()){y.error("Пожалуйста, введите ваш email"),n(!1);return}if(!a.trim()){y.error("Пожалуйста, введите ваш номер телефона"),n(!1);return}if(!i.trim()){y.error("Пожалуйста, введите ваш адрес"),n(!1);return}await Mr(a,r,i)&&t("/profile")}catch(x){console.error("Error saving settings:",x),y.error("Ошибка сохранения настроек. Пожалуйста, попробуйте позже.")}finally{n(!1)}};return e.jsx(J,{children:e.jsxs("div",{className:"p-4",children:[e.jsxs("div",{className:"flex items-center gap-4 mb-6",children:[e.jsx("button",{onClick:()=>t("/profile"),className:"w-8 h-8 flex items-center justify-center rounded-full bg-gray-100 dark:bg-gray-800",children:e.jsx(sr,{size:18})}),e.jsx("h1",{className:"text-xl font-semibold",children:"Settings"})]}),l?e.jsx("div",{className:"flex items-center justify-center py-8",children:e.jsx(te,{className:"w-8 h-8 animate-spin text-telegram-blue"})}):e.jsxs("form",{onSubmit:d,className:"space-y-6",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{htmlFor:"email",className:"text-sm font-medium text-gray-700 dark:text-gray-300",children:"Email Address *"}),e.jsx("input",{id:"email",type:"email",value:r,onChange:c=>s(c.target.value),className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded-md shadow-sm focus:outline-none focus:ring-telegram-blue focus:border-telegram-blue dark:bg-gray-800",placeholder:"your@email.com",required:!0})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{htmlFor:"phone",className:"text-sm font-medium text-gray-700 dark:text-gray-300",children:"Phone Number *"}),e.jsx("input",{id:"phone",type:"tel",value:a,onChange:c=>o(c.target.value),className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded-md shadow-sm focus:outline-none focus:ring-telegram-blue focus:border-telegram-blue dark:bg-gray-800",placeholder:"+7 (999) 123-4567",required:!0})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{htmlFor:"address",className:"text-sm font-medium text-gray-700 dark:text-gray-300",children:"Address *"}),e.jsx("textarea",{id:"address",value:i,onChange:c=>m(c.target.value),className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded-md shadow-sm focus:outline-none focus:ring-telegram-blue focus:border-telegram-blue dark:bg-gray-800",placeholder:"Your full address",rows:3,required:!0})]}),e.jsx("button",{type:"submit",disabled:u,className:"w-full flex items-center justify-center gap-2 bg-telegram-blue text-white py-2 px-4 rounded-md hover:bg-telegram-dark transition-colors disabled:opacity-50 disabled:cursor-not-allowed",children:u?e.jsxs(e.Fragment,{children:[e.jsx(te,{className:"h-4 w-4 animate-spin"}),"Saving..."]}):e.jsxs(e.Fragment,{children:[e.jsx(or,{size:16}),"Save Settings"]})})]})]})})},jt=new ar({defaultOptions:{queries:{refetchOnWindowFocus:!1,staleTime:1e3*60*5}}}),Nt=()=>{var t;return{tg:(t=window.Telegram)==null?void 0:t.WebApp,initWebApp:()=>{var r,s,a;console.log("Mock initWebApp called"),(r=window.Telegram)!=null&&r.WebApp&&((a=(s=window.Telegram.WebApp).ready)==null||a.call(s))},getUserData:()=>{var r,s,a;if(console.log("Mock getUserData called"),(a=(s=(r=window.Telegram)==null?void 0:r.WebApp)==null?void 0:s.initDataUnsafe)!=null&&a.user)return window.Telegram.WebApp.initDataUnsafe.user;try{const o=localStorage.getItem("telegramUser");if(o)return JSON.parse(o)}catch(o){console.error("Error retrieving user data from localStorage:",o)}return null}}},kt=({children:t})=>{const r=ur(),s=Z(),{updateTelegramUser:a}=me(),[o,i]=g.useState(!1),[m,u]=g.useState(!0),{tg:n,initWebApp:l,getUserData:p}=Nt(),{referralCode:d,isProcessing:c}=Zr();et({onNewUser:h=>{h&&d&&(console.log(`New user registered with referral code: ${d}`),y.success("Добро пожаловать! Вас пригласил друг."))}}),g.useEffect(()=>{const h=Or();return()=>{h()}},[]);const x=g.useCallback(async()=>{try{const h=await ce();console.log("API user check result:",h),h||console.log("User does not exist in the system yet")}catch(h){console.error("Error checking user in API:",h)}},[]),j=g.useCallback(async()=>{if(o)return;console.log("Initializing Telegram interface...");const h=navigator.userAgent.toLowerCase().includes("telegram")||window.location.href.includes("tgwebapp");console.log(h?"Running in Telegram browser":"Not running in Telegram browser");try{if(n){l(),H(),oe(),await new Promise(_=>setTimeout(_,300));const k=p();k?(console.log("User data retrieved:",k),a(k),await x(),i(!0),u(!1)):h?(console.log("No user data available despite being in Telegram browser"),setTimeout(()=>{const _=p();if(_)console.log("User data retrieved after delay:",_),a(_);else{console.log("Still no user data after retry. This might indicate:"),console.log("1. The Mini App is not properly configured in BotFather"),console.log("2. The user is not using the official Telegram app"),console.log("3. There's an issue with the initData validation");try{const b=localStorage.getItem("telegramUser");if(b){const N=JSON.parse(b);console.log("Using stored user data from localStorage:",N),a(N)}}catch(b){console.error("Error retrieving user data from localStorage:",b)}}i(!0),u(!1)},800)):(console.log("Not in Telegram browser, continuing without user data"),i(!0),u(!1))}else{console.log("Telegram WebApp is not available, using fallback method"),Ir(),H(),await new Promise(_=>setTimeout(_,300));const k=Ne();k&&(console.log("User data retrieved using fallback method:",k),a(k)),i(!0),u(!1)}}catch(k){console.error("Error during Telegram initialization:",k),i(!0),u(!1)}},[o,a,n,l,p,x]);return g.useEffect(()=>(r.pathname!=="/"?(console.log("Showing back button for path:",r.pathname),zr(()=>{console.log("Back button pressed, navigating back"),s(-1)})):(console.log("Hiding back button for home page"),Ee()),()=>{Ee()}),[r.pathname,s]),g.useEffect(()=>{console.log("Setting up theme change listener"),oe(),H();const h=()=>{console.log("Theme change detected, adapting to user theme"),H()};return window.addEventListener("themechange",h),()=>{window.removeEventListener("themechange",h)}},[]),g.useEffect(()=>{j().finally(()=>{u(!1)})},[j]),m?e.jsx("div",{className:"min-h-screen flex items-center justify-center",children:e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-telegram-blue"})}):t},St=()=>e.jsx(nr,{defaultTheme:"dark",attribute:"class",children:e.jsx(lr,{client:jt,children:e.jsx(Sr,{children:e.jsx(Qr,{children:e.jsxs(Vr,{children:[e.jsx(ir,{richColors:!0,closeButton:!0,position:"top-center"}),e.jsx(cr,{children:e.jsx(kt,{children:e.jsxs(dr,{children:[e.jsx(G,{path:"/",element:e.jsx(dt,{})}),e.jsx(G,{path:"/shop",element:e.jsx(mt,{})}),e.jsx(G,{path:"/product/:productId",element:e.jsx(gt,{})}),e.jsx(G,{path:"/profile",element:e.jsx(ht,{})}),e.jsx(G,{path:"/cart",element:e.jsx(xt,{})}),e.jsx(G,{path:"/calculator",element:e.jsx(wt,{})}),e.jsx(G,{path:"/settings",element:e.jsx(vt,{})}),e.jsx(G,{path:"*",element:e.jsx(bt,{})})]})})})]})})})})});oe();H();window.addEventListener("load",()=>{H(),setTimeout(()=>{oe()},1e3)});window.toast=y;mr.createRoot(document.getElementById("root")).render(e.jsx(pt,{children:e.jsx(gr.StrictMode,{children:e.jsx(St,{})})}));export{Er as a,Pt as b,Dt as c,Ce as d,Ut as e,It as f,Cr as g,V as h,At as i,we as j,Mr as k,Ot as l,$t as m,Ct as n,ut as s,ge as u,zt as v};
//# sourceMappingURL=main-B9aqh9-l.js.map
