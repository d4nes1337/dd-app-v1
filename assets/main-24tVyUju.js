const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/vendor-CXhN_Lhc.js","assets/vendor-BcVQFBZl.css"])))=>i.map(i=>d[i]);
import{r as g,B as Qe,F as Xe,J as w,Z as z,G as Ze,I as er,K as rr,O as oe,Q as Ie,j as e,f as X,L as M,U as xe,W as tr,q as le,S as ie,Y as _e,_ as sr,X as Z,z as ye,$ as or,a0 as $e,M as ar,y as nr,a1 as lr,a2 as Oe,a3 as ir,s as re,g as cr,E as Ce,a4 as dr,a5 as ur,h as mr,a6 as gr,a7 as pr,a8 as hr,a9 as fr,aa as xr,ab as yr,ac as V,u as br,ad as wr}from"./vendor-CXhN_Lhc.js";import{P as q,U as Re,B as jr,L as Se,a as vr,b as kr,S as Nr,R as Tr,O as Sr,C as Er,c as _r,d as Cr,T as Dr,e as Ar,f as Pr}from"./components-CT8MvdWU.js";import"./main-24tVyUju.js";(function(){const r=document.createElement("link").relList;if(r&&r.supports&&r.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))n(o);new MutationObserver(o=>{for(const a of o)if(a.type==="childList")for(const c of a.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&n(c)}).observe(document,{childList:!0,subtree:!0});function s(o){const a={};return o.integrity&&(a.integrity=o.integrity),o.referrerPolicy&&(a.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?a.credentials="include":o.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function n(o){if(o.ep)return;o.ep=!0;const a=s(o);fetch(o.href,a)}})();function Dt(t){return t&&t.__esModule&&Object.prototype.hasOwnProperty.call(t,"default")?t.default:t}const Ur=1,Ir=1e6;let be=0;function $r(){return be=(be+1)%Number.MAX_SAFE_INTEGER,be.toString()}const we=new Map,De=t=>{if(we.has(t))return;const r=setTimeout(()=>{we.delete(t),ee({type:"REMOVE_TOAST",toastId:t})},Ir);we.set(t,r)},Or=(t,r)=>{switch(r.type){case"ADD_TOAST":return{...t,toasts:[r.toast,...t.toasts].slice(0,Ur)};case"UPDATE_TOAST":return{...t,toasts:t.toasts.map(s=>s.id===r.toast.id?{...s,...r.toast}:s)};case"DISMISS_TOAST":{const{toastId:s}=r;return s?De(s):t.toasts.forEach(n=>{De(n.id)}),{...t,toasts:t.toasts.map(n=>n.id===s||s===void 0?{...n,open:!1}:n)}}case"REMOVE_TOAST":return r.toastId===void 0?{...t,toasts:[]}:{...t,toasts:t.toasts.filter(s=>s.id!==r.toastId)}}},ae=[];let ne={toasts:[]};function ee(t){ne=Or(ne,t),ae.forEach(r=>{r(ne)})}function Rr({...t}){const r=$r(),s=o=>ee({type:"UPDATE_TOAST",toast:{...o,id:r}}),n=()=>ee({type:"DISMISS_TOAST",toastId:r});return ee({type:"ADD_TOAST",toast:{...t,id:r,open:!0,onOpenChange:o=>{o||n()}}}),{id:r,dismiss:n,update:s}}function At(){const[t,r]=g.useState(ne);return g.useEffect(()=>(ae.push(r),()=>{const s=ae.indexOf(r);s>-1&&ae.splice(s,1)}),[t]),{...t,toast:Rr,dismiss:s=>ee({type:"DISMISS_TOAST",toastId:s})}}function Pt(...t){return Qe(Xe(t))}const Ne=["😀","😃","😄","😁","😆","😅","😂","🤣","😊","😇","🙂","🙃","😉","😌","😍","🥰","😘","😗","😙","😚","😋","😛","😝","😜","🤪","🤨","🧐","🤓","😎","🤩","🥳","😏","😒","😞","😔","😟","😕","🙁","☹️","😣","😖","😫","😩","🥺","😢","😭","😤","😠","😡","🤬","🤯","😳","🥵","🥶","😱","😨","😰","😥","😓","🤗","🤔","🤭","🤫","🤥","😶","😐","😑","😬","🙄","😯"],Lr=["👕","👚","👔","👗","👖","🧥","🧦","👟","👞","🧢","👒","🎩","🧣","🧤","👜","👝","👛","👓","🕶️","🥾","🥿","🌂","☂️","💼","🎒","👑","💄","💍","💎","⌚","🧸","🔮","🧩","🧶","🧵","🔭","🧬","🔬","🧪","📱","💻","🖥️","🖱️","🖨️","📷","🎮","🎧","🎵","📚","✏️"],Wr=["🎉","🎊","🎁","🎈","🎀","🎐","🎇","🎆","✨","🔥","💫","⭐","🌟","💥","💯","💢","💦","💤","💨","🕊️","💝","💖","💗","💓","💞","💕","❤️","🧡","💛","💚"],zr=()=>{const t=Math.floor(Math.random()*Ne.length);return Ne[t]},Br=(t,r)=>{const s=Array.from(t).reduce((a,c)=>a+c.charCodeAt(0),0),n=r==="avatar"?Ne:r==="product"?Lr:Wr,o=s%n.length;return n[o]},B="https://v2786182.hosted-by-vdsina.ru/api/v1",H={PRODUCTS:15e3,ORDERS:12e3,PROFILE:12e3},te={PRODUCTS_TTL:5*60*1e3,PROFILE_TTL:10*60*1e3,ORDERS_TTL:3*60*1e3},O={_store:new Map,get(t,r){const s=this._store.get(t);return s?Date.now()-s.timestamp>r?(this._store.delete(t),null):s.data:null},set(t,r){this._store.set(t,{data:r,timestamp:Date.now()})},invalidate(t){this._store.delete(t)},clear(){this._store.clear()}},Fr=t=>{console.error("API Error:",t);let r="An error occurred. Please try again.";if(t.response){const s=t.response.status;try{const n=t.response.data;n&&n.detail?r=`API Error (${s}): ${n.detail}`:r=`API Error (${s}): ${t.response.statusText}`}catch{r=`API Error (${s}): Could not parse error details`}}else t.request?r="Network Error: No response from server. Using cached data instead.":t instanceof Error&&(r=`Error: ${t.message}`);return r.includes("Using cached data")?w.info(r):w.error(r),Promise.reject(new Error(r))},L=(t="GET",r,s=H.PRODUCTS)=>{const n=new AbortController,o=setTimeout(()=>n.abort(),s),a={method:t,signal:n.signal,mode:"cors",headers:{Accept:"application/json",...r?{"Content-Type":"application/json"}:{}},...r?{body:JSON.stringify(r)}:{}};return{signal:n.signal,options:a,clearTimeout:()=>clearTimeout(o)}},qr="modulepreload",Jr=function(t){return"/dd-app-v1/"+t},Ae={},Le=function(r,s,n){let o=Promise.resolve();if(s&&s.length>0){document.getElementsByTagName("link");const c=document.querySelector("meta[property=csp-nonce]"),m=(c==null?void 0:c.nonce)||(c==null?void 0:c.getAttribute("nonce"));o=Promise.allSettled(s.map(l=>{if(l=Jr(l),l in Ae)return;Ae[l]=!0;const i=l.endsWith(".css"),h=i?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${l}"]${h}`))return;const d=document.createElement("link");if(d.rel=i?"stylesheet":qr,i||(d.as="script"),d.crossOrigin="",d.href=l,m&&d.setAttribute("nonce",m),document.head.appendChild(d),i)return new Promise((u,f)=>{d.addEventListener("load",u),d.addEventListener("error",()=>f(new Error(`Unable to preload CSS for ${l}`)))})}))}function a(c){const m=new Event("vite:preloadError",{cancelable:!0});if(m.payload=c,window.dispatchEvent(m),!m.defaultPrevented)throw c}return o.then(c=>{for(const m of c||[])m.status==="rejected"&&a(m.reason);return r().catch(a)})};function se(){var t;if(typeof window<"u"&&((t=window.Telegram)!=null&&t.WebApp))return window.Telegram.WebApp}function We(){try{console.log("Initializing Telegram WebApp...");try{Ze.ready(),er.expand(),console.log("Telegram WebApp initialized successfully using SDK")}catch(t){console.warn("SDK initialization failed, falling back to direct WebApp API:",t);const r=se();if(r)r.ready(),r.expand(),console.log("Telegram WebApp initialized successfully using direct WebApp API");else throw new Error("Telegram WebApp is not available")}}catch(t){console.error("Error initializing Telegram WebApp:",t)}}function Mr(){try{const t=document.documentElement;t.classList.add("telegram-webview");const r=se(),s=z.isDark||(r==null?void 0:r.colorScheme)==="dark";s?(t.classList.add("dark"),t.classList.remove("light")):(t.classList.add("light"),t.classList.remove("dark")),console.log(`Theme set to ${s?"dark":"light"} mode`)}catch(t){console.error("Error setting theme class:",t)}}function me(){var t,r,s,n,o;try{console.log("Attempting to get Telegram user data...");try{const{initData:a,user:c}=rr();if(c){console.log("User data found in launch parameters:",c);try{localStorage.setItem("telegramUser",JSON.stringify(c))}catch(m){console.error("Error storing user data in localStorage:",m)}return c}else console.log("No user data in launch parameters")}catch(a){console.error("Error retrieving launch parameters:",a)}if((s=(r=(t=window.Telegram)==null?void 0:t.WebApp)==null?void 0:r.initDataUnsafe)!=null&&s.user){const a=window.Telegram.WebApp.initDataUnsafe.user;console.log("User data found in window.Telegram.WebApp.initDataUnsafe:",a);try{localStorage.setItem("telegramUser",JSON.stringify(a))}catch(c){console.error("Error storing user data in localStorage:",c)}return a}if((o=(n=window.Telegram)==null?void 0:n.WebApp)!=null&&o.initData)try{const a=new URLSearchParams(window.Telegram.WebApp.initData);if(console.log("Parsed initData params:",Array.from(a.entries())),a.has("user"))try{const c=JSON.parse(decodeURIComponent(a.get("user")||"{}"));console.log("User data parsed from initData:",c);try{localStorage.setItem("telegramUser",JSON.stringify(c))}catch(m){console.error("Error storing user data in localStorage:",m)}return c}catch(c){console.error("Error parsing user data from initData:",c)}else console.log("No user param in initData")}catch(a){console.error("Error parsing initData:",a)}try{const a=localStorage.getItem("telegramUser");if(a){const c=JSON.parse(a);return console.log("Using stored user data from localStorage:",c),c}}catch(a){console.error("Error retrieving user data from localStorage:",a)}return console.log("No Telegram user data available from any source"),null}catch(a){return console.error("Error getting Telegram user:",a),null}}function Hr(t){var r,s,n,o;try{console.log("Showing back button");try{oe.offClick(()=>{})}catch{console.log("No existing back button handlers to remove")}if(oe.onClick(t),oe.show(),(s=(r=window.Telegram)==null?void 0:r.WebApp)!=null&&s.BackButton)try{window.Telegram.WebApp.BackButton.onClick(t),window.Telegram.WebApp.BackButton.show()}catch(a){console.error("Error using direct WebApp API for back button:",a)}console.log("Back button shown and callback registered")}catch(a){if(console.error("Error showing back button:",a),(o=(n=window.Telegram)==null?void 0:n.WebApp)!=null&&o.BackButton)try{window.Telegram.WebApp.BackButton.onClick(t),window.Telegram.WebApp.BackButton.show(),console.log("Back button shown using direct WebApp API")}catch(c){console.error("Error using direct WebApp API for back button:",c)}}}function Pe(){var t,r,s,n;try{if(console.log("Hiding back button"),oe.hide(),(r=(t=window.Telegram)==null?void 0:t.WebApp)!=null&&r.BackButton)try{window.Telegram.WebApp.BackButton.hide()}catch(o){console.error("Error using direct WebApp API to hide back button:",o)}console.log("Back button hidden")}catch(o){if(console.error("Error hiding back button:",o),(n=(s=window.Telegram)==null?void 0:s.WebApp)!=null&&n.BackButton)try{window.Telegram.WebApp.BackButton.hide(),console.log("Back button hidden using direct WebApp API")}catch(a){console.error("Error using direct WebApp API to hide back button:",a)}}}function ze(t){var r,s,n;try{const o=se();o!=null&&o.postEvent?o.postEvent("web_app_trigger_haptic_feedback",JSON.stringify(t)):(s=(r=window.Telegram)==null?void 0:r.WebviewProxy)!=null&&s.postEvent?window.Telegram.WebviewProxy.postEvent("web_app_trigger_haptic_feedback",JSON.stringify(t)):(n=window.TelegramWebviewProxy)!=null&&n.postEvent?window.TelegramWebviewProxy.postEvent("web_app_trigger_haptic_feedback",JSON.stringify(t)):console.warn("No method available to send haptic feedback event")}catch(o){console.error("Error sending haptic feedback event:",o)}}const Ut=(t="medium")=>{try{try{Ie.impactOccurred(t),console.log(`Haptic impact triggered via SDK: ${t}`)}catch(r){console.warn("SDK haptic impact failed, falling back to direct WebApp API:",r),ze({type:"impact",impact_style:t}),console.log(`Haptic impact triggered via WebApp API: ${t}`)}}catch(r){console.error("Error triggering haptic impact:",r)}},Y=()=>{try{try{Ie.selectionChanged(),console.log("Haptic selection triggered via SDK")}catch(t){console.warn("SDK haptic selection failed, falling back to direct WebApp API:",t),ze({type:"selection_change"}),console.log("Haptic selection triggered via WebApp API")}}catch(t){console.error("Error triggering haptic selection:",t)}};function ce(){var t;try{if(console.log("Requesting current theme from Telegram"),(t=window.Telegram)!=null&&t.WebApp)try{window.Telegram.WebApp.postEvent("web_app_request_theme",""),console.log("Theme requested from Telegram using WebApp.postEvent")}catch(r){console.error("Error requesting theme using WebApp.postEvent:",r)}try{Le(async()=>{const{postEvent:r}=await import("./vendor-CXhN_Lhc.js").then(s=>s.ae);return{postEvent:r}},__vite__mapDeps([0,1])).then(({postEvent:r})=>{r("web_app_request_theme"),console.log("Theme requested from Telegram using SDK postEvent")}).catch(r=>{console.error("Error importing SDK for postEvent:",r)})}catch(r){console.error("Error requesting theme using SDK postEvent:",r)}}catch(r){console.error("Error requesting Telegram theme:",r)}}function Kr(){console.log("Setting up theme change listener for instant updates");const t=()=>{console.log("Theme change detected, updating colors and styles"),Mr(),Q()},r=se();if(r)try{return r.onEvent("themeChanged",t),window.addEventListener("themechange",t),()=>{try{r.offEvent("themeChanged",t)}catch(s){console.warn("Error removing Telegram theme listener:",s)}window.removeEventListener("themechange",t)}}catch(s){return console.error("Error setting up Telegram event listener:",s),window.addEventListener("themechange",t),()=>{window.removeEventListener("themechange",t)}}return window.addEventListener("themechange",t),()=>{window.removeEventListener("themechange",t)}}function Q(){var t,r,s,n,o,a,c,m,l;try{console.log("Setting Telegram Mini App colors based on Telegram's native theme");const i=se();let h,d,u,f,k,j,N,C;if(i){console.log("WebApp theme params:",i.themeParams),h=((t=i.themeParams)==null?void 0:t.bg_color)||(i.colorScheme==="dark"?"#271a28":"#ffffff"),d=((r=i.themeParams)==null?void 0:r.secondary_bg_color)||(i.colorScheme==="dark"?"#382639":"#f7f7f7"),u=((s=i.themeParams)==null?void 0:s.text_color)||(i.colorScheme==="dark"?"#ffffff":"#000000"),f=((n=i.themeParams)==null?void 0:n.hint_color)||(i.colorScheme==="dark"?"#7d7d7d":"#999999"),k=((o=i.themeParams)==null?void 0:o.link_color)||(i.colorScheme==="dark"?"#64baff":"#2481cc"),j=((a=i.themeParams)==null?void 0:a.button_color)||(i.colorScheme==="dark"?"#3390ec":"#2481cc"),N=((c=i.themeParams)==null?void 0:c.button_text_color)||"#ffffff",C=i.colorScheme==="dark",console.log("Using native Telegram theme colors:",{bgColor:h,secondaryBgColor:d,textColor:u,hintColor:f,linkColor:k,buttonColor:j,buttonTextColor:N,isDark:C});try{if(i.setHeaderColor?(i.setHeaderColor(d),console.log("Header color set using WebApp.setHeaderColor:",d)):(i.postEvent("web_app_set_header_color",JSON.stringify({color:d})),console.log("Header color set using postEvent:",d)),(m=window.Telegram)!=null&&m.WebApp){const x=window.Telegram.WebApp;typeof x.setHeaderColor=="function"&&(x.setHeaderColor(d),console.log("Header color set using global Telegram.WebApp.setHeaderColor"))}}catch(x){console.error("Error setting header color:",x);try{(l=window.Telegram)!=null&&l.WebApp&&typeof window.Telegram.WebApp.setHeaderColor=="function"&&(window.Telegram.WebApp.setHeaderColor("secondary_bg_color"),console.log("Header color set using color_key: secondary_bg_color"))}catch(v){console.error("All attempts to set header color failed:",v)}}try{i.setBackgroundColor?(i.setBackgroundColor(d),console.log("Background color set using WebApp.setBackgroundColor:",d)):(i.postEvent("web_app_set_background_color",JSON.stringify({color:d})),console.log("Background color set using postEvent:",d))}catch(x){console.error("Error setting background color:",x)}}else{console.log("WebApp not available, using SDK theme params"),h=z.backgroundColor||(z.isDark?"#271a28":"#ffffff"),d=z.secondaryBackgroundColor||(z.isDark?"#382639":"#f7f7f7"),u=z.textColor||(z.isDark?"#ffffff":"#000000"),f=z.hintColor||(z.isDark?"#7d7d7d":"#999999"),k=z.linkColor||(z.isDark?"#64baff":"#2481cc"),j=z.buttonColor||(z.isDark?"#3390ec":"#2481cc"),N=z.buttonTextColor||"#ffffff",C=!!z.isDark,console.log("Using SDK theme colors:",{bgColor:h,secondaryBgColor:d,textColor:u,hintColor:f,linkColor:k,buttonColor:j,buttonTextColor:N,isDark:C});try{Le(async()=>{const{postEvent:x}=await import("./vendor-CXhN_Lhc.js").then(v=>v.ae);return{postEvent:x}},__vite__mapDeps([0,1])).then(({postEvent:x})=>{x("web_app_set_header_color",{color:d}),console.log("Header color set to match frontend background:",d,"via SDK"),x("web_app_set_background_color",{color:d}),console.log("Background color set to:",d,"via SDK")}).catch(x=>{console.error("Error importing SDK for postEvent:",x)})}catch(x){console.error("Error setting colors via SDK:",x)}}Gr(d,u,f,k,j,N,d,C),ce()}catch(i){console.error("Error setting Telegram colors:",i)}}function Gr(t,r,s,n,o,a,c,m){try{const l=m===!0,i=t,h=c;console.log(`Applying ${l?"dark":"light"} theme CSS with Telegram colors`),console.log(`Using main background color: ${i}`),console.log(`Using header background color: ${h}`);const d=document.documentElement;l?(d.classList.add("dark"),d.classList.remove("light")):(d.classList.add("light"),d.classList.remove("dark")),d.classList.add("telegram-webview");const u=document.createElement("style");u.textContent=`
      :root {
        --tg-theme-bg-color: ${h} !important;
        --tg-theme-secondary-bg-color: ${i} !important;
        --tg-theme-text-color: ${r} !important;
        --tg-theme-hint-color: ${s} !important;
        --tg-theme-link-color: ${n} !important;
        --tg-theme-button-color: ${o} !important;
        --tg-theme-button-text-color: ${a} !important;
        --tg-color-scheme: ${l?"dark":"light"} !important;
        
        --telegram-bg: ${i} !important;
        --telegram-header-bg: ${h} !important;
        --telegram-secondary-bg: ${h} !important;
        --telegram-text: ${r} !important;
        --telegram-hint: ${s} !important;
        --telegram-link: ${n} !important;
        --telegram-button: ${o} !important;
        --telegram-button-text: ${a} !important;
      }
      
      body, html, #root {
        background-color: ${i} !important;
        color: ${r} !important;
      }
      
      .${l?"dark":"light"} body, .${l?"dark":"light"} html, .${l?"dark":"light"} #root {
        background-color: ${i} !important;
      }
      
      /* Apply colors to common UI elements */
      .card, .popover, .dropdown-menu, .card-container {
        background-color: ${h} !important;
        color: ${r} !important;
        border: 1px solid ${l?"rgba(255, 255, 255, 0.1)":"rgba(0, 0, 0, 0.1)"} !important;
      }
      
      a {
        color: ${n} !important;
      }
      
      .hint, .text-muted {
        color: ${s} !important;
      }
      
      .btn-primary, .button-primary {
        background-color: ${o} !important;
        color: ${a} !important;
      }
      
      /* Search inputs and form controls */
      input, select, textarea {
        background-color: ${i} !important;
        color: ${r} !important;
        border-color: ${s}30 !important;
      }
      
      input:focus, select:focus, textarea:focus {
        border-color: ${o} !important;
        box-shadow: 0 0 0 2px ${o}30 !important;
      }
      
      /* Size selector buttons */
      .size-button {
        background-color: ${i} !important;
        color: ${r} !important;
        border-color: ${s}30 !important;
      }
      
      .size-button.selected {
        background-color: ${o}10 !important;
        color: ${o} !important;
        border-color: ${o} !important;
      }
      
      /* Bottom navigation bar - solid color matching the secondary background color */
      .bottom-nav-bar {
        background-color: ${h} !important;
        /* Remove border and shadow */
        border-top: none !important;
        box-shadow: none !important;
        /* Add a subtle top border for separation */
        border-top: 1px solid ${l?"rgba(255, 255, 255, 0.05)":"rgba(0, 0, 0, 0.05)"} !important;
      }
      
      /* Bottom navigation items */
      .bottom-nav-bar a {
        color: ${s} !important;
        padding: 8px 0 !important;
        transition: all 0.2s ease !important;
      }
      
      /* Active navigation items */
      .bottom-nav-bar a.active, 
      .bottom-nav-bar a.active svg,
      .bottom-nav-bar a[aria-current="page"],
      .bottom-nav-bar a[aria-current="page"] svg {
        color: ${o} !important;
      }
      
      /* Navigation item hover effect */
      .bottom-nav-bar a:hover {
        color: ${o}CC !important;
        transform: translateY(-2px) !important;
      }
      
      /* Badge styling */
      .bottom-nav-bar .badge {
        background-color: ${o} !important;
        color: ${a} !important;
      }
      
      /* Force styles for desktop view */
      @media (min-width: 768px) {
        body, html, #root, .telegram-webview, .dark body, .dark html, .dark #root {
          background-color: ${i} !important;
        }
        
        .bottom-nav-bar, .dark .bottom-nav-bar {
          background-color: ${h} !important;
          border-top: none !important;
          box-shadow: none !important;
        }
      }
    `;const f=document.getElementById("telegram-theme-style");if(f&&f.remove(),u.id="telegram-theme-style",document.head.appendChild(u),d.style.setProperty("--tg-theme-bg-color",h,"important"),d.style.setProperty("--tg-theme-secondary-bg-color",i,"important"),d.style.setProperty("--tg-theme-text-color",r,"important"),d.style.setProperty("--tg-theme-hint-color",s,"important"),d.style.setProperty("--tg-theme-link-color",n,"important"),d.style.setProperty("--tg-theme-button-color",o,"important"),d.style.setProperty("--tg-theme-button-text-color",a,"important"),d.style.setProperty("--tg-color-scheme",l?"dark":"light","important"),document.body.style.backgroundColor=i,document.body.style.setProperty("background-color",i,"important"),document.body.style.color=r,document.body.style.setProperty("color",r,"important"),document.getElementById("root")){const j=document.getElementById("root");j.style.backgroundColor=i,j.style.setProperty("background-color",i,"important")}const k=document.querySelector(".bottom-nav-bar");k&&(k.style.backgroundColor=h,k.style.setProperty("background-color",h,"important"),k.style.backdropFilter="none",k.style.setProperty("-webkit-backdrop-filter","none","important"),k.style.borderTop="none",k.style.setProperty("border-top","none","important"),k.style.boxShadow="none",k.style.setProperty("box-shadow","none","important")),document.documentElement.style.backgroundColor=i,document.documentElement.style.setProperty("background-color",i,"important"),console.log(`${l?"Dark":"Light"} theme CSS applied with Telegram colors`)}catch(l){console.error("Error applying theme CSS:",l)}}const Be={PROFILE:t=>`profile_${t}`,RANK:t=>`rank_${t}`,DD_COINS:t=>`dd_coins_${t}`,DELIVERY_RATES:"delivery_rates"},R=()=>{try{const t=me();if(t)return console.log("Using Telegram user data from telegramUtils"),t;if(window.Telegram&&window.Telegram.WebApp){const r=window.Telegram.WebApp.initDataUnsafe.user;if(r&&r.id)return r;console.warn("Telegram WebApp available but user data is invalid")}return console.error("No Telegram user data available"),null}catch(t){return console.error("Error getting Telegram user:",t),null}},de=async(t=!1)=>{try{const r=R();if(!r)return console.error("No Telegram user data available for existence check"),!1;console.log(`Checking if user exists: ID=${r.id}, username=${r.username||"not set"}`);const s={telegram_user_id:r.id};r.username&&(s.telegram_username=r.username);const{options:n,clearTimeout:o}=L("POST",s,H.PROFILE);try{const a=await fetch(`${B}/users/check-exists`,n);if(o(),!a.ok){if(a.status===404)return console.log("User not found (404), considered as non-existent"),!1;const l=await a.text();let i;try{i=JSON.parse(l).detail||l}catch{i=l||`HTTP error ${a.status}`}throw new Error(i)}const c=await a.text(),m=JSON.parse(c);return console.log("User existence check result:",m),t?m:m.exists}catch(a){return console.error("Error checking if user exists:",a),!1}}catch(r){return console.error("Error in checkUserExists:",r),!1}},Fe=async()=>{try{const t=R();if(!t||!t.id)return console.error("No Telegram user data available for getting rank"),0;console.log(`Getting rank for user ID: ${t.id}`);const r=Be.RANK(t.id),s=O.get(r,te.PROFILE_TTL);if(s!==null)return console.log("Using cached rank data:",s),s;const n={telegram_user_id:t.id},{options:o,clearTimeout:a}=L("POST",n,H.PROFILE);try{const c=await fetch(`${B}/users/rank`,o);if(a(),c.status===404)return console.log("User not found in rank API, using default rank 0"),O.set(r,0),0;if(!c.ok){const h=await c.text();let d;try{d=JSON.parse(h).detail||h}catch{d=h||`HTTP error ${c.status}`}throw new Error(d)}const m=await c.text();console.log("Raw rank response:",m);const l=JSON.parse(m);if(console.log("User rank result:",l),l.loyalty_rank===void 0)return console.error("loyalty_rank not found in response:",l),O.set(r,0),0;const i=typeof l.loyalty_rank=="string"?parseInt(l.loyalty_rank,10)||0:Number(l.loyalty_rank)||0;return console.log("Extracted rank value:",i),O.set(r,i),i}catch(c){return console.error("Error getting user rank:",c),c.message.includes("User not found")||w.error(`Error getting rank: ${c.message}`),0}}catch(t){return console.error("Error in getUserRank:",t),t.message.includes("User not found")||w.error(`Error: ${t.message}`),0}},qe=async t=>{try{const r=R(),s=t||(r?r.id:0),n=r?r.username||`user_${s}`:`user_${s}`;if(!s)throw console.error("No user ID available for profile check"),new Error("User ID required");const o=await Fe();return console.log(`Retrieved loyalty rank for user ${s}: ${o}`),{telegram_username:n,rank:o,total_orders:0}}catch(r){return console.error("Error in legacy checkUserProfile:",r),{telegram_username:`user_${t||0}`,rank:0,total_orders:0}}},Je=async()=>{try{const t=R();if(!t||!t.id)return console.error("No Telegram user data available for getting DD coins balance"),0;console.log(`Getting DD coins balance for user ID: ${t.id}`);const r=Be.DD_COINS(t.id),s=O.get(r,te.PROFILE_TTL);if(s!==null)return console.log("Using cached DD coins balance:",s),s;const{options:n,clearTimeout:o}=L("GET",null,H.PROFILE);try{const a=await fetch(`${B}/users/${t.id}/dd-coins`,n);if(o(),a.status===404)return console.log("User not found in DD coins API, using default balance 0"),O.set(r,0),0;if(!a.ok){const i=await a.text();let h;try{h=JSON.parse(i).detail||i}catch{h=i||`HTTP error ${a.status}`}throw new Error(h)}const c=await a.text();console.log("Raw DD coins response:",c);const m=JSON.parse(c);console.log("DD coins response:",m);const l=m.dd_coins_balance?parseFloat(m.dd_coins_balance):0;return O.set(r,l),l}catch(a){return console.error("Error getting DD coins balance:",a),a.message.includes("User not found")||w.error(`Error getting DD coins balance: ${a.message}`),0}}catch(t){return console.error("Error in getDDCoinsBalance:",t),0}},je=[{sku:"TS001-BLK",item_name:"Basic T-Shirt",color_code:"BLK",brand:"FashionBrand",description:"Original SKU: TS001-BLK",price_rub:500,sizes:[{size:"M",quantity:2},{size:"L",quantity:2}],photos:[{photo_url:"https://example.com/photos/ts001_front.jpg",photo_category:"front"},{photo_url:"https://example.com/photos/ts001_side.jpg",photo_category:"side"}]},{sku:"JN002-BLU",item_name:"Slim Jeans",color_code:"BLU",brand:"DenimCo",description:"Original SKU: JN002-BLU",price_rub:1200,sizes:[{size:"32",quantity:2}],photos:[{photo_url:"https://example.com/photos/jn002_front.jpg",photo_category:"front"}]},{sku:"SW003-RED",item_name:"Wool Sweater",color_code:"RED",brand:"WinterWear",description:"Original SKU: SW003-RED",price_rub:1500,sizes:[{size:"S",quantity:1},{size:"M",quantity:3}],photos:[{photo_url:"https://example.com/photos/sw003_front.jpg",photo_category:"front"}]}],ue={PRODUCTS:"products",CATEGORIES:"categories"},Ee=async()=>{var t;console.log("Fetching products...");try{const r=O.get(ue.PRODUCTS,te.PRODUCTS_TTL);if(r)return console.log("Using cached products data"),r;console.log("No cached products, fetching from API...");const{options:s,clearTimeout:n}=L("GET",void 0,H.PRODUCTS);try{const o=await fetch(`${B}/stock/in-stock`,s);if(n(),!o.ok){const l=await o.text();let i;try{i=JSON.parse(l).detail||l}catch{i=l||`HTTP error ${o.status}`}throw new Error(i)}const a=await o.text(),c=JSON.parse(a);if(console.log("Products fetched successfully, count:",((t=c.items)==null?void 0:t.length)||0),!c.items||!Array.isArray(c.items))return console.error("API returned invalid products data"),w.error("Invalid products data received from API"),je;const m=c.items.map(l=>{const i=typeof l.price_rub=="string"?parseFloat(l.price_rub.replace(/[^\d.-]/g,"")):Number(l.price_rub),h=Array.isArray(l.photos)?l.photos:[],d=Array.isArray(l.sizes)?l.sizes.map(u=>({...u,quantity:typeof u.quantity=="string"?parseInt(u.quantity,10):u.quantity})):[];return{...l,price_rub:isNaN(i)?0:i,photos:h,sizes:d}});return O.set(ue.PRODUCTS,m),m}catch(o){return console.error("Error fetching products:",o),w.error(`Error loading products: ${o.message}`),je}}catch(r){return console.error("Error in fetchProducts:",r),w.error(`Error: ${r.message}`),je}},Me=async()=>{var t;console.log("Fetching categories...");try{const r=O.get(ue.CATEGORIES,te.PRODUCTS_TTL);if(r)return console.log("Using cached categories data"),r;console.log("No cached categories, fetching from API...");const{options:s,clearTimeout:n}=L("GET",void 0,H.PRODUCTS);try{const o=await fetch(`${B}/stock/get-categories`,s);if(n(),!o.ok){const m=await o.text();let l;try{l=JSON.parse(m).detail||m}catch{l=m||`HTTP error ${o.status}`}throw new Error(l)}const a=await o.text(),c=JSON.parse(a);return console.log("Categories fetched successfully, count:",((t=c.categories)==null?void 0:t.length)||0),!c.categories||!Array.isArray(c.categories)?(console.error("API returned invalid categories data"),w.error("Invalid categories data received from API"),[]):(O.set(ue.CATEGORIES,c.categories),c.categories)}catch(o){throw console.error("Error fetching categories:",o),o}}catch(r){return console.error("Failed to fetch categories:",r),Fr("Failed to fetch categories"),[]}},Vr={ORDERS:t=>`orders_${t}`},He=async()=>{try{const t=R();if(!t||!t.id)return console.error("No user data available when fetching orders"),[];console.log(`Fetching orders for user ID: ${t.id}...`);const r=Vr.ORDERS(t.id),s=O.get(r,te.ORDERS_TTL);if(s)return console.log("Using cached orders data"),s;console.log("No cached orders, fetching from API...");const n={telegram_user_id:t.id},{options:o,clearTimeout:a}=L("POST",n,H.ORDERS);try{const c=await fetch(`${B}/users/orders`,o);if(a(),c.status===404)return console.log("User has no orders or not found in orders API"),O.set(r,[]),[];if(!c.ok){const i=await c.text();let h;try{h=JSON.parse(i).detail||i}catch{h=i||`HTTP error ${c.status}`}throw new Error(h)}const m=await c.text(),l=JSON.parse(m);return console.log("Orders fetched successfully:",l),!l.orders||!Array.isArray(l.orders)?(console.error("API returned invalid orders data"),[]):(O.set(r,l.orders),l.orders)}catch(c){return console.error("Error fetching orders:",c),c.message.includes("User not found")||w.error(`Error fetching orders: ${c.message}`),[]}}catch(t){return console.error("Error in fetchOrders:",t),t.message.includes("User not found")||w.error(`Error: ${t.message}`),[]}},Yr=async(t,r)=>{try{return console.log(`[MOCK API] Added product to cart - Product ID: ${t}, Size: ${r}`),!0}catch(s){return console.error("Error adding product to cart:",s),!1}},Qr=async(t,r,s)=>{try{const o={price_cny:t,shipping_type:r==="car"?"cargo":r==="plane"?"aero":r,category:s};console.log("Shipping calculation request:",o);const{options:a,clearTimeout:c}=L("POST",o,H.PRODUCTS),m=await fetch(`${B}/orders/calculate-shipping`,a);if(c(),console.log(`Response status: ${m.status} ${m.statusText}`),!m.ok){const i=await m.json().catch(()=>null);throw console.error("API response not OK:",m.status,m.statusText),console.error("Error data:",i),new Error(`Failed to calculate shipping: ${(i==null?void 0:i.message)||m.statusText}`)}const l=await m.json();return console.log("Shipping calculation response:",l),l.shipping_cost}catch(n){throw console.error("Error calculating shipping:",n),new Error(`Error calculating shipping: ${n.message}`)}},Xr=async t=>{var r;try{if(!((r=t.items)!=null&&r.length))throw new Error("Order must contain at least one item");const s=t.items.map(l=>{if(l.item_type==="preorder"){if(!l.dewu_url)throw new Error("Preorder item must have a URL");if(!l.category_type)throw new Error("Preorder item must have a category type");if(!l.shipping_type)throw new Error("Preorder item must have a shipping type");if(!l.price_cny)throw new Error("Preorder item must have a price in CNY");const i=["shirt","clothes","accessories","sneakers"];if(!i.includes(l.category_type))throw new Error(`Invalid category type for preorder. Must be one of: ${i.join(", ")}`);const h=["cargo","aero"];if(!h.includes(l.shipping_type))throw new Error(`Invalid shipping type for preorder. Must be one of: ${h.join(", ")}`);return{item_type:"preorder",dewu_url:l.dewu_url,size:l.size||"",price_cny:l.price_cny,category_type:l.category_type,shipping_type:l.shipping_type,quantity:l.quantity||1}}else{if(l.stock_id)return{item_type:"stock",stock_id:l.stock_id};if(!l.sku)throw new Error("Stock item must have a SKU");return{item_type:"stock",sku:l.sku,size:l.size||"",quantity:l.quantity||1}}});if((t.delivery_method==="courier"||t.delivery_method==="shipping")&&!t.delivery_address)throw new Error("Delivery address is required for courier or shipping delivery method");const n={telegram_user_id:t.telegram_user_id,items:s,delivery_method:t.delivery_method,delivery_address:t.delivery_address||"",promocode_text:t.promocode_text,dd_coins_amount:t.dd_coins_amount,final_price:t.final_price};console.log("Sending unified order request:",JSON.stringify(n,null,2));const{options:o,clearTimeout:a}=L("POST",n),c=await fetch(`${B}/orders/create-order`,o);if(a(),!c.ok){const l=await c.text();let i;try{i=JSON.parse(l).detail||l}catch{i=l}throw new Error(i)}return await c.json()}catch(s){throw console.error("Error creating unified order:",s),s}},It=async()=>{try{const{options:t,clearTimeout:r}=L("GET",void 0,H.PRODUCTS),s=await fetch(`${B}/orders/delivery-types`,t);if(r(),!s.ok){const o=await s.json().catch(()=>null);throw console.error("API response not OK:",s.status,s.statusText),console.error("Error data:",o),new Error(`Failed to fetch delivery types: ${(o==null?void 0:o.message)||s.statusText}`)}return(await s.json()).delivery_types||[]}catch(t){throw console.error("Error fetching delivery types:",t),t}},Te=async t=>{try{const r=R(),s=t||(r?r.id:null);if(!s)return console.error("No Telegram user ID available for client info"),w.error("User data not available"),null;console.log(`Fetching client info for Telegram ID: ${s}`);const{options:n,clearTimeout:o}=L("GET"),a=await fetch(`${B}/clients/by-telegram/${s}`,n);if(o(),!a.ok){if(a.status===404)return console.log("Client info not found (404)"),null;const l=await a.text();return console.error(`API Error (${a.status}): ${l}`),w.error("Failed to fetch client information"),null}const c=await a.text(),m=JSON.parse(c);return console.log("Client info fetched:",m),m}catch(r){return console.error("Error fetching client info:",r),w.error("Failed to fetch client information"),null}},Zr=async(t,r,s)=>{try{const n=R();if(!n)return console.error("No Telegram user data available"),w.error("User data not available"),!1;console.log(`Updating client info for Telegram ID: ${n.id}`);const o={telegram_id:n.id};t&&(o.phone_number=t),r&&(o.email=r),s&&(o.address=s),console.log("Update client info request:",o);const{options:a,clearTimeout:c}=L("POST",o),m=await fetch(`${B}/clients/update-info`,a);if(c(),m.ok)return console.log(`Client info update successful with status: ${m.status}`),w.success("Client information updated successfully"),!0;{const l=await m.text();return console.error(`API Error (${m.status}): ${l}`),w.error("Failed to update client information"),!1}}catch(n){return console.error("Error updating client info:",n),w.error("Failed to update client information"),!1}},ge=`${B}/referrals`,Ue=async(t=0)=>{try{const r=R();if(!r)return console.error("No Telegram user data available"),w.error("User data not available"),null;console.log(`Getting referral info for Telegram ID: ${r.id}`);const{options:s,clearTimeout:n}=L("GET"),o=await fetch(`${ge}/info/${r.id}`,s);if(n(),!o.ok){const m=await o.text();if(console.error(`API Error (${o.status}): ${m}`),o.status===404){console.log("No referral code found, creating one...");const l=await et();if(l)return l;if(t===0)return console.log("Retrying to get referral info after creation..."),Ue(1)}return(t>0||o.status!==404)&&w.error("Failed to fetch referral information"),null}const a=await o.text(),c=JSON.parse(a);return console.log("Referral info fetched:",c),c}catch(r){return console.error("Error fetching referral info:",r),t===0?(console.log("Retrying to get referral info after error..."),Ue(1)):(w.error("Failed to fetch referral information"),null)}},et=async()=>{try{const t=R();if(!t)return console.error("No Telegram user data available"),w.error("User data not available"),null;console.log(`Creating referral code for Telegram ID: ${t.id}`);const{options:r,clearTimeout:s}=L("POST",{telegram_id:t.id}),n=await fetch(`${ge}/create`,r);if(s(),!n.ok){const c=await n.text();return console.error(`API Error (${n.status}): ${c}`),w.error("Failed to create referral code"),null}const o=await n.text(),a=JSON.parse(o);return console.log("Referral code created:",a),a}catch(t){return console.error("Error creating referral code:",t),w.error("Failed to create referral code"),null}},$t=async()=>{try{const t=R();if(!t)return console.error("No Telegram user data available"),w.error("User data not available"),null;console.log(`Getting referral stats for Telegram ID: ${t.id}`);const{options:r,clearTimeout:s}=L("GET"),n=await fetch(`${ge}/stats/${t.id}`,r);if(s(),!n.ok){const c=await n.text();return console.error(`API Error (${n.status}): ${c}`),w.error("Failed to fetch referral statistics"),null}const o=await n.text(),a=JSON.parse(o);return console.log("Referral stats fetched:",a),a}catch(t){return console.error("Error fetching referral stats:",t),w.error("Failed to fetch referral statistics"),null}},Ot=async t=>{try{return navigator.share?(await navigator.share({title:"Join me on DD Store",text:"Use my referral link to join DD Store",url:t.telegram_deep_link}),w.success("Referral link shared successfully"),!0):(await navigator.clipboard.writeText(t.telegram_deep_link),w.success("Referral link copied to clipboard"),!0)}catch(r){console.error("Error sharing referral link:",r);try{return await navigator.clipboard.writeText(t.telegram_deep_link),w.success("Referral link copied to clipboard"),!0}catch{return w.error("Failed to share referral link"),!1}}},rt=async t=>{try{const r=R();if(!r)return console.error("No Telegram user data available"),!1;console.log(`Registering referral for user ${r.id} with code ${t}`);const{options:s,clearTimeout:n}=L("POST",{telegram_id:r.id,referral_code:t}),o=await fetch(`${ge}/register`,s);if(n(),!o.ok){const m=await o.text();return console.error(`API Error (${o.status}): ${m}`),!1}const a=await o.text(),c=JSON.parse(a);return console.log("Referral registration result:",c),c.success}catch(r){return console.error("Error registering referral:",r),!1}},Ke=async t=>{console.log("Fetching initial data in parallel...");try{const r=await Promise.allSettled([qe(t),He(),Ee()]),s=r[0].status==="fulfilled"?r[0].value:null,n=r[1].status==="fulfilled"?r[1].value:[],o=r[2].status==="fulfilled"?r[2].value:[];return r[0].status==="rejected"&&console.error("Failed to fetch profile:",r[0].reason),r[1].status==="rejected"&&console.error("Failed to fetch orders:",r[1].reason),r[2].status==="rejected"&&console.error("Failed to fetch products:",r[2].reason),{profile:s,orders:n,products:o}}catch(r){return console.error("Error in parallel fetch:",r),w.error("Error loading data. Some features may be limited."),{profile:null,orders:[],products:[]}}},tt=async t=>{try{Ke(t).then(()=>console.log("Background prefetch completed")).catch(r=>console.error("Background prefetch failed:",r));return}catch(r){console.error("Error starting prefetch:",r)}},st=async t=>{try{const r=`profile_${t}`,s=`orders_${t}`,n=`rank_${t}`;O.invalidate(r),O.invalidate(s),O.invalidate(n),O.invalidate("products"),await Ke(t),w.success("Data refreshed successfully")}catch(r){console.error("Error refreshing data:",r),w.error("Failed to refresh data")}},Ge=g.createContext(void 0),ot=({children:t})=>{const[r,s]=g.useState(null),[n,o]=g.useState(""),[a,c]=g.useState(""),[m,l]=g.useState(null),[i,h]=g.useState(zr()),[d,u]=g.useState(!0),[f,k]=g.useState(!1),j=g.useCallback(x=>{if(!x)return;console.log("Updating Telegram user data:",x),s(x),x.username?o(x.username):o(`user_${x.id}`);let v=x.first_name;x.last_name&&(v+=` ${x.last_name}`),c(v);try{localStorage.setItem("telegramUser",JSON.stringify(x)),localStorage.getItem("telegramUserData")&&localStorage.removeItem("telegramUserData")}catch{console.warn("Failed to store user data in localStorage")}const E=x.username||`user_${x.id}`;tt(E,x.id).then(()=>{N(E,x.id)}).catch(D=>{console.error("Error during prefetch:",D),N(E,x.id)})},[]),N=g.useCallback(async(x,v)=>{try{console.log("Checking user profile...");const E=await qe(x,v);console.log("User profile loaded"),l(E)}catch(E){console.error("Error fetching user profile:",E);const D={telegram_username:x,rank:1,total_orders:0};console.log("Using default profile"),l(D)}},[]),C=g.useCallback(async()=>{try{if(u(!0),r){const x=r.username||`user_${r.id}`;await st(x,r.id),await N(x,r.id)}else w.error("No user data available for refresh")}catch(x){console.error("Error refreshing user data:",x),w.error(`Error refreshing data: ${x.message}`)}finally{u(!1)}},[r,N]);return g.useCallback(()=>{if(console.log("DEBUG - RAW TELEGRAM DATA:"),window.Telegram)if(console.log("window.Telegram exists"),window.Telegram.WebApp){if(console.log("window.Telegram.WebApp exists"),console.log("initData:",window.Telegram.WebApp.initData),window.Telegram.WebApp.initDataUnsafe)if(console.log("initDataUnsafe contents:",JSON.stringify(window.Telegram.WebApp.initDataUnsafe||{},null,2)),window.Telegram.WebApp.initDataUnsafe.user){const x=window.Telegram.WebApp.initDataUnsafe.user;return console.log("RAW USER OBJECT:",x),x}else console.log("No user data in initDataUnsafe");else console.log("No initDataUnsafe available");if(window.Telegram.WebApp.initData)try{const x=new URLSearchParams(window.Telegram.WebApp.initData);if(console.log("Parsed initData params:",Array.from(x.entries())),x.has("user"))try{const v=JSON.parse(decodeURIComponent(x.get("user")||"{}"));return console.log("User data parsed from initData:",v),v}catch(v){console.error("Error parsing user data from initData:",v)}else console.log("No user param in initData")}catch(x){console.error("Error parsing initData:",x)}else console.log("initData is empty")}else console.log("No WebApp in Telegram object");else console.log("No Telegram object in window");return null},[]),g.useEffect(()=>{if(f)return;(async()=>{try{u(!0),k(!0),console.log("Initializing user data...");const v=me();if(v){console.log("User data retrieved from Telegram WebApp:",v),j(v),u(!1);return}try{const E=localStorage.getItem("telegramUser")||localStorage.getItem("telegramUserData");if(E){const D=JSON.parse(E);console.log("Using stored user data:",D),j(D),u(!1);return}}catch{console.warn("Failed to retrieve user data from localStorage")}try{const E=await R();if(E){console.log("User data retrieved from API:",E),j(E),u(!1);return}}catch(E){console.error("Error getting user data from API:",E)}console.log("No user data available, using default values"),o("guest"),c("Guest User"),u(!1)}catch(v){console.error("Error initializing user data:",v),o("guest"),c("Guest User"),u(!1)}})()},[j,f]),e.jsx(Ge.Provider,{value:{username:n,displayName:a,telegramUser:r,profile:m,avatarEmoji:i,loading:d,setUsername:o,setAvatarEmoji:h,updateTelegramUser:j,refreshUserData:C},children:t})},pe=()=>{const t=g.useContext(Ge);if(t===void 0)throw new Error("useUser must be used within a UserProvider");return t},Ve=g.createContext(void 0),at=({children:t})=>{const[r,s]=g.useState([]),n=r.reduce((d,u)=>d+u.quantity,0),o=r.reduce((d,u)=>d+u.price*u.quantity,0);g.useEffect(()=>{const d=localStorage.getItem("cart");if(d)try{s(JSON.parse(d))}catch(u){console.error("Failed to parse cart from localStorage:",u)}},[]),g.useEffect(()=>{localStorage.setItem("cart",JSON.stringify(r))},[r]);const a=(d,u)=>{s(f=>{const k=f.findIndex(j=>j.productId===d.id&&j.size===u);if(k>=0){const j=[...f];return j[k].quantity+=1,j}else return[...f,{productId:d.id,name:d.name,color:d.color,size:u,price:d.price,quantity:1,item_type:"stock",photo_url:d.photo_url}]})},c=d=>{const u=`preorder-${btoa(d.dewu_url)}-${d.size}`;s(f=>{const k=f.findIndex(j=>j.productId===u);if(k>=0){const j=[...f];return j[k].quantity+=1,j}else return[...f,{productId:u,name:d.name,color:"",size:d.size,price:d.price,quantity:1,item_type:"preorder",dewu_url:d.dewu_url,category_type:d.category_type,delivery_type:d.delivery_type,shipping_type:d.shipping_type,price_cny:d.price_cny,photo_url:d.photo_url}]})},m=(d,u)=>{s(f=>{const k=f.findIndex(j=>j.productId===d&&j.size===u);if(k>=0){const j=[...f];return j[k].quantity>1?j[k].quantity-=1:j.splice(k,1),j}return f})},l=(d,u,f)=>{s(k=>{const j=k.findIndex(N=>N.productId===d&&N.size===u);if(j>=0){const N=[...k];return f<=0?N.splice(j,1):N[j].quantity=f,N}else f>0&&console.warn("Attempted to update quantity for non-existent item");return k})},i=(d,u)=>{const f=r.find(k=>k.productId===d&&k.size===u);return f?f.quantity:0},h=()=>{s([]),w.info("Cart cleared")};return e.jsx(Ve.Provider,{value:{items:r,addToCart:a,addPreorderToCart:c,removeFromCart:m,clearCart:h,itemCount:n,totalPrice:o,updateQuantity:l,getItemQuantity:i},children:t})},he=()=>{const t=g.useContext(Ve);if(t===void 0)throw new Error("useCart must be used within a CartProvider");return t},nt=()=>{const[t,r]=g.useState(null),[s,n]=g.useState(!1),[o,a]=g.useState(!1);return g.useEffect(()=>{(()=>{try{const m=new URL(window.location.href),l=m.searchParams.get("ref"),i=m.searchParams.get("start");if(i&&i.startsWith("ref_")){const d=i.substring(4);if(d){console.log("Referral code detected from Telegram deep link:",d),r(d),m.searchParams.delete("start"),window.history.replaceState({},document.title,m.toString());return}}const h=window.location.pathname.split("/");if(h.length>=3&&h[1]==="ref"){const d=h[2];if(d){console.log("Referral code detected from path:",d),r(d);const u=window.location.pathname.replace(/\/ref\/[^\/]+/,"");window.history.replaceState({},document.title,u+window.location.search);return}}l&&(console.log("Referral code detected from query parameter:",l),r(l),m.searchParams.delete("ref"),window.history.replaceState({},document.title,m.toString()))}catch(m){console.error("Error detecting referral code:",m)}})()},[]),g.useEffect(()=>{(async()=>{if(!(!t||o||s)){n(!0);try{const m=JSON.parse(localStorage.getItem("processedReferrals")||"[]");if(m.includes(t)){console.log("Referral already processed:",t),a(!0),n(!1);return}await rt(t)&&(console.log("Referral registered successfully"),m.push(t),localStorage.setItem("processedReferrals",JSON.stringify(m))),a(!0)}catch(m){console.error("Error processing referral:",m)}finally{n(!1)}}})()},[t,o,s]),{referralCode:t,isProcessing:s,isProcessed:o}},ve=async t=>{try{const r=await fetch("https://v2786182.hosted-by-vdsina.ru/api/v1/users/dd-coins",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({telegram_user_id:t,reason_code:"WELCOME"})});if(!r.ok){const n=await r.text();return console.error(`Error adding DD coins: ${n}`),!1}const s=await r.json();return console.log("DD coins added successfully:",s),!0}catch(r){return console.error("Error adding DD coins:",r),!1}},ke=()=>{setTimeout(()=>{const t=document.createElement("div");t.className="fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-black text-white p-6 rounded-lg shadow-lg z-50 w-80 text-center",t.innerHTML=`
      <div class="flex flex-col items-center">
        <div class="text-yellow-400 text-xl mb-2">🎁 Welcome Bonus!</div>
        <div class="text-lg font-bold mb-2">500 DD Coins Added</div>
        <div class="text-sm">Your welcome bonus has been added to your account.</div>
      </div>
    `,document.body.appendChild(t),setTimeout(()=>{t.classList.add("opacity-0","transition-opacity","duration-500"),setTimeout(()=>{document.body.removeChild(t)},500)},4e3)},1500)},lt=t=>{const[r,s]=g.useState(!1),[n,o]=g.useState(!1),[a,c]=g.useState(!1);return g.useEffect(()=>{(async()=>{if(!(a||n)){o(!0);try{const l=R();if(!l){console.log("No Telegram user available, cannot check registration status"),o(!1);return}const i=await de(!0);if(console.log("User check response:",i),i&&typeof i=="object"){const h=i;h.status==="created"?(console.log("New user created"),s(!0),t!=null&&t.onNewUser&&t.onNewUser(!0),await ve(l.id)&&(w.success("Welcome! 500 DD coins have been added to your account as a welcome bonus!",{duration:6e3,position:"top-center"}),ke())):h.status==="updated"?(console.log("User updated"),await ve(l.id)&&(w.success("Welcome back! 500 DD coins have been added to your account!",{duration:6e3,position:"top-center"}),ke())):s(!1)}else i===!1?(console.log("New user detected (boolean response)"),s(!0),t!=null&&t.onNewUser&&t.onNewUser(!0),await ve(l.id)&&(w.success("Welcome! 500 DD coins have been added to your account as a welcome bonus!",{duration:6e3,position:"top-center"}),ke())):s(!1);c(!0)}catch(l){console.error("Error checking user registration:",l)}finally{o(!1)}}})()},[a,n,t]),{isNewUser:r,isChecking:n,hasChecked:a}},it="/dd-app-v1/assets/main_banner-BLatjzmT.png",ct="/dd-app-v1/assets/cs_banner-C6be43yD.png",dt="/dd-app-v1/assets/shop_banner-CySva41V.png",ut=()=>{const{username:t,displayName:r,telegramUser:s,avatarEmoji:n,updateTelegramUser:o}=pe(),a=X();g.useEffect(()=>{(async()=>{try{We();const h=me();h&&(console.log("Telegram user found on Home page:",h),o(h))}catch(h){console.error("Error initializing Telegram on Home page:",h)}})()},[o]);const c=[{image:it,link:"/calculator"},{image:ct,link:"/shop?brand=Cat%26Sofa"}],m=(s==null?void 0:s.username)||t,l=i=>{i.preventDefault(),Y(),a("/profile")};return e.jsxs(q,{fullHeight:!0,className:"p-4",children:[e.jsx("header",{className:"mb-6",children:e.jsxs(M,{to:"/profile",className:"flex items-center gap-3 hover:opacity-90 transition-opacity",onClick:l,children:[e.jsx(Re,{user:s,emoji:n,size:"md",className:"hover-lift"}),e.jsxs("div",{children:[e.jsxs("h1",{className:"text-2xl font-semibold",children:["Welcome, ",r]}),m&&e.jsxs("p",{className:"text-gray-600 dark:text-gray-400",children:["@",m]})]})]})}),e.jsx("section",{className:"mb-8 animate-slide-up",children:e.jsx(jr,{banners:c})}),e.jsxs("section",{className:"grid grid-cols-2 gap-4 mb-8",children:[e.jsx(M,{to:"/shop",className:"bg-cover bg-center rounded-lg p-4 h-full col-span-1 shadow-sm hover-lift flex flex-col justify-end",style:{backgroundImage:`url(${dt})`},children:e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("h3",{className:"text-xl font-medium text-white",children:"Заказать"}),e.jsx(xe,{size:20,className:"text-white"})]})}),e.jsxs("div",{className:"col-span-1 space-y-4",children:[e.jsxs("div",{className:"bg-telegram-blue text-white dark:bg-telegram-blue rounded-lg p-4 shadow-sm hover-lift flex flex-col justify-between",children:[e.jsx("h3",{className:"font-medium",children:"DD coin's"}),e.jsx("div",{className:"text-4xl font-bold mb-1",children:"5300"}),e.jsx("p",{className:"text-xs text-white/80",children:"Баланс и реферальная программа"}),e.jsx("div",{className:"flex justify-end mt-1",children:e.jsx(xe,{size:20,className:"text-white/70"})})]}),e.jsx("div",{className:"bg-white dark:bg-sidebar-accent/50 rounded-lg p-4 shadow-sm hover-lift",children:e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"font-medium",children:"DD manager"}),e.jsx("p",{className:"text-xs text-gray-600 dark:text-gray-400",children:"Поможет определиться с цветом и размером"})]}),e.jsx("div",{className:"flex items-center justify-center",children:e.jsx(xe,{size:20,className:"text-gray-500 dark:text-gray-400"})})]})})]})]}),e.jsxs("section",{className:"mb-8",children:[e.jsx("h2",{className:"text-xl font-medium mb-4",children:"Featured Categories"}),e.jsxs("div",{className:"grid grid-cols-2 gap-4 mb-12",children:[e.jsxs(M,{to:"/shop?category=sneakers",className:"bg-telegram-button dark:bg-telegram-dark rounded-lg p-6 text-center hover-lift",children:[e.jsx("span",{className:"text-3xl",children:"👟"}),e.jsx("h3",{className:"mt-2 font-medium text-white",children:"Кроссовки"})]}),e.jsxs(M,{to:"/shop?category=tops",className:"bg-telegram-blue dark:bg-telegram-blue/90 rounded-lg p-6 text-center hover-lift",children:[e.jsx("span",{className:"text-3xl",children:"👕"}),e.jsx("h3",{className:"mt-2 font-medium text-white",children:"Верх"})]}),e.jsxs(M,{to:"/shop?category=bottoms",className:"bg-telegram-blue/80 dark:bg-telegram-dark/80 rounded-lg p-6 text-center hover-lift",children:[e.jsx("span",{className:"text-3xl",children:"👖"}),e.jsx("h3",{className:"mt-2 font-medium text-white",children:"Низ"})]}),e.jsxs(M,{to:"/shop?category=accessories",className:"bg-telegram-button/90 dark:bg-telegram-button/80 rounded-lg p-6 text-center hover-lift",children:[e.jsx("span",{className:"text-3xl",children:"🧢"}),e.jsx("h3",{className:"mt-2 font-medium text-white",children:"Аксессуары"})]})]})]})]})},mt=()=>{const[t,r]=tr();X();const[s,n]=g.useState(""),[o,a]=g.useState([]),[c,m]=g.useState([]),[l,i]=g.useState([]),[h,d]=g.useState(!1),{itemCount:u}=he(),{data:f,isLoading:k,error:j,isError:N,refetch:C}=le({queryKey:["products"],queryFn:Ee,staleTime:5*60*1e3,retry:1,retryDelay:1e3});le({queryKey:["categories"],queryFn:Me,staleTime:5*60*1e3,retry:1,retryDelay:1e3}),g.useEffect(()=>{const p=t.get("brand"),y=t.get("category"),b=t.get("size"),A=t.get("search");p&&m(p.split(",")),y&&i(y.split(",")),b&&a(b.split(",")),A&&n(A)},[t]),g.useEffect(()=>{const p=new URLSearchParams;c.length>0&&p.set("brand",c.join(",")),l.length>0&&p.set("category",l.join(",")),o.length>0&&p.set("size",o.join(",")),s&&p.set("search",s),p.toString()!==t.toString()&&r(p)},[c,l,o,s,r,t]),g.useEffect(()=>{N&&j instanceof Error&&w.error(`Shop error: ${j.message}`)},[N,j]);const x=g.useMemo(()=>{if(!f)return[];const p=new Set;return f.forEach(y=>{Array.isArray(y.sizes)&&y.sizes.forEach(b=>{b.quantity>0&&p.add(b.size)})}),Array.from(p).sort()},[f]),v=g.useMemo(()=>{if(!f)return[];const p=new Set;return f.forEach(y=>{y.brand&&p.add(y.brand)}),Array.from(p).sort()},[f]),E=g.useMemo(()=>{if(!f)return[];const p=new Set;return f.forEach(y=>{y.category&&p.add(y.category)}),Array.from(p).sort()},[f]),D=p=>{a(y=>y.includes(p)?y.filter(b=>b!==p):[...y,p])},_=p=>{m(y=>y.includes(p)?y.filter(b=>b!==p):[...y,p])},U=p=>{i(y=>y.includes(p)?y.filter(b=>b!==p):[...y,p])},W=g.useMemo(()=>f?f.filter(p=>{const y=s===""||p.item_name.toLowerCase().includes(s.toLowerCase())||p.color_code.toLowerCase().includes(s.toLowerCase())||p.brand&&p.brand.toLowerCase().includes(s.toLowerCase()),b=o.length===0||Array.isArray(p.sizes)&&p.sizes.some(S=>o.includes(S.size)&&S.quantity>0),A=c.length===0||p.brand&&c.includes(p.brand),T=l.length===0||p.category&&l.includes(p.category);return y&&b&&A&&T}):[],[f,s,o,c,l]),K=()=>{a([]),m([]),i([]),n("")},G=p=>{a(y=>y.filter(b=>b!==p))},J=p=>{m(y=>y.filter(b=>b!==p))},I=p=>{i(y=>y.filter(b=>b!==p))},$=o.length>0||c.length>0||l.length>0||s.length>0;return e.jsx(q,{children:e.jsxs("div",{className:"p-4",children:[e.jsxs("header",{className:"mb-6",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h1",{className:"text-2xl font-semibold",children:"Shop"}),e.jsxs(M,{to:"/cart",className:"relative flex items-center justify-center w-10 h-10 bg-telegram-button text-white rounded-full hover:bg-telegram-button/90 transition-colors","aria-label":"View Cart",children:[e.jsx(ie,{size:20,className:"text-white"}),u>0&&e.jsx("span",{className:"absolute -top-1 -right-1 bg-red-500 text-white text-xs font-bold w-5 h-5 flex items-center justify-center rounded-full",children:u})]})]}),e.jsxs("div",{className:"relative mb-4",children:[e.jsx("div",{className:"absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none",children:e.jsx(_e,{size:20,className:"text-telegram-hint"})}),e.jsx("input",{type:"text",placeholder:"Search products...",className:"w-full p-3 pl-10 pr-4 border border-telegram-hint/30 rounded-lg bg-telegram-bg text-telegram-text focus:outline-none focus:ring-2 focus:ring-telegram-button focus:border-transparent",value:s,onChange:p=>n(p.target.value)})]}),e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("button",{className:"flex items-center gap-2 text-sm text-telegram-text",onClick:()=>d(!h),children:[e.jsx(sr,{size:18,className:"text-telegram-hint"}),e.jsx("span",{children:h?"Hide filters":"Show filters"})]}),$&&e.jsxs("button",{className:"flex items-center gap-1 text-xs text-red-500",onClick:K,children:[e.jsx(Z,{size:14}),e.jsx("span",{children:"Clear filters"})]})]}),$&&e.jsxs("div",{className:"flex flex-wrap gap-2 mb-4",children:[o.map(p=>e.jsxs("span",{className:"inline-flex items-center gap-1 px-2 py-1 bg-telegram-light text-telegram-blue text-xs rounded-full",children:[e.jsx(ye,{size:12}),"Size: ",p,e.jsx("button",{className:"ml-1",onClick:()=>G(p),children:e.jsx(Z,{size:12})})]},`filter-size-${p}`)),c.map(p=>e.jsxs("span",{className:"inline-flex items-center gap-1 px-2 py-1 bg-telegram-light text-telegram-blue text-xs rounded-full",children:[e.jsx(ye,{size:12}),"Brand: ",p,e.jsx("button",{className:"ml-1",onClick:()=>J(p),children:e.jsx(Z,{size:12})})]},`filter-brand-${p}`)),l.map(p=>e.jsxs("span",{className:"inline-flex items-center gap-1 px-2 py-1 bg-telegram-light text-telegram-blue text-xs rounded-full",children:[e.jsx(ye,{size:12}),"Category: ",p,e.jsx("button",{className:"ml-1",onClick:()=>I(p),children:e.jsx(Z,{size:12})})]},`filter-category-${p}`)),s&&e.jsxs("span",{className:"inline-flex items-center gap-1 px-2 py-1 bg-telegram-light text-telegram-blue text-xs rounded-full",children:[e.jsx(_e,{size:12}),'"',s,'"',e.jsx("button",{className:"ml-1",onClick:()=>n(""),children:e.jsx(Z,{size:12})})]})]}),h&&e.jsxs("div",{className:"mb-4 p-4 bg-telegram-secondary-bg rounded-lg animate-slide-down space-y-4",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-sm font-medium mb-2 text-telegram-text",children:"Filter by Size (Select Multiple)"}),e.jsx("div",{className:"flex flex-wrap gap-2",children:x.map(p=>e.jsx("button",{className:`px-3 py-1 text-sm rounded-full border transition-colors ${o.includes(p)?"bg-telegram-button text-telegram-button-text border-telegram-button":"bg-telegram-bg text-telegram-text border-telegram-hint/30 hover:border-telegram-hint/50"}`,onClick:()=>D(p),children:p},p))})]}),v.length>0&&e.jsxs("div",{children:[e.jsx("h3",{className:"text-sm font-medium mb-2 text-telegram-text",children:"Filter by Brand (Select Multiple)"}),e.jsx("div",{className:"flex flex-wrap gap-2",children:v.map(p=>e.jsx("button",{className:`px-3 py-1 text-sm rounded-full border transition-colors ${c.includes(p)?"bg-telegram-button text-telegram-button-text border-telegram-button":"bg-telegram-bg text-telegram-text border-telegram-hint/30 hover:border-telegram-hint/50"}`,onClick:()=>_(p),children:p},p))})]}),E.length>0&&e.jsxs("div",{children:[e.jsx("h3",{className:"text-sm font-medium mb-2 text-telegram-text",children:"Filter by Category (Select Multiple)"}),e.jsx("div",{className:"flex flex-wrap gap-2",children:E.map(p=>e.jsx("button",{className:`px-3 py-1 text-sm rounded-full border transition-colors ${l.includes(p)?"bg-telegram-button text-telegram-button-text border-telegram-button":"bg-telegram-bg text-telegram-text border-telegram-hint/30 hover:border-telegram-hint/50"}`,onClick:()=>U(p),children:p},p))})]})]})]}),N&&e.jsxs("div",{className:"p-3 bg-red-50 border border-red-300 rounded-lg mb-4",children:[e.jsx("h3",{className:"text-sm font-medium text-red-700",children:"Error Loading Products:"}),e.jsx("p",{className:"text-xs text-red-600",children:j instanceof Error?j.message:"Unknown error"})]}),k?e.jsx("div",{className:"flex justify-center items-center h-64",children:e.jsx(Se,{size:"lg"})}):N?e.jsxs("div",{className:"text-center py-10",children:[e.jsx("h2",{className:"text-lg font-medium text-red-600 mb-2",children:"Error loading products"}),e.jsx("p",{className:"text-gray-600 mb-4",children:"Please try again later"}),e.jsx("button",{className:"px-4 py-2 bg-telegram-blue text-white rounded-lg",onClick:()=>C(),children:"Retry"})]}):W.length===0?e.jsxs("div",{className:"text-center py-10",children:[e.jsx("h2",{className:"text-lg font-medium text-gray-700",children:"No products found"}),e.jsx("p",{className:"text-gray-500 mt-2",children:"Try changing your filters or search term"}),$&&e.jsx("button",{className:"mt-4 px-4 py-2 bg-telegram-blue text-white rounded-lg",onClick:K,children:"Clear all filters"})]}):e.jsx("div",{className:"grid grid-cols-2 gap-4",children:W.map(p=>e.jsx(vr,{product:p,className:"animate-fade-in"},p.sku))})]})})},gt=()=>{const{productId:t}=or(),r=X(),{addToCart:s,updateQuantity:n,getItemQuantity:o}=he(),[a,c]=g.useState(""),{data:m,isLoading:l,error:i,isError:h,refetch:d}=le({queryKey:["products"],queryFn:Ee,staleTime:5*60*1e3,retry:1,retryDelay:1e3}),u=m==null?void 0:m.find(_=>_.sku===t),f=g.useMemo(()=>u?Array.isArray(u.sizes)?u.sizes.filter(_=>_.quantity>0).map(_=>_.size):[]:[],[u]);g.useEffect(()=>{f.length>0&&!a&&c(f[0])},[f,a]);const k=u?Br(`${u.item_name}-${u.color_code}`,"product"):"📦",j=g.useMemo(()=>!u||!a?0:o(u.sku,a),[u,a,o]),N=g.useMemo(()=>!u||!u.photos?[]:Array.isArray(u.photos)?u.photos.map(_=>typeof _=="string"?_:_.photo_url||"").filter(_=>_):[],[u]),C=g.useMemo(()=>{if(!u||!a)return 0;const _=u.sizes.find(U=>U.size===a);return _?_.quantity:0},[u,a]),x=()=>{if(!u||!a)return;if(j>=C){w.error(`Извините, доступно только ${C} шт. размера ${a}`);return}Y();const _=typeof u.price_rub=="string"?parseFloat(u.price_rub.replace(/[^\d.-]/g,"")):u.price_rub,U={id:u.sku,name:u.item_name,color:u.color_code,sizes:f,price:_,quantity:1};s(U,a),Yr(u.sku,a)},v=()=>{if(!(!u||!a)){if(j>=C){w.error(`Извините, доступно только ${C} шт. размера ${a}`);return}Y(),n(u.sku,a,j+1)}},E=()=>{!u||!a||j<=0||(Y(),n(u.sku,a,j-1))},D=()=>{Y(),r("/cart")};return l?e.jsx(q,{children:e.jsx("div",{className:"flex justify-center items-center h-screen",children:e.jsx(Se,{size:"lg"})})}):h||!u?e.jsx(q,{children:e.jsxs("div",{className:"p-4 text-center",children:[e.jsx("h2",{className:"text-lg font-medium text-red-600 mb-2",children:h?"Ошибка загрузки товара":"Товар не найден"}),e.jsx("p",{className:"text-gray-600 dark:text-gray-400 mb-4",children:h?"Пожалуйста, попробуйте позже":"Этот товар может быть больше не доступен"}),e.jsxs("div",{className:"flex justify-center gap-4",children:[h&&e.jsx("button",{className:"px-4 py-2 bg-telegram-blue text-white rounded-lg",onClick:()=>d(),children:"Повторить"}),e.jsx("button",{className:"px-4 py-2 bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 rounded-lg",onClick:()=>r("/shop"),children:"В магазин"})]})]})}):e.jsx(q,{children:e.jsxs("div",{className:"flex flex-col min-h-screen",children:[e.jsx(kr,{photos:N,productName:u.item_name,fallbackEmoji:k}),e.jsxs("div",{className:"p-4 flex-1",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h1",{className:"text-xl font-bold",children:u.item_name}),e.jsxs(M,{to:"/cart",className:"relative flex items-center justify-center w-10 h-10 bg-telegram-button text-white rounded-full hover:bg-telegram-button/90 transition-colors","aria-label":"View Cart",children:[e.jsx(ie,{size:20,className:"text-white"}),f.reduce((_,U)=>_+o(u.sku,U),0)>0&&e.jsx("span",{className:"absolute -top-1 -right-1 bg-red-500 text-white text-xs font-bold w-5 h-5 flex items-center justify-center rounded-full",children:f.reduce((_,U)=>_+o(u.sku,U),0)})]})]}),e.jsxs("div",{className:"mb-6",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[u.brand&&e.jsx("span",{className:"px-2 py-1 bg-gray-100 dark:bg-gray-800 text-gray-800 dark:text-gray-200 text-xs rounded-full",children:u.brand}),e.jsx("span",{className:"px-2 py-1 bg-telegram-light dark:bg-telegram-dark/20 text-telegram-blue dark:text-telegram-blue text-xs rounded-full",children:u.color_code})]}),e.jsxs("p",{className:"text-lg font-semibold text-telegram-blue",children:["₽",typeof u.price_rub=="string"?parseFloat(u.price_rub.replace(/[^\d.-]/g,"")).toLocaleString():u.price_rub.toLocaleString()]})]}),e.jsxs("div",{className:"mb-6",children:[e.jsx("h2",{className:"font-medium mb-2",children:"Выберите размер"}),e.jsx(Nr,{availableSizes:f,selectedSize:a,onChange:c})]}),e.jsx("div",{className:"mb-6",children:u.description&&e.jsxs(e.Fragment,{children:[e.jsx("h2",{className:"font-medium mb-2",children:"Описание"}),e.jsx("p",{className:"text-gray-700 dark:text-gray-300 text-sm",children:u.description})]})}),e.jsxs("div",{className:"sticky bottom-0 pt-4 pb-2 bg-white dark:bg-sidebar-primary",children:[a&&e.jsxs("div",{className:"mb-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("span",{className:"font-medium",children:["Размер: ",a]}),o(u.sku,a)>0&&e.jsxs("span",{className:"text-sm text-gray-500",children:["В корзине: ",o(u.sku,a)," шт."]})]}),o(u.sku,a)===0?e.jsxs("button",{onClick:x,disabled:!a||f.length===0,className:"w-full py-3 px-4 bg-telegram-blue text-white rounded-lg flex items-center justify-center gap-2 hover:bg-telegram-dark transition-colors disabled:opacity-50 disabled:cursor-not-allowed",children:[e.jsx($e,{size:20}),e.jsx("span",{children:"Добавить в корзину"})]}):e.jsxs("div",{className:"flex items-center justify-between border border-gray-200 dark:border-gray-700 rounded-lg p-1",children:[e.jsx("button",{onClick:E,className:"w-10 h-10 flex items-center justify-center text-telegram-text bg-gray-100 dark:bg-gray-800 rounded-md",children:e.jsx(ar,{size:18})}),e.jsx("span",{className:"font-medium",children:o(u.sku,a)}),e.jsx("button",{onClick:v,className:"w-10 h-10 flex items-center justify-center text-telegram-text bg-gray-100 dark:bg-gray-800 rounded-md",children:e.jsx(nr,{size:18})})]})]}),e.jsxs("button",{onClick:D,className:"w-full py-3 px-4 bg-telegram-blue text-white rounded-lg flex items-center justify-center gap-2 hover:bg-telegram-dark transition-colors",children:[e.jsx(ie,{size:20}),e.jsx("span",{children:"Перейти в корзину"})]})]})]})]})})},Ye=g.createContext(null),pt=({children:t})=>{var m,l,i;const r=typeof window<"u"?(m=window.Telegram)==null?void 0:m.WebApp:void 0,c={tg:r,onClose:()=>{r&&r.close()},onToggleButton:()=>{var h;(h=r==null?void 0:r.MainButton)!=null&&h.isVisible?r.MainButton.hide():r!=null&&r.MainButton&&r.MainButton.show()},initWebApp:()=>{console.log("Initializing Telegram WebApp with direct access..."),r?(r.ready(),console.log("Telegram WebApp initialized successfully")):console.error("Telegram WebApp is not available")},getUserData:()=>{var h;if((h=r==null?void 0:r.initDataUnsafe)!=null&&h.user){console.log("User data found in initDataUnsafe:",r.initDataUnsafe.user);try{localStorage.setItem("telegramUser",JSON.stringify(r.initDataUnsafe.user))}catch(d){console.error("Error storing user data in localStorage:",d)}return r.initDataUnsafe.user}console.log("No user data found in initDataUnsafe");try{const d=localStorage.getItem("telegramUser");if(d){const u=JSON.parse(d);return console.log("Using stored user data from localStorage:",u),u}}catch(d){console.error("Error retrieving user data from localStorage:",d)}return null},user:(l=r==null?void 0:r.initDataUnsafe)==null?void 0:l.user,queryId:(i=r==null?void 0:r.initDataUnsafe)==null?void 0:i.query_id};return e.jsx(Ye.Provider,{value:c,children:t})},ht=()=>{const t=g.useContext(Ye);if(!t)throw new Error("useTelegram must be used within a TelegramProvider");return t},ft=()=>{const{username:t,displayName:r,telegramUser:s,profile:n,avatarEmoji:o,updateTelegramUser:a}=pe(),[c,m]=g.useState(!0),[l,i]=g.useState(0),[h,d]=g.useState(!1),[u,f]=g.useState(0),[k,j]=g.useState(!1),N=X(),{tg:C,initWebApp:x,getUserData:v}=ht(),E=async()=>{if(s){j(!0);try{const I=await Je();f(I)}catch(I){console.error("Error fetching DD coins balance:",I)}finally{j(!1)}}},D=async I=>{d(!0);try{console.log(`Fetching rank for user ID: ${I}`);const $={telegram_user_id:I},{options:p,clearTimeout:y}=L("POST",$),b=await fetch(`${B}/users/rank`,p);if(y(),!b.ok)throw new Error(`Failed to fetch rank: ${b.status} ${b.statusText}`);const A=await b.text();console.log("Raw rank response:",A);const T=JSON.parse(A);if(console.log("Parsed rank response:",T),T&&T.loyalty_rank!==void 0){const S=typeof T.loyalty_rank=="string"?parseInt(T.loyalty_rank,10):Number(T.loyalty_rank);console.log("Setting user rank to:",S),i(S)}else console.error("loyalty_rank not found in response:",T),i(0)}catch($){console.error("Error fetching user rank:",$),i(0)}finally{d(!1)}};g.useEffect(()=>{(async()=>{try{console.log("Initializing Telegram WebApp on Profile page..."),x();const $=v();if($){console.log("Telegram user found on Profile page:",$),a($);const p=await de();m(typeof p=="boolean"?p:p.exists||!1),await D($.id),await E()}else console.log("No Telegram user data found on Profile page"),setTimeout(async()=>{const p=v();if(p){console.log("Telegram user found after delay:",p),a(p);const y=await de();m(typeof y=="boolean"?y:y.exists||!1),await D(p.id),await E()}else console.log("Still no Telegram user data after retry")},500)}catch($){console.error("Error initializing Telegram on Profile page:",$)}})()},[a,x,v,C]);const{data:_,isLoading:U,error:W,isError:K,refetch:G}=le({queryKey:["orders"],queryFn:He,staleTime:60*1e3,retry:1,retryDelay:1e3,enabled:c});if(U)return e.jsx(q,{children:e.jsx("div",{className:"flex justify-center items-center h-64",children:e.jsx(Se,{size:"lg"})})});if(K&&W instanceof Error&&!W.message.includes("not found"))return e.jsx(q,{children:e.jsxs("div",{className:"p-4 text-center",children:[e.jsx("h2",{className:"text-lg font-medium text-red-600 dark:text-red-400 mb-2",children:"Error loading profile"}),e.jsx("p",{className:"text-gray-600 dark:text-gray-400 mb-4",children:W instanceof Error?W.message:"Please try again later"}),e.jsx("button",{className:"px-4 py-2 bg-telegram-blue text-white rounded-lg",onClick:()=>G(),children:"Retry"})]})});const J=_||[];return e.jsx(q,{children:e.jsxs("div",{className:"p-4 relative",children:[e.jsxs("div",{className:"flex items-center justify-between mb-8 animate-fade-in",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx(Re,{user:s,emoji:o,size:"lg",className:"hover-lift"}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-semibold",children:s!=null&&s.username?`@${s.username}`:r}),s&&e.jsxs("p",{className:"text-gray-600 dark:text-gray-400",children:[s.first_name," ",s.last_name||""]}),e.jsx("div",{className:"mt-2 flex items-center",children:e.jsx("span",{className:"text-sm bg-telegram-light dark:bg-telegram-dark/20 text-telegram-blue dark:text-telegram-blue px-2 py-1 rounded-full",children:h?"Loading...":`Rank ${l}`})})]})]}),e.jsx("button",{onClick:()=>N("/settings"),className:"w-10 h-10 flex items-center justify-center rounded-full bg-telegram-light dark:bg-sidebar-accent hover:bg-telegram-secondary-bg dark:hover:bg-sidebar-primary transition-colors","aria-label":"Settings",children:e.jsx(lr,{size:20,className:"text-telegram-blue"})})]}),e.jsxs("div",{className:"mb-8 bg-white dark:bg-sidebar-accent rounded-lg p-4 shadow-sm animate-slide-up",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Oe,{size:24,className:"text-yellow-500"}),e.jsx("h2",{className:"text-lg font-semibold",children:"DD Coins Balance"})]}),k?e.jsx("span",{className:"text-sm text-gray-500",children:"Loading..."}):e.jsx("span",{className:"text-xl font-bold text-telegram-blue",children:u})]}),e.jsx("p",{className:"text-sm text-gray-600 dark:text-gray-400 mt-2",children:"You can use your DD coins to get discounts on your orders (up to 50% of the order value)."})]}),e.jsxs("div",{className:"grid grid-cols-3 gap-4 mb-8 animate-slide-up",children:[e.jsxs("div",{className:"bg-white dark:bg-sidebar-accent rounded-lg p-4 text-center shadow-sm",children:[e.jsx("h2",{className:"text-xl font-semibold text-telegram-blue",children:J.length}),e.jsx("p",{className:"text-gray-600 dark:text-gray-400 text-sm",children:"Orders"})]}),e.jsxs("div",{className:"bg-white dark:bg-sidebar-accent rounded-lg p-4 text-center shadow-sm",children:[e.jsx("h2",{className:"text-xl font-semibold text-telegram-blue",children:J.filter(I=>I.status==="delivered").length}),e.jsx("p",{className:"text-gray-600 dark:text-gray-400 text-sm",children:"Completed"})]}),e.jsxs("div",{className:"bg-white dark:bg-sidebar-accent rounded-lg p-4 text-center shadow-sm",children:[e.jsx("h2",{className:"text-xl font-semibold text-telegram-blue",children:J.filter(I=>I.status!=="delivered").length}),e.jsx("p",{className:"text-gray-600 dark:text-gray-400 text-sm",children:"Pending"})]})]}),e.jsxs("div",{className:"mb-8",children:[e.jsx("h2",{className:"text-xl font-medium mb-4",children:"Invite Friends"}),e.jsxs("div",{className:"bg-white dark:bg-sidebar-accent rounded-lg shadow-sm overflow-hidden",children:[e.jsx("div",{className:"p-4 border-b border-gray-100 dark:border-gray-800/50",children:e.jsx("p",{className:"text-sm text-gray-600 dark:text-gray-400",children:"Share your referral link with friends and earn rewards when they join and make purchases!"})}),e.jsx(Tr,{className:"animate-fade-in"})]})]}),e.jsxs("div",{className:"mb-8",children:[e.jsx("h2",{className:"text-xl font-medium mb-4",children:"Order History"}),_&&_.length>0?e.jsx("div",{className:"space-y-4",children:_.map(I=>e.jsx(Sr,{order:I},I.order_id))}):e.jsxs("div",{className:"p-6 text-center bg-telegram-secondary-bg rounded-lg",children:[e.jsx("h3",{className:"font-medium text-lg mb-2",children:"No Orders Yet"}),e.jsx("p",{className:"text-gray-600 dark:text-gray-400 mb-4",children:"You haven't placed any orders yet. Start shopping to see your orders here."}),e.jsx("button",{onClick:()=>N("/shop"),className:"px-4 py-2 bg-telegram-blue text-white rounded-lg",children:"Browse Products"})]})]})]})})},Rt=async t=>{try{const r=R();if(!r)throw new Error("No Telegram user data available");const{options:s,clearTimeout:n}=L("POST",{telegram_id:r.id,promocode_text:t}),o=await fetch(`${B}/promocodes/validate`,s);if(n(),!o.ok){const c=await o.text();throw new Error(c||"Failed to validate promocode")}return await o.json()}catch(r){throw console.error("Error validating promocode:",r),r}},Lt=(t,r)=>{let s=t;if(r.discount_fixed>0&&(s=Math.max(0,s-r.discount_fixed)),r.discount_percent&&r.discount_percent!=="null"){const n=s*parseFloat(r.discount_percent)/100;s=Math.max(0,s-n)}return Math.round(s)},xt=()=>{const{items:t,removeFromCart:r,clearCart:s}=he(),[n,o]=g.useState(!1),[a,c]=g.useState(!1),[m,l]=g.useState(!1),[i,h]=g.useState(),[d,u]=g.useState(0),[f,k]=g.useState(0),[j,N]=g.useState(0),[C,x]=g.useState(!1),[v,E]=g.useState(null),[D,_]=g.useState(null);g.useEffect(()=>{(async()=>{if(R()){x(!0);try{const A=await Je();k(A)}catch(A){console.error("Error fetching DD coins balance:",A)}finally{x(!1)}}})()},[]),g.useEffect(()=>{const y=t.reduce((b,A)=>b+(A.sale_price||A.price)*A.quantity,0);if(i){let b=y;if(i.discount_fixed&&(b=Math.max(0,b-i.discount_fixed)),i.discount_percent&&i.discount_percent!=="null"){const A=b*parseFloat(i.discount_percent)/100;b=Math.max(0,b-A)}v&&(b+=v.price_rub),u(Math.round(b))}else{let b=y;v&&(b+=v.price_rub),u(b)}N(0)},[t,i,v]);const U=Math.min(f,Math.floor(d*.5)),W=d-j,K=y=>{const b=parseInt(y.target.value);N(b)},G=(y,b)=>{h(y),u(Math.round(b))},J=()=>{h(void 0),u(t.reduce((y,b)=>y+(b.sale_price||b.price)*b.quantity,0))},I=async()=>{try{if(o(!0),t.length===0){w.error("Ваша корзина пуста!"),o(!1);return}if(!R()){w.error("Пожалуйста, войдите, чтобы создать заказ"),o(!1);return}try{const b=await Te();_(b?{email:b.email||"",phone_number:b.phone_number||"",address:b.address||""}:null),l(!0),o(!1)}catch(b){console.error("Error getting client information:",b),w.error("Не удалось получить информацию о клиенте"),o(!1)}}catch(y){console.error("Error in order creation process:",y),w.error(`Error: ${y.message}`),o(!1)}},$=y=>{l(!1),y?E(y):alert("No delivery rate provided"),p(y)},p=async y=>{try{o(!0);const b=R();if(!b){w.error("Пожалуйста, войдите, чтобы создать заказ");return}const A=await Te(),T=t.map(P=>{if(P.item_type==="preorder"){let fe=P.category_type;return fe==="shoes"&&(fe="sneakers"),{item_type:"preorder",dewu_url:P.dewu_url,size:P.size,category_type:fe,shipping_type:P.shipping_type||(P.delivery_type==="cargo"?"cargo":"aero"),price_cny:P.price_cny||Math.round(P.price/12),quantity:P.quantity}}else return{item_type:"stock",stock_id:parseInt(P.productId)||void 0,sku:parseInt(P.productId)?void 0:P.productId,size:P.size,quantity:P.quantity}}),S={telegram_user_id:b.id,delivery_method:(y==null?void 0:y.delivery_type)||"self_pickup",delivery_address:(A==null?void 0:A.address)||"",promocode_text:i==null?void 0:i.promocode_text,dd_coins_amount:j,items:T,final_price:W};console.log("Creating unified order with data:",JSON.stringify(S));const F=await Xr(S);F.success?(s(),w.success("Заказ создан успешно")):w.error(F.message||"Не удалось создать заказ")}catch(b){console.error("Error creating order:",b),w.error(`Error creating order: ${b.message}`)}finally{o(!1)}};return e.jsxs(q,{children:[e.jsxs("div",{className:"max-w-4xl mx-auto px-4 py-6",children:[e.jsx("h1",{className:"text-2xl font-bold mb-6",children:"Корзина"}),t.length===0?e.jsxs("div",{className:"text-center py-12",children:[e.jsx(ie,{className:"mx-auto h-12 w-12 text-gray-400"}),e.jsx("h3",{className:"mt-4 text-lg font-medium text-gray-900 dark:text-gray-100",children:"Ваша корзина пуста"}),e.jsx("p",{className:"mt-2 text-sm text-gray-500 dark:text-gray-400",children:"Добавьте товары в корзину, чтобы продолжить покупки"}),e.jsxs(M,{to:"/shop",className:"mt-6 inline-flex items-center text-sm font-medium text-telegram-blue hover:text-telegram-dark",children:[e.jsx(ir,{className:"mr-2 h-4 w-4"}),"Продолжить покупки"]})]}):e.jsxs("div",{children:[e.jsx("div",{className:"space-y-4",children:t.map(y=>e.jsx(Er,{item:y,onRemove:()=>r(y.productId,y.size)},`${y.productId}-${y.size}`))}),e.jsxs("div",{className:"bg-white dark:bg-sidebar-accent rounded-lg p-4 shadow-sm mb-6 mt-6",children:[e.jsx("h3",{className:"text-sm font-medium mb-2",children:"У вас есть промокод?"}),e.jsx(_r,{originalPrice:t.reduce((y,b)=>y+(b.sale_price||b.price)*b.quantity,0),onPromocodeApplied:G,onPromocodeRemoved:J,currentPromocode:i})]}),e.jsxs("div",{className:"bg-white dark:bg-sidebar-accent rounded-lg p-4 shadow-sm",children:[e.jsx("h3",{className:"text-lg font-medium mb-4",children:"Информация о заказе"}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-600 dark:text-gray-400",children:"Сумма товаров"}),e.jsxs("span",{children:["₽",t.reduce((y,b)=>y+(b.sale_price||b.price)*b.quantity,0)]})]}),v&&e.jsxs("div",{className:"flex justify-between",children:[e.jsxs("span",{className:"text-gray-600 dark:text-gray-400",children:["Доставка (",v.delivery_type==="self_pickup"?"Самовывоз":v.delivery_type==="courier"?"Курьер":"Почта",")"]}),e.jsx("span",{children:v.price_rub>0?`₽${v.price_rub.toLocaleString()}`:"Бесплатно"})]}),i&&e.jsxs("div",{className:"flex justify-between text-telegram-blue",children:[e.jsx("span",{children:"Скидка по промокоду"}),e.jsx("span",{children:i.discount_fixed?`-₽${i.discount_fixed}`:i.discount_percent&&i.discount_percent!=="null"?`-${i.discount_percent}%`:""})]}),f>0&&d>0&&e.jsxs("div",{className:"pt-3 border-t border-gray-200 dark:border-gray-700",children:[e.jsxs("div",{className:"flex justify-between items-center mb-2",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(Oe,{size:16,className:"text-yellow-500"}),e.jsx("span",{className:"font-medium",children:"DD Коины"})]}),e.jsxs("span",{className:"text-sm text-gray-600 dark:text-gray-400",children:["Баланс: ",f]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{children:"Использовать DD Коины для оплаты"}),e.jsxs("span",{className:"text-telegram-blue",children:[j," коинов (-₽",j,")"]})]}),e.jsx("input",{type:"range",min:"0",max:U,value:j,onChange:K,className:"w-full",disabled:U<=0}),e.jsxs("div",{className:"flex justify-between text-xs text-gray-500",children:[e.jsx("span",{children:"0"}),e.jsxs("span",{children:["Макс: ",U," коинов (50% от суммы)"]})]})]})]}),e.jsxs("div",{className:"flex justify-between font-medium pt-2 border-t border-gray-200 dark:border-gray-700",children:[e.jsx("span",{children:"Итого"}),e.jsxs("span",{children:["₽",W]})]})]}),e.jsx("button",{onClick:I,disabled:n||a,className:"w-full mt-4 bg-telegram-blue text-white py-3 rounded-lg font-medium hover:bg-telegram-dark transition-colors disabled:opacity-50 disabled:cursor-not-allowed",children:n||a?e.jsxs(e.Fragment,{children:[e.jsx(re,{className:"inline-block mr-2 h-4 w-4 animate-spin"}),a?"Проверка данных...":"Создание заказа..."]}):"Оформить заказ"})]})]})]}),m&&e.jsx(Cr,{onComplete:$,onCancel:()=>l(!1),clientInfo:D})]})},yt=()=>{const t=X();return e.jsx(q,{fullHeight:!0,children:e.jsxs("div",{className:"min-h-screen flex flex-col items-center justify-center p-4 text-center",children:[e.jsx("div",{className:"text-8xl mb-4 animate-float",children:"🔍"}),e.jsx("h1",{className:"text-4xl font-bold mb-4",children:"404"}),e.jsx("p",{className:"text-xl text-gray-600 mb-6",children:"Oops! We couldn't find that page"}),e.jsx("button",{onClick:()=>t("/"),className:"px-6 py-3 bg-telegram-blue text-white rounded-lg hover:bg-telegram-dark transition-colors",children:"Return to Home"})]})})},bt=t=>t.split(" ").map(r=>r.charAt(0).toUpperCase()+r.slice(1).toLowerCase()).join(" "),wt=()=>{const{addPreorderToCart:t}=he(),[r,s]=g.useState(""),[n,o]=g.useState(""),[a,c]=g.useState("car"),[m,l]=g.useState(""),[i,h]=g.useState(""),[d,u]=g.useState(!1),[f,k]=g.useState(!1),[j,N]=g.useState([]),[C,x]=g.useState(!1),[v,E]=g.useState(""),[D,_]=g.useState(""),[U,W]=g.useState(null);g.useEffect(()=>{(async()=>{x(!0);try{const S=await Me();N(S),S.length>0&&o(S[0].name)}catch(S){console.error("Failed to load categories:",S),w.error("Failed to load item categories")}finally{x(!1)}})()},[]);const K=async()=>{if(!r||v){w.error("Введите корректную цену для расчёта");return}if(!n){w.error("Выберите категорию товара");return}const T=G(n);if(!T){w.error("Неверный тип категории");return}u(!0);try{const S=parseInt(r),F=await Qr(S,a,T);W(F)}catch(S){console.error("Error calculating shipping:",S),w.error(`Ошибка расчёта доставки: ${S.message}`),W(null)}finally{u(!1)}},G=T=>T.toLowerCase(),J=T=>{const S=T.target.value;if(S&&!/^\d+$/.test(S)){E("Введите только цифры"),s(S);return}const F=parseInt(S);S&&(F<=0||F>=1e6)?E("Цена должна быть от 1 до 999,999 юаней"):E(""),s(S)},I=T=>{const S=T.target.value,F=$(S),P=F||S;P&&!p(P)?_("Введите корректную ссылку"):_(""),l(F||S)},$=T=>{const S=[/https?:\/\/dw4\.co\/[^\s]+/i,/https?:\/\/m\.dewu\.com\/[^\s]+/i,/https?:\/\/www\.dewu\.com\/[^\s]+/i,/https?:\/\/dewu\.com\/[^\s]+/i];for(const F of S){const P=T.match(F);if(P&&P[0])return console.log("Extracted DEWU URL:",P[0]),P[0]}return null},p=T=>{try{return new URL(T),!0}catch{return!1}},y=T=>{Y(),o(T.target.value),W(null)},b=T=>{Y(),c(T),W(null)},A=async()=>{if(!m){w.error("Введите ссылку на товар");return}if(D){w.error("Введите корректную ссылку на товар");return}if(!U){w.error("Сначала рассчитайте стоимость");return}const T=G(n);if(!T){w.error("Неверный тип категории");return}k(!0);try{const S=r?parseInt(r):0;t({dewu_url:m,size:i||"Не указан",category_type:T,shipping_type:a==="car"?"cargo":"aero",price:U,price_cny:S,name:`Предзаказ - ${T==="sneakers"?"Обувь":T==="clothes"?"Одежда":T==="accessories"?"Аксессуары":n} - ${i||"Размер не указан"}`}),w.success("Предзаказ добавлен в корзину"),l(""),h(""),W(null)}catch(S){console.error("Error adding preorder to cart:",S),w.error("Ошибка при добавлении предзаказа в корзину")}finally{k(!1)}};return e.jsx(q,{children:e.jsxs("div",{className:"p-4",children:[e.jsxs("div",{className:"flex items-center mb-6",children:[e.jsx(cr,{className:"mr-2 text-telegram-blue",size:24}),e.jsx("h1",{className:"text-2xl font-semibold",children:"Калькулятор доставки"})]}),e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"block text-sm font-medium",children:"Цена товара (юани)"}),e.jsx("input",{type:"text",value:r,onChange:J,placeholder:"Введите цену в юанях",className:`w-full p-3 rounded-lg border ${v?"border-red-500":"border-gray-300 dark:border-gray-700"} bg-white dark:bg-sidebar-accent`}),v&&e.jsx("p",{className:"text-red-500 text-sm",children:v}),e.jsx("div",{className:"flex items-center text-xs text-telegram-hint",children:e.jsxs("a",{href:"https://teletype.in/@poizonshop/link",target:"_blank",rel:"noopener noreferrer",className:"flex items-center text-telegram-link",children:["Как проверить цену? ",e.jsx(Ce,{size:12,className:"ml-1"})]})})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"block text-sm font-medium",children:"Категория товара"}),e.jsx("select",{value:n,onChange:y,className:"w-full p-3 rounded-lg border border-gray-300 dark:border-gray-700 bg-white dark:bg-sidebar-accent",disabled:C,children:C?e.jsx("option",{value:"",children:"Загрузка категорий..."}):j.length===0?e.jsx("option",{value:"",children:"Нет доступных категорий"}):j.map(T=>e.jsx("option",{value:T.name,children:bt(T.name)},T.id))})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"block text-sm font-medium",children:"Тип доставки"}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("button",{type:"button",onClick:()=>b("car"),className:`p-3 rounded-lg flex flex-col items-center justify-center ${a==="car"?"bg-telegram-blue text-white":"bg-white dark:bg-sidebar-accent border border-gray-300 dark:border-gray-700"}`,children:[e.jsx(dr,{size:24,className:"mb-2"}),e.jsx("span",{className:"font-medium",children:"Автомобиль"}),e.jsx("span",{className:"text-xs mt-1 opacity-80",children:"21-35 дней"})]}),e.jsxs("button",{type:"button",onClick:()=>b("plane"),className:`p-3 rounded-lg flex flex-col items-center justify-center ${a==="plane"?"bg-telegram-blue text-white":"bg-white dark:bg-sidebar-accent border border-gray-300 dark:border-gray-700"}`,children:[e.jsx(ur,{size:24,className:"mb-2"}),e.jsx("span",{className:"font-medium",children:"Самолет"}),e.jsx("span",{className:"text-xs mt-1 opacity-80",children:"5-10 дней"})]})]})]}),e.jsx("button",{type:"button",onClick:K,disabled:d||!r||!!v||!n,className:"w-full bg-green-600 text-white p-4 rounded-lg font-medium disabled:opacity-50 disabled:cursor-not-allowed",children:d?e.jsxs(e.Fragment,{children:[e.jsx(re,{className:"inline-block mr-2 h-4 w-4 animate-spin"}),"Идет расчет..."]}):"Рассчитать стоимость доставки"}),U!==null&&e.jsxs("div",{className:"mt-8 p-4 bg-telegram-secondary-bg rounded-lg",children:[e.jsx("h2",{className:"text-lg font-medium mb-2",children:"Предварительная стоимость"}),e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{children:"Итоговая цена:"}),e.jsxs("span",{className:"text-2xl font-bold text-telegram-blue",children:["₽",U.toLocaleString()]})]}),e.jsx("div",{className:"mt-4 text-xs text-telegram-hint",children:e.jsx("p",{children:"Включает стоимость товара, доставки и комиссии"})})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("label",{className:"block text-sm font-medium",children:["Ссылка на товар ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx("input",{type:"text",value:m,onChange:I,placeholder:"Вставьте ссылку Poizon (DEWU)",className:`w-full p-3 rounded-lg border ${D?"border-red-500":"border-gray-300 dark:border-gray-700"} bg-white dark:bg-sidebar-accent`}),D&&e.jsx("p",{className:"text-red-500 text-sm",children:D}),e.jsx("div",{className:"flex items-center text-xs text-telegram-hint",children:e.jsxs("a",{href:"https://teletype.in/@poizonshop/link",target:"_blank",rel:"noopener noreferrer",className:"flex items-center text-telegram-link",children:["Как получить ссылку? ",e.jsx(Ce,{size:12,className:"ml-1"})]})})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"block text-sm font-medium",children:"Размер (Необязательно)"}),e.jsx("input",{type:"text",value:i,onChange:T=>h(T.target.value),placeholder:"например, 42, XL и т.д.",className:"w-full p-3 rounded-lg border border-gray-300 dark:border-gray-700 bg-white dark:bg-sidebar-accent"})]}),U!==null&&e.jsx("button",{onClick:A,disabled:f||!m||!!D,className:"w-full mt-4 bg-telegram-blue text-white py-3 rounded-lg font-medium hover:bg-telegram-dark transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2",children:f?e.jsxs(e.Fragment,{children:[e.jsx(re,{className:"h-5 w-5 animate-spin"}),"Добавление в корзину..."]}):e.jsxs(e.Fragment,{children:[e.jsx($e,{size:20}),"Добавить в корзину"]})})]})]})})},jt=()=>{const t=X();pe();const[r,s]=g.useState(""),[n,o]=g.useState(""),[a,c]=g.useState(""),[m,l]=g.useState(!1),[i,h]=g.useState(!0);g.useEffect(()=>{(async()=>{h(!0);try{const f=await Te();f&&(s(f.email||""),o(f.phone_number||""),c(f.address||""))}catch(f){console.error("Error loading client info:",f)}finally{h(!1)}})()},[]);const d=async u=>{u.preventDefault(),l(!0);try{if(!r){w.error("Please enter your email address"),l(!1);return}if(!n){w.error("Please enter your phone number"),l(!1);return}if(!a){w.error("Please enter your address"),l(!1);return}await Zr(n,r,a)&&t("/profile")}catch(f){console.error("Error saving settings:",f),w.error("Error saving settings")}finally{l(!1)}};return e.jsx(q,{children:e.jsxs("div",{className:"p-4",children:[e.jsxs("div",{className:"flex items-center gap-4 mb-6",children:[e.jsx("button",{onClick:()=>t("/profile"),className:"w-8 h-8 flex items-center justify-center rounded-full bg-gray-100 dark:bg-gray-800",children:e.jsx(mr,{size:18})}),e.jsx("h1",{className:"text-xl font-semibold",children:"Settings"})]}),i?e.jsx("div",{className:"flex items-center justify-center py-8",children:e.jsx(re,{className:"w-8 h-8 animate-spin text-telegram-blue"})}):e.jsxs("form",{onSubmit:d,className:"space-y-6",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{htmlFor:"email",className:"text-sm font-medium text-gray-700 dark:text-gray-300",children:"Email Address *"}),e.jsx("input",{id:"email",type:"email",value:r,onChange:u=>s(u.target.value),className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded-md shadow-sm focus:outline-none focus:ring-telegram-blue focus:border-telegram-blue dark:bg-gray-800",placeholder:"your@email.com",required:!0})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{htmlFor:"phone",className:"text-sm font-medium text-gray-700 dark:text-gray-300",children:"Phone Number *"}),e.jsx("input",{id:"phone",type:"tel",value:n,onChange:u=>o(u.target.value),className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded-md shadow-sm focus:outline-none focus:ring-telegram-blue focus:border-telegram-blue dark:bg-gray-800",placeholder:"+7 (999) 123-4567",required:!0})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{htmlFor:"address",className:"text-sm font-medium text-gray-700 dark:text-gray-300",children:"Address *"}),e.jsx("textarea",{id:"address",value:a,onChange:u=>c(u.target.value),className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded-md shadow-sm focus:outline-none focus:ring-telegram-blue focus:border-telegram-blue dark:bg-gray-800",placeholder:"Your full address",rows:3,required:!0})]}),e.jsx("button",{type:"submit",disabled:m,className:"w-full flex items-center justify-center gap-2 bg-telegram-blue text-white py-2 px-4 rounded-md hover:bg-telegram-dark transition-colors disabled:opacity-50 disabled:cursor-not-allowed",children:m?e.jsxs(e.Fragment,{children:[e.jsx(re,{className:"h-4 w-4 animate-spin"}),"Saving..."]}):e.jsxs(e.Fragment,{children:[e.jsx(gr,{size:16}),"Save Settings"]})})]})]})})},vt=()=>{var t;return{tg:(t=window.Telegram)==null?void 0:t.WebApp,initWebApp:()=>{var r,s,n;console.log("Mock initWebApp called"),(r=window.Telegram)!=null&&r.WebApp&&((n=(s=window.Telegram.WebApp).ready)==null||n.call(s))},getUserData:()=>{var r,s,n;if(console.log("Mock getUserData called"),(n=(s=(r=window.Telegram)==null?void 0:r.WebApp)==null?void 0:s.initDataUnsafe)!=null&&n.user)return window.Telegram.WebApp.initDataUnsafe.user;try{const o=localStorage.getItem("telegramUser");if(o)return JSON.parse(o)}catch(o){console.error("Error retrieving user data from localStorage:",o)}return null}}},kt=new pr({defaultOptions:{queries:{refetchOnWindowFocus:!1,retry:2,staleTime:5*60*1e3,gcTime:10*60*1e3}}}),Nt=({children:t})=>{const r=br(),s=X(),{updateTelegramUser:n}=pe(),[o,a]=g.useState(!1),[c,m]=g.useState(!0),{tg:l,initWebApp:i,getUserData:h}=vt(),{referralCode:d,isProcessing:u}=nt();lt({onNewUser:N=>{N&&d&&(console.log(`New user registered with referral code: ${d}`),w.success("Welcome! You were invited by a friend."))}}),g.useEffect(()=>{const N=Kr();return()=>{N()}},[]);const f=g.useCallback(async()=>{try{const N=await de();if(console.log("API user check result:",N),N){const C=await Fe();console.log("User rank:",C)}else console.log("User does not exist in the system yet")}catch(N){console.error("Error checking user in API:",N)}},[]),k=g.useCallback(()=>{const N=["/","/shop","/profile","/cart","/calculator","/settings"],C=r.pathname.startsWith("/product/");return r.pathname.includes("tgWebAppData=")||r.search.includes("tgWebAppData=")?(console.log("Detected Telegram WebApp data in URL, redirecting to home and preserving data"),!0):!N.includes(r.pathname)&&!C?(console.log("Redirecting to home from invalid path:",r.pathname),s("/",{replace:!0}),!1):!0},[r.pathname,r.search,s]),j=g.useCallback(async()=>{if(o||!k())return;console.log("Initializing Telegram interface...");const N=navigator.userAgent.toLowerCase().includes("telegram")||window.location.href.includes("tgwebapp");console.log(N?"Running in Telegram browser":"Not running in Telegram browser");const C=window.location.href.includes("tgWebAppData=");C&&console.log("Found tgWebAppData in URL, this is a direct launch from Telegram");try{if(l){i(),Q(),ce(),await new Promise(v=>setTimeout(v,300));const x=h();x?(console.log("User data retrieved:",x),n(x),await f(),C&&r.pathname!=="/"&&(console.log("Navigating to home to clean up URL"),s("/",{replace:!0})),a(!0),m(!1)):N?(console.log("No user data available despite being in Telegram browser"),setTimeout(()=>{const v=h();if(v)console.log("User data retrieved after delay:",v),n(v),C&&r.pathname!=="/"&&(console.log("Navigating to home to clean up URL"),s("/",{replace:!0}));else{console.log("Still no user data after retry. This might indicate:"),console.log("1. The Mini App is not properly configured in BotFather"),console.log("2. The user is not using the official Telegram app"),console.log("3. There's an issue with the initData validation");try{const E=localStorage.getItem("telegramUser");if(E){const D=JSON.parse(E);console.log("Using stored user data from localStorage:",D),n(D)}}catch(E){console.error("Error retrieving user data from localStorage:",E)}}a(!0),m(!1)},800)):(console.log("Not in Telegram browser, continuing without user data"),a(!0),m(!1))}else{console.log("Telegram WebApp is not available, using fallback method"),We(),Q(),await new Promise(v=>setTimeout(v,300));const x=me();x&&(console.log("User data retrieved using fallback method:",x),n(x)),a(!0),m(!1)}}catch(x){console.error("Error during Telegram initialization:",x),a(!0),m(!1)}},[o,k,n,s,r.pathname,l,i,h]);return g.useEffect(()=>(r.pathname!=="/"&&r.pathname!=="/shop"?(console.log("Showing back button for path:",r.pathname),Hr(()=>{console.log("Back button pressed, navigating back"),s(-1)})):(console.log("Hiding back button for home or shop page"),Pe()),()=>{Pe()}),[r.pathname,s]),g.useEffect(()=>{console.log("Setting up theme change listener"),ce(),Q();const N=()=>{console.log("Theme change detected, adapting to user theme"),Q()};return window.addEventListener("themechange",N),()=>{window.removeEventListener("themechange",N)}},[]),g.useEffect(()=>{j().finally(()=>{m(!1)})},[j]),g.useEffect(()=>{k()},[r.pathname,k]),c?e.jsx("div",{className:"min-h-screen flex items-center justify-center",children:e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-telegram-blue"})}):t},Tt=()=>e.jsx(hr,{defaultTheme:"dark",attribute:"class",children:e.jsx(fr,{client:kt,children:e.jsx(Dr,{children:e.jsx(ot,{children:e.jsxs(at,{children:[e.jsx(Ar,{}),e.jsx(Pr,{position:"top-center"}),e.jsx(xr,{children:e.jsx(Nt,{children:e.jsxs(yr,{children:[e.jsx(V,{path:"/",element:e.jsx(ut,{})}),e.jsx(V,{path:"/shop",element:e.jsx(mt,{})}),e.jsx(V,{path:"/product/:productId",element:e.jsx(gt,{})}),e.jsx(V,{path:"/profile",element:e.jsx(ft,{})}),e.jsx(V,{path:"/cart",element:e.jsx(xt,{})}),e.jsx(V,{path:"/calculator",element:e.jsx(wt,{})}),e.jsx(V,{path:"/settings",element:e.jsx(jt,{})}),e.jsx(V,{path:"*",element:e.jsx(yt,{})})]})})})]})})})})}),St=()=>{ce(),Q()};St();window.addEventListener("themechange",()=>{console.log("Theme change detected, adapting to user theme"),Q()});wr(document.getElementById("root")).render(e.jsx(pt,{children:e.jsx(Tt,{})}));export{he as a,zr as b,Pt as c,Ut as d,Ue as e,$t as f,Br as g,Y as h,It as i,Te as j,Zr as k,Lt as l,Dt as m,Ot as s,At as u,Rt as v};
//# sourceMappingURL=main-24tVyUju.js.map
