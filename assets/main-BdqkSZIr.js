const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/vendor-CxJslzje.js","assets/vendor-R9Y6aq4i.css"])))=>i.map(i=>d[i]);
import{t as qe,v as Je,J as v,Z as $,z as Me,w as He,O as ne,x as Ee,r as g,j as e,a as Z,L as J,h as Q,y as Ke,n as le,B as ye,D as je,F as Ge,X as oe,s as pe,G as Ye,S as De,M as Ve,q as Qe,I as Ze,K as Ae,Q as Xe,U as et,c as tt,m as Ne,V as rt,W as st,Y as ot,_ as at,$ as nt,a0 as lt,a1 as it,a2 as ct,a3 as dt,a4 as ut,a5 as mt,a6 as G,u as gt,a7 as pt,a8 as ft}from"./vendor-CxJslzje.js";import{P as F,U as Pe,S as ht,a as xt,B as bt,L as q,D as yt,b as wt,c as vt,d as jt,R as Nt,O as kt,e as _t,C as Tt,f as St,g as Ct,T as Et}from"./components-DRr7ox5w.js";import"./main-BdqkSZIr.js";(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))n(o);new MutationObserver(o=>{for(const a of o)if(a.type==="childList")for(const m of a.addedNodes)m.tagName==="LINK"&&m.rel==="modulepreload"&&n(m)}).observe(document,{childList:!0,subtree:!0});function s(o){const a={};return o.integrity&&(a.integrity=o.integrity),o.referrerPolicy&&(a.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?a.credentials="include":o.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function n(o){if(o.ep)return;o.ep=!0;const a=s(o);fetch(o.href,a)}})();function Ir(r){return r&&r.__esModule&&Object.prototype.hasOwnProperty.call(r,"default")?r.default:r}function Ur(...r){return qe(Je(r))}const he=["😀","😃","😄","😁","😆","😅","😂","🤣","😊","😇","🙂","🙃","😉","😌","😍","🥰","😘","😗","😙","😚","😋","😛","😝","😜","🤪","🤨","🧐","🤓","😎","🤩","🥳","😏","😒","😞","😔","😟","😕","🙁","☹️","😣","😖","😫","😩","🥺","😢","😭","😤","😠","😡","🤬","🤯","😳","🥵","🥶","😱","😨","😰","😥","😓","🤗","🤔","🤭","🤫","🤥","😶","😐","😑","😬","🙄","😯"],Dt=["👕","👚","👔","👗","👖","🧥","🧦","👟","👞","🧢","👒","🎩","🧣","🧤","👜","👝","👛","👓","🕶️","🥾","🥿","🌂","☂️","💼","🎒","👑","💄","💍","💎","⌚","🧸","🔮","🧩","🧶","🧵","🔭","🧬","🔬","🧪","📱","💻","🖥️","🖱️","🖨️","📷","🎮","🎧","🎵","📚","✏️"],At=["🎉","🎊","🎁","🎈","🎀","🎐","🎇","🎆","✨","🔥","💫","⭐","🌟","💥","💯","💢","💦","💤","💨","🕊️","💝","💖","💗","💓","💞","💕","❤️","🧡","💛","💚"],Pt=()=>{const r=Math.floor(Math.random()*he.length);return he[r]},It=(r,t)=>{const s=Array.from(r).reduce((a,m)=>a+m.charCodeAt(0),0),n=t==="avatar"?he:t==="product"?Dt:At,o=s%n.length;return n[o]},M="https://v2786182.hosted-by-vdsina.ru/api/v1",X={PRODUCTS:15e3,ORDERS:12e3,PROFILE:12e3},ce={PRODUCTS_TTL:5*60*1e3,PROFILE_TTL:10*60*1e3,ORDERS_TTL:3*60*1e3},z={_store:new Map,get(r,t){const s=this._store.get(r);return s?Date.now()-s.timestamp>t?(this._store.delete(r),null):s.data:null},set(r,t){this._store.set(r,{data:t,timestamp:Date.now()})},invalidate(r){this._store.delete(r)},clear(){this._store.clear()}},Ut=r=>{console.error("API Error:",r);let t="An error occurred. Please try again.";if(r.response){const s=r.response.status;try{const n=r.response.data;n&&n.detail?t=`API Error (${s}): ${n.detail}`:t=`API Error (${s}): ${r.response.statusText}`}catch{t=`API Error (${s}): Could not parse error details`}}else r.request?t="Network Error: No response from server. Using cached data instead.":r instanceof Error&&(t=`Error: ${r.message}`);return t.includes("Using cached data")?v.info(t):v.error(t),Promise.reject(new Error(t))},R=(r="GET",t,s=X.PRODUCTS)=>{const n=new AbortController,o=setTimeout(()=>n.abort(),s),a={method:r,signal:n.signal,mode:"cors",headers:{Accept:"application/json",...t?{"Content-Type":"application/json"}:{}},...t?{body:JSON.stringify(t)}:{}};return{signal:n.signal,options:a,clearTimeout:()=>clearTimeout(o)}},$t="modulepreload",zt=function(r){return"/dd-app-v1/"+r},ke={},Ot=function(t,s,n){let o=Promise.resolve();if(s&&s.length>0){document.getElementsByTagName("link");const m=document.querySelector("meta[property=csp-nonce]"),c=(m==null?void 0:m.nonce)||(m==null?void 0:m.getAttribute("nonce"));o=Promise.allSettled(s.map(l=>{if(l=zt(l),l in ke)return;ke[l]=!0;const i=l.endsWith(".css"),h=i?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${l}"]${h}`))return;const d=document.createElement("link");if(d.rel=i?"stylesheet":$t,i||(d.as="script"),d.crossOrigin="",d.href=l,c&&d.setAttribute("nonce",c),document.head.appendChild(d),i)return new Promise((u,b)=>{d.addEventListener("load",u),d.addEventListener("error",()=>b(new Error(`Unable to preload CSS for ${l}`)))})}))}function a(m){const c=new Event("vite:preloadError",{cancelable:!0});if(c.payload=m,window.dispatchEvent(c),!c.defaultPrevented)throw m}return o.then(m=>{for(const c of m||[])c.status==="rejected"&&a(c.reason);return t().catch(a)})};function ee(){var r;if(typeof window<"u"&&((r=window.Telegram)!=null&&r.WebApp))return window.Telegram.WebApp}function Bt(){try{console.log("Initializing Telegram WebApp...");try{Me.ready(),He.expand(),console.log("Telegram WebApp initialized successfully using SDK")}catch(r){console.warn("SDK initialization failed, falling back to direct WebApp API:",r);const t=ee();if(t)t.ready(),t.expand(),console.log("Telegram WebApp initialized successfully using direct WebApp API");else throw new Error("Telegram WebApp is not available")}}catch(r){console.error("Error initializing Telegram WebApp:",r)}}function Rt(){try{const r=document.documentElement;r.classList.add("telegram-webview");const t=ee(),s=$.isDark||(t==null?void 0:t.colorScheme)==="dark";s?(r.classList.add("dark"),r.classList.remove("light")):(r.classList.add("light"),r.classList.remove("dark")),console.log(`Theme set to ${s?"dark":"light"} mode`)}catch(r){console.error("Error setting theme class:",r)}}function we(){var r,t,s;try{if(console.log("Attempting to get Telegram user data..."),(s=(t=(r=window.Telegram)==null?void 0:r.WebApp)==null?void 0:t.initDataUnsafe)!=null&&s.user){const n=window.Telegram.WebApp.initDataUnsafe.user;console.log("User data found in window.Telegram.WebApp.initDataUnsafe:",n);try{localStorage.setItem("telegramUser",JSON.stringify(n))}catch(o){console.error("Error storing user data in localStorage:",o)}return n}return console.log("No Telegram user data available from any source"),null}catch(n){return console.error("Error getting Telegram user:",n),null}}function Lt(r){var t,s,n,o;try{console.log("Showing back button");try{ne.offClick(()=>{})}catch{console.log("No existing back button handlers to remove")}if(ne.onClick(r),ne.show(),(s=(t=window.Telegram)==null?void 0:t.WebApp)!=null&&s.BackButton)try{window.Telegram.WebApp.BackButton.onClick(r),window.Telegram.WebApp.BackButton.show()}catch(a){console.error("Error using direct WebApp API for back button:",a)}console.log("Back button shown and callback registered")}catch(a){if(console.error("Error showing back button:",a),(o=(n=window.Telegram)==null?void 0:n.WebApp)!=null&&o.BackButton)try{window.Telegram.WebApp.BackButton.onClick(r),window.Telegram.WebApp.BackButton.show(),console.log("Back button shown using direct WebApp API")}catch(m){console.error("Error using direct WebApp API for back button:",m)}}}function _e(){var r,t,s,n;try{if(console.log("Hiding back button"),ne.hide(),(t=(r=window.Telegram)==null?void 0:r.WebApp)!=null&&t.BackButton)try{window.Telegram.WebApp.BackButton.hide()}catch(o){console.error("Error using direct WebApp API to hide back button:",o)}console.log("Back button hidden")}catch(o){if(console.error("Error hiding back button:",o),(n=(s=window.Telegram)==null?void 0:s.WebApp)!=null&&n.BackButton)try{window.Telegram.WebApp.BackButton.hide(),console.log("Back button hidden using direct WebApp API")}catch(a){console.error("Error using direct WebApp API to hide back button:",a)}}}function Ie(r){var t,s,n;try{const o=ee();o!=null&&o.postEvent?o.postEvent("web_app_trigger_haptic_feedback",JSON.stringify(r)):(s=(t=window.Telegram)==null?void 0:t.WebviewProxy)!=null&&s.postEvent?window.Telegram.WebviewProxy.postEvent("web_app_trigger_haptic_feedback",JSON.stringify(r)):(n=window.TelegramWebviewProxy)!=null&&n.postEvent?window.TelegramWebviewProxy.postEvent("web_app_trigger_haptic_feedback",JSON.stringify(r)):console.warn("No method available to send haptic feedback event")}catch(o){console.error("Error sending haptic feedback event:",o)}}const $r=(r="medium")=>{try{try{Ee.impactOccurred(r),console.log(`Haptic impact triggered via SDK: ${r}`)}catch(t){console.warn("SDK haptic impact failed, falling back to direct WebApp API:",t),Ie({type:"impact",impact_style:r}),console.log(`Haptic impact triggered via WebApp API: ${r}`)}}catch(t){console.error("Error triggering haptic impact:",t)}},Y=()=>{try{try{Ee.selectionChanged(),console.log("Haptic selection triggered via SDK")}catch(r){console.warn("SDK haptic selection failed, falling back to direct WebApp API:",r),Ie({type:"selection_change"}),console.log("Haptic selection triggered via WebApp API")}}catch(r){console.error("Error triggering haptic selection:",r)}};function ae(){try{console.log("Requesting current theme from Telegram");try{const t=$.isDark;console.log("Using current theme params, isDark:",t);return}catch(t){console.warn("SDK theme params access failed, trying fallback method:",t)}const r=ee();if(!r){console.warn("Telegram WebApp is not available, can't request theme");return}if(typeof r.postEvent!="function"){console.warn("postEvent is not available in this Telegram client"),H();return}try{r.postEvent("web_app_request_theme"),console.log("Theme request sent successfully")}catch(t){console.warn("Error requesting theme using postEvent:",t),H()}}catch(r){console.error("Error requesting Telegram theme:",r),H()}}function Wt(){console.log("Setting up theme change listener for instant updates");const r=()=>{console.log("Theme change detected, updating colors and styles"),Rt(),H()},t=ee();if(t)try{return t.onEvent("themeChanged",r),window.addEventListener("themechange",r),()=>{try{t.offEvent("themeChanged",r)}catch(s){console.warn("Error removing Telegram theme listener:",s)}window.removeEventListener("themechange",r)}}catch(s){return console.error("Error setting up Telegram event listener:",s),window.addEventListener("themechange",r),()=>{window.removeEventListener("themechange",r)}}return window.addEventListener("themechange",r),()=>{window.removeEventListener("themechange",r)}}function H(){var r,t,s,n,o,a,m,c,l;try{console.log("Setting Telegram Mini App colors based on Telegram's native theme");const i=ee();let h,d,u,b,N,p,j,_;if(i){console.log("WebApp theme params:",i.themeParams),h=((r=i.themeParams)==null?void 0:r.bg_color)||(i.colorScheme==="dark"?"#271a28":"#ffffff"),d=((t=i.themeParams)==null?void 0:t.secondary_bg_color)||(i.colorScheme==="dark"?"#382639":"#f7f7f7"),u=((s=i.themeParams)==null?void 0:s.text_color)||(i.colorScheme==="dark"?"#ffffff":"#000000"),b=((n=i.themeParams)==null?void 0:n.hint_color)||(i.colorScheme==="dark"?"#7d7d7d":"#999999"),N=((o=i.themeParams)==null?void 0:o.link_color)||(i.colorScheme==="dark"?"#64baff":"#2481cc"),p=((a=i.themeParams)==null?void 0:a.button_color)||(i.colorScheme==="dark"?"#3390ec":"#2481cc"),j=((m=i.themeParams)==null?void 0:m.button_text_color)||"#ffffff",_=i.colorScheme==="dark",console.log("Using native Telegram theme colors:",{bgColor:h,secondaryBgColor:d,textColor:u,hintColor:b,linkColor:N,buttonColor:p,buttonTextColor:j,isDark:_});try{if(i.setHeaderColor?(i.setHeaderColor(d),console.log("Header color set using WebApp.setHeaderColor:",d)):(i.postEvent("web_app_set_header_color",JSON.stringify({color:d})),console.log("Header color set using postEvent:",d)),(c=window.Telegram)!=null&&c.WebApp){const x=window.Telegram.WebApp;typeof x.setHeaderColor=="function"&&(x.setHeaderColor(d),console.log("Header color set using global Telegram.WebApp.setHeaderColor"))}}catch(x){console.error("Error setting header color:",x);try{(l=window.Telegram)!=null&&l.WebApp&&typeof window.Telegram.WebApp.setHeaderColor=="function"&&(window.Telegram.WebApp.setHeaderColor("secondary_bg_color"),console.log("Header color set using color_key: secondary_bg_color"))}catch(k){console.error("All attempts to set header color failed:",k)}}try{i.setBackgroundColor?(i.setBackgroundColor(d),console.log("Background color set using WebApp.setBackgroundColor:",d)):(i.postEvent("web_app_set_background_color",JSON.stringify({color:d})),console.log("Background color set using postEvent:",d))}catch(x){console.error("Error setting background color:",x)}}else{console.log("WebApp not available, using SDK theme params"),h=$.backgroundColor||($.isDark?"#271a28":"#ffffff"),d=$.secondaryBackgroundColor||($.isDark?"#382639":"#f7f7f7"),u=$.textColor||($.isDark?"#ffffff":"#000000"),b=$.hintColor||($.isDark?"#7d7d7d":"#999999"),N=$.linkColor||($.isDark?"#64baff":"#2481cc"),p=$.buttonColor||($.isDark?"#3390ec":"#2481cc"),j=$.buttonTextColor||"#ffffff",_=!!$.isDark,console.log("Using SDK theme colors:",{bgColor:h,secondaryBgColor:d,textColor:u,hintColor:b,linkColor:N,buttonColor:p,buttonTextColor:j,isDark:_});try{Ot(async()=>{const{postEvent:x}=await import("./vendor-CxJslzje.js").then(k=>k.a9);return{postEvent:x}},__vite__mapDeps([0,1])).then(({postEvent:x})=>{x("web_app_set_header_color",{color:d}),console.log("Header color set to match frontend background:",d,"via SDK"),x("web_app_set_background_color",{color:d}),console.log("Background color set to:",d,"via SDK")}).catch(x=>{console.error("Error importing SDK for postEvent:",x)})}catch(x){console.error("Error setting colors via SDK:",x)}}Ft(d,u,b,N,p,j,d,_),ae()}catch(i){console.error("Error setting Telegram colors:",i)}}function Ft(r,t,s,n,o,a,m,c){try{const l=c===!0,i=r,h=m;console.log(`Applying ${l?"dark":"light"} theme CSS with Telegram colors`),console.log(`Using main background color: ${i}`),console.log(`Using header background color: ${h}`);const d=document.documentElement;l?(d.classList.add("dark"),d.classList.remove("light")):(d.classList.add("light"),d.classList.remove("dark")),d.classList.add("telegram-webview");const u=document.createElement("style");u.textContent=`
      :root {
        --tg-theme-bg-color: ${h} !important;
        --tg-theme-secondary-bg-color: ${i} !important;
        --tg-theme-text-color: ${t} !important;
        --tg-theme-hint-color: ${s} !important;
        --tg-theme-link-color: ${n} !important;
        --tg-theme-button-color: ${o} !important;
        --tg-theme-button-text-color: ${a} !important;
        --tg-color-scheme: ${l?"dark":"light"} !important;
        
        --telegram-bg: ${i} !important;
        --telegram-header-bg: ${h} !important;
        --telegram-secondary-bg: ${h} !important;
        --telegram-text: ${t} !important;
        --telegram-hint: ${s} !important;
        --telegram-link: ${n} !important;
        --telegram-button: ${o} !important;
        --telegram-button-text: ${a} !important;
      }
      
      body, html, #root {
        background-color: ${i} !important;
        color: ${t} !important;
      }
      
      .${l?"dark":"light"} body, .${l?"dark":"light"} html, .${l?"dark":"light"} #root {
        background-color: ${i} !important;
      }
      
      /* Apply colors to common UI elements */
      .card, .popover, .dropdown-menu, .card-container {
        background-color: ${h} !important;
        color: ${t} !important;
        border: 1px solid ${l?"rgba(255, 255, 255, 0.1)":"rgba(0, 0, 0, 0.1)"} !important;
      }
      
      a {
        color: ${n} !important;
      }
      
      .hint, .text-muted {
        color: ${s} !important;
      }
      
      .btn-primary, .button-primary {
        background-color: ${o} !important;
        color: ${a} !important;
      }
      
      /* Search inputs and form controls */
      input, select, textarea {
        background-color: ${i} !important;
        color: ${t} !important;
        border-color: ${s}30 !important;
      }
      
      input:focus, select:focus, textarea:focus {
        border-color: ${o} !important;
        box-shadow: 0 0 0 2px ${o}30 !important;
      }
      
      /* Size selector buttons */
      .size-button {
        background-color: ${i} !important;
        color: ${t} !important;
        border-color: ${s}30 !important;
      }
      
      .size-button.selected {
        background-color: ${o}10 !important;
        color: ${o} !important;
        border-color: ${o} !important;
      }
      
      /* Bottom navigation bar - solid color matching the secondary background color */
      .bottom-nav-bar {
        background-color: ${h} !important;
        /* Remove border and shadow */
        border-top: none !important;
        box-shadow: none !important;
        /* Add a subtle top border for separation */
        border-top: 1px solid ${l?"rgba(255, 255, 255, 0.05)":"rgba(0, 0, 0, 0.05)"} !important;
      }
      
      /* Bottom navigation items */
      .bottom-nav-bar a {
        color: ${s} !important;
        padding: 8px 0 !important;
        transition: all 0.2s ease !important;
      }
      
      /* Active navigation items */
      .bottom-nav-bar a.active, 
      .bottom-nav-bar a.active svg,
      .bottom-nav-bar a[aria-current="page"],
      .bottom-nav-bar a[aria-current="page"] svg {
        color: ${o} !important;
      }
      
      /* Navigation item hover effect */
      .bottom-nav-bar a:hover {
        color: ${o}CC !important;
        transform: translateY(-2px) !important;
      }
      
      /* Badge styling */
      .bottom-nav-bar .badge {
        background-color: ${o} !important;
        color: ${a} !important;
      }
      
      /* Force styles for desktop view */
      @media (min-width: 768px) {
        body, html, #root, .telegram-webview, .dark body, .dark html, .dark #root {
          background-color: ${i} !important;
        }
        
        .bottom-nav-bar, .dark .bottom-nav-bar {
          background-color: ${h} !important;
          border-top: none !important;
          box-shadow: none !important;
        }
      }
    `;const b=document.getElementById("telegram-theme-style");if(b&&b.remove(),u.id="telegram-theme-style",document.head.appendChild(u),d.style.setProperty("--tg-theme-bg-color",h,"important"),d.style.setProperty("--tg-theme-secondary-bg-color",i,"important"),d.style.setProperty("--tg-theme-text-color",t,"important"),d.style.setProperty("--tg-theme-hint-color",s,"important"),d.style.setProperty("--tg-theme-link-color",n,"important"),d.style.setProperty("--tg-theme-button-color",o,"important"),d.style.setProperty("--tg-theme-button-text-color",a,"important"),d.style.setProperty("--tg-color-scheme",l?"dark":"light","important"),document.body.style.backgroundColor=i,document.body.style.setProperty("background-color",i,"important"),document.body.style.color=t,document.body.style.setProperty("color",t,"important"),document.getElementById("root")){const p=document.getElementById("root");p.style.backgroundColor=i,p.style.setProperty("background-color",i,"important")}const N=document.querySelector(".bottom-nav-bar");N&&(N.style.backgroundColor=h,N.style.setProperty("background-color",h,"important"),N.style.backdropFilter="none",N.style.setProperty("-webkit-backdrop-filter","none","important"),N.style.borderTop="none",N.style.setProperty("border-top","none","important"),N.style.boxShadow="none",N.style.setProperty("box-shadow","none","important")),document.documentElement.style.backgroundColor=i,document.documentElement.style.setProperty("background-color",i,"important"),console.log(`${l?"Dark":"Light"} theme CSS applied with Telegram colors`)}catch(l){console.error("Error applying theme CSS:",l)}}function Te(r){var t;try{console.log("Opening URL in Telegram:",r);const s=ee();if(s&&typeof s.openLink=="function"){s.openLink(r,{try_instant_view:!0}),console.log("URL opened using WebApp.openLink");return}if((t=window.Telegram)!=null&&t.WebApp){const n=window.Telegram.WebApp;if(typeof n.openLink=="function"){n.openLink(r,{try_instant_view:!0}),console.log("URL opened using global Telegram.WebApp.openLink");return}}console.warn("No Telegram-specific method available to open URL, falling back to window.open"),window.open(r,"_blank")}catch(s){console.error("Error opening URL in Telegram:",s),window.open(r,"_blank")}}const Ue={PROFILE:r=>`profile_${r}`,RANK:r=>`rank_${r}`,DD_COINS:r=>`dd_coins_${r}`,DELIVERY_RATES:"delivery_rates"},O=()=>{try{const r=we();if(r)return console.log("Using Telegram user data from telegramUtils"),r;if(window.Telegram&&window.Telegram.WebApp){const t=window.Telegram.WebApp.initDataUnsafe.user;if(t&&t.id)return t;console.warn("Telegram WebApp available but user data is invalid")}return console.error("No Telegram user data available"),null}catch(r){return console.error("Error getting Telegram user:",r),null}},re=async(r=!0)=>{try{const t=O();if(!t)return console.error("No Telegram user data available for existence check"),!1;console.log(`Checking if user exists: ID=${t.id}, username=${t.username||"not set"}`);const s={telegram_user_id:t.id};t.username&&(s.telegram_username=t.username);const{options:n,clearTimeout:o}=R("POST",s,X.PROFILE);try{const a=await fetch(`${M}/users/check-exists`,n);if(o(),!a.ok){if(a.status===404)return console.log("User not found (404), considered as non-existent"),!1;const l=await a.text();let i;try{i=JSON.parse(l).detail||l}catch{i=l||`HTTP error ${a.status}`}throw new Error(i)}const m=await a.text(),c=JSON.parse(m);if(console.log("User existence check result:",c),c.dd_coins_balance!==void 0){const l=Ue.DD_COINS(t.id);z.set(l,c.dd_coins_balance)}return r?c:c.is_new_client}catch(a){return console.error("Error checking if user exists:",a),!1}}catch(t){return console.error("Error in checkUserExists:",t),!1}},$e=async r=>{try{const t=O(),s=r||(t?t.id:0),n=t?t.username||`user_${s}`:`user_${s}`;if(!s)throw console.error("No user ID available for profile check"),new Error("User ID required");return{telegram_username:n,rank:0,total_orders:0}}catch(t){return console.error("Error in legacy checkUserProfile:",t),{telegram_username:`user_${r||0}`,rank:0,total_orders:0}}},ze=async()=>{try{const r=O();if(!r||!r.id)return console.error("No Telegram user data available for getting DD coins balance"),0;const t=r.id;console.log(`Getting DD coins balance for user ID: ${t}`);const s=Ue.DD_COINS(t),n=z.get(s,ce.PROFILE_TTL);if(n!==null)return console.log("Using cached DD coins balance:",n),n;console.log("No cached DD coins balance, fetching from API...");const o=await re(!0);if(o&&typeof o!="boolean"){const a=o.dd_coins_balance;return console.log("DD coins balance from user check:",a),z.set(s,a),a}return 0}catch(r){return console.error("Error getting DD coins balance:",r),0}},fe=[{sku:"TS001-BLK",item_name:"Basic T-Shirt",color_code:"BLK",brand:"FashionBrand",description:"Original SKU: TS001-BLK",price_rub:500,sizes:[{size:"M",quantity:2},{size:"L",quantity:2}],photos:[{photo_url:"https://example.com/photos/ts001_front.jpg",photo_category:"front"},{photo_url:"https://example.com/photos/ts001_side.jpg",photo_category:"side"}]},{sku:"JN002-BLU",item_name:"Slim Jeans",color_code:"BLU",brand:"DenimCo",description:"Original SKU: JN002-BLU",price_rub:1200,sizes:[{size:"32",quantity:2}],photos:[{photo_url:"https://example.com/photos/jn002_front.jpg",photo_category:"front"}]},{sku:"SW003-RED",item_name:"Wool Sweater",color_code:"RED",brand:"WinterWear",description:"Original SKU: SW003-RED",price_rub:1500,sizes:[{size:"S",quantity:1},{size:"M",quantity:3}],photos:[{photo_url:"https://example.com/photos/sw003_front.jpg",photo_category:"front"}]}],ie={PRODUCTS:"products",CATEGORIES:"categories"},ve=async()=>{var r;console.log("Fetching products...");try{const t=z.get(ie.PRODUCTS,ce.PRODUCTS_TTL);if(t)return console.log("Using cached products data"),t;console.log("No cached products, fetching from API...");const{options:s,clearTimeout:n}=R("GET",void 0,X.PRODUCTS);try{const o=await fetch(`${M}/stock/in-stock`,s);if(n(),!o.ok){const l=await o.text();let i;try{i=JSON.parse(l).detail||l}catch{i=l||`HTTP error ${o.status}`}throw new Error(i)}const a=await o.text(),m=JSON.parse(a);if(console.log("Products fetched successfully, count:",((r=m.items)==null?void 0:r.length)||0),!m.items||!Array.isArray(m.items))return console.error("API returned invalid products data"),v.error("Invalid products data received from API"),fe;const c=m.items.map(l=>{const i=typeof l.price_rub=="string"?parseFloat(l.price_rub.replace(/[^\d.-]/g,"")):Number(l.price_rub),h=Array.isArray(l.photos)?l.photos:[],d=Array.isArray(l.sizes)?l.sizes.map(u=>({...u,quantity:typeof u.quantity=="string"?parseInt(u.quantity,10):u.quantity})):[];return{...l,price_rub:isNaN(i)?0:i,photos:h,sizes:d}});return z.set(ie.PRODUCTS,c),c}catch(o){return console.error("Error fetching products:",o),v.error(`Error loading products: ${o.message}`),fe}}catch(t){return console.error("Error in fetchProducts:",t),v.error(`Error: ${t.message}`),fe}},Oe=async()=>{var r;console.log("Fetching categories...");try{const t=z.get(ie.CATEGORIES,ce.PRODUCTS_TTL);if(t)return console.log("Using cached categories data"),t;console.log("No cached categories, fetching from API...");const{options:s,clearTimeout:n}=R("GET",void 0,X.PRODUCTS);try{const o=await fetch(`${M}/stock/get-categories`,s);if(n(),!o.ok){const c=await o.text();let l;try{l=JSON.parse(c).detail||c}catch{l=c||`HTTP error ${o.status}`}throw new Error(l)}const a=await o.text(),m=JSON.parse(a);return console.log("Categories fetched successfully, count:",((r=m.categories)==null?void 0:r.length)||0),!m.categories||!Array.isArray(m.categories)?(console.error("API returned invalid categories data"),v.error("Invalid categories data received from API"),[]):(z.set(ie.CATEGORIES,m.categories),m.categories)}catch(o){throw console.error("Error fetching categories:",o),o}}catch(t){return console.error("Failed to fetch categories:",t),Ut("Failed to fetch categories"),[]}},qt={ORDERS:r=>`orders_${r}`},Be=async()=>{try{const r=O();if(!r||!r.id)return console.error("No user data available when fetching orders"),[];console.log(`Fetching orders for user ID: ${r.id}...`);const t=qt.ORDERS(r.id),s=z.get(t,ce.ORDERS_TTL);if(s)return console.log("Using cached orders data"),s;console.log("No cached orders, fetching from API...");const n={telegram_user_id:r.id},{options:o,clearTimeout:a}=R("POST",n,X.ORDERS);try{const m=await fetch(`${M}/users/orders`,o);if(a(),m.status===404)return console.log("User has no orders or not found in orders API"),z.set(t,[]),[];if(!m.ok){const i=await m.text();let h;try{h=JSON.parse(i).detail||i}catch{h=i||`HTTP error ${m.status}`}throw new Error(h)}const c=await m.text(),l=JSON.parse(c);return console.log("Orders fetched successfully:",l),!l.orders||!Array.isArray(l.orders)?(console.error("API returned invalid orders data"),[]):(z.set(t,l.orders),l.orders)}catch(m){return console.error("Error fetching orders:",m),m.message.includes("User not found")||v.error("Данные пользователя недоступны. Попробуйте еще раз."),[]}}catch(r){return console.error("Error in fetchOrders:",r),r.message.includes("User not found")||v.error("Данные пользователя недоступны. Попробуйте еще раз."),[]}},Jt=async(r,t)=>{try{return console.log(`[MOCK API] Added product to cart - Product ID: ${r}, Size: ${t}`),!0}catch(s){return console.error("Error adding product to cart:",s),!1}},Mt=async(r,t,s)=>{try{const o={price_cny:r,shipping_type:t==="car"?"cargo":t==="plane"?"aero":t,category:s};console.log("Shipping calculation request:",o);const{options:a,clearTimeout:m}=R("POST",o,X.PRODUCTS),c=await fetch(`${M}/orders/calculate-shipping`,a);if(m(),console.log(`Response status: ${c.status} ${c.statusText}`),!c.ok){const i=await c.json().catch(()=>null);throw console.error("API response not OK:",c.status,c.statusText),console.error("Error data:",i),new Error(`Failed to calculate shipping: ${(i==null?void 0:i.message)||c.statusText}`)}const l=await c.json();return console.log("Shipping calculation response:",l),l.shipping_cost}catch(n){throw console.error("Error calculating shipping:",n),new Error(`Error calculating shipping: ${n.message}`)}},Ht=async r=>{var t;try{if(!((t=r.items)!=null&&t.length))throw new Error("Order must contain at least one item");const s=r.items.map(l=>{if(l.item_type==="preorder"){if(!l.dewu_url)throw new Error("Preorder item must have a URL");if(!l.category_type)throw new Error("Preorder item must have a category type");if(!l.shipping_type)throw new Error("Preorder item must have a shipping type");if(!l.price_cny)throw new Error("Preorder item must have a price in CNY");const i=["обувь","одежда","аксессуары"];if(!i.includes(l.category_type))throw new Error(`Invalid category type for preorder. Must be one of: ${i.join(", ")}`);const h=["cargo","aero"];if(!h.includes(l.shipping_type))throw new Error(`Invalid shipping type for preorder. Must be one of: ${h.join(", ")}`);return{item_type:"preorder",dewu_url:l.dewu_url,size:l.size||"",price_cny:l.price_cny,category_type:l.category_type,shipping_type:l.shipping_type,quantity:l.quantity||1}}else{if(l.stock_id)return{item_type:"stock",stock_id:l.stock_id};if(!l.sku)throw new Error("Stock item must have a SKU");return{item_type:"stock",sku:l.sku,size:l.size||"",quantity:l.quantity||1}}});if((r.delivery_method==="courier"||r.delivery_method==="shipping")&&!r.delivery_address)throw new Error("Delivery address is required for courier or shipping delivery method");const n={telegram_user_id:r.telegram_user_id,items:s,delivery_method:r.delivery_method,delivery_address:r.delivery_address||"",promocode_text:r.promocode_text,dd_coins_amount:r.dd_coins_amount,final_price:r.final_price};console.log("Sending unified order request:",JSON.stringify(n,null,2));const{options:o,clearTimeout:a}=R("POST",n),m=await fetch(`${M}/orders/create-order`,o);if(a(),!m.ok){const l=await m.text();let i;try{i=JSON.parse(l).detail||l}catch{i=l}throw new Error(i)}return await m.json()}catch(s){throw console.error("Error creating unified order:",s),s}},zr=async()=>{try{const{options:r,clearTimeout:t}=R("GET",void 0,X.PRODUCTS),s=await fetch(`${M}/orders/delivery-types`,r);if(t(),!s.ok){const o=await s.json().catch(()=>null);throw console.error("API response not OK:",s.status,s.statusText),console.error("Error data:",o),new Error(`Failed to fetch delivery types: ${(o==null?void 0:o.message)||s.statusText}`)}return(await s.json()).delivery_types||[]}catch(r){throw console.error("Error fetching delivery types:",r),r}},xe=async r=>{try{const t=O(),s=r||(t?t.id:null);if(!s)return console.error("No Telegram user ID available for client info"),v.error("User data not available"),null;console.log(`Fetching client info for Telegram ID: ${s}`);const{options:n,clearTimeout:o}=R("GET"),a=await fetch(`${M}/clients/by-telegram/${s}`,n);if(o(),!a.ok){if(a.status===404)return console.log("Client info not found (404)"),null;const l=await a.text();return console.error(`API Error (${a.status}): ${l}`),v.error("Failed to fetch client information"),null}const m=await a.text(),c=JSON.parse(m);return console.log("Client info fetched:",c),c}catch(t){return console.error("Error fetching client info:",t),v.error("Failed to fetch client information"),null}},Kt=async(r,t,s,n)=>{try{const o=O();if(!o)return console.error("No Telegram user data available"),v.error("User data not available"),!1;console.log(`Updating client info for Telegram ID: ${o.id}`);const a={telegram_id:o.id};r&&(a.phone_number=r),t&&(a.email=t),s&&(a.address=s),n!==void 0&&(a.mailing_flg=n),console.log("Update client info request:",a);const{options:m,clearTimeout:c}=R("POST",a),l=await fetch(`${M}/clients/update-info`,m);if(c(),l.ok)return console.log(`Client info update successful with status: ${l.status}`),!0;{const i=await l.text();return console.error(`API Error (${l.status}): ${i}`),!1}}catch(o){return console.error("Error updating client info:",o),!1}},de=`${M}/referrals`,Se=async(r=0)=>{try{const t=O();if(!t)return console.error("No Telegram user data available"),v.error("User data not available"),null;console.log(`Getting referral info for Telegram ID: ${t.id}`);const{options:s,clearTimeout:n}=R("GET"),o=await fetch(`${de}/info/${t.id}`,s);if(n(),!o.ok){const c=await o.text();if(console.error(`API Error (${o.status}): ${c}`),o.status===404){console.log("No referral code found, creating one...");const l=await Ce();if(l)return l;if(r===0)return console.log("Retrying to get referral info after creation..."),Se(1)}return(r>0||o.status!==404)&&v.error("Failed to fetch referral information"),null}const a=await o.text(),m=JSON.parse(a);if(console.log("Referral info fetched:",m),!m.telegram_deep_link){if(console.error("API returned referral info without telegram_deep_link:",m),r===0){console.log("Attempting to create a new referral code due to missing link...");const c=await Ce();if(c&&c.telegram_deep_link)return c}return v.error("Ошибка: реферальная ссылка отсутствует"),null}return m}catch(t){return console.error("Error fetching referral info:",t),r===0?(console.log("Retrying to get referral info after error..."),Se(1)):(v.error("Failed to fetch referral information"),null)}},Ce=async()=>{try{const r=O();if(!r)return console.error("No Telegram user data available"),v.error("User data not available"),null;console.log(`Creating referral code for Telegram ID: ${r.id}`);const{options:t,clearTimeout:s}=R("POST",{telegram_id:r.id}),n=await fetch(`${de}/create`,t);if(s(),!n.ok){const m=await n.text();return console.error(`API Error (${n.status}): ${m}`),v.error("Failed to create referral code"),null}const o=await n.text(),a=JSON.parse(o);return console.log("Referral code created:",a),a.telegram_deep_link?a:(console.error("API returned created referral without telegram_deep_link:",a),v.error("Ошибка: не удалось создать реферальную ссылку"),null)}catch(r){return console.error("Error creating referral code:",r),v.error("Failed to create referral code"),null}},Or=async()=>{try{const r=O();if(!r)return console.error("No Telegram user data available"),v.error("User data not available"),null;console.log(`Getting referral stats for Telegram ID: ${r.id}`);const{options:t,clearTimeout:s}=R("GET"),n=await fetch(`${de}/stats/${r.id}`,t);if(s(),!n.ok){const m=await n.text();return console.error(`API Error (${n.status}): ${m}`),v.error("Failed to fetch referral statistics"),null}const o=await n.text(),a=JSON.parse(o);return console.log("Referral stats fetched:",a),a}catch(r){return console.error("Error fetching referral stats:",r),v.error("Failed to fetch referral statistics"),null}},Br=async r=>{try{return!r||!r.telegram_deep_link?(console.error("Missing referral link:",r),v.error("Ошибка: реферальная ссылка отсутствует"),!1):(console.log("Sharing referral link:",r.telegram_deep_link),navigator.share?(await navigator.share({title:"Присоединяйся к DD:CONCEPT",text:`Держи ссылку на приложение DD:CONCEPT!
${r.telegram_deep_link}`,url:r.telegram_deep_link}),v.success("Ссылка на DD Store успешно отправлена"),!0):(await navigator.clipboard.writeText(r.telegram_deep_link),v.success("Реферальная ссылка скопирована в буфер обмена"),!0))}catch(t){console.error("Error sharing referral link:",t);try{if(r&&r.telegram_deep_link)return await navigator.clipboard.writeText(r.telegram_deep_link),v.success("Реферальная ссылка скопирована в буфер обмена"),!0;throw new Error("Missing referral link")}catch(s){return console.error("Clipboard error:",s),v.error("Не удалось поделиться реферальной ссылкой"),!1}}},Gt=async r=>{try{const t=O();if(!t)return console.error("No Telegram user data available"),!1;console.log(`Registering referral for user ${t.id} with code ${r}`);const{options:s,clearTimeout:n}=R("POST",{telegram_id:t.id,referral_code:r}),o=await fetch(`${de}/register`,s);if(n(),!o.ok){const c=await o.text();return console.error(`API Error (${o.status}): ${c}`),!1}const a=await o.text(),m=JSON.parse(a);return console.log("Referral registration result:",m),m.success}catch(t){return console.error("Error registering referral:",t),!1}},be={DD_COINS:r=>`dd_coins_${r}`,DD_COINS_TTL:5*60*1e3},Yt=async r=>{const t=be.DD_COINS(r),s=z.get(t,be.DD_COINS_TTL);if(s!==null)return console.log("Using cached DD coins balance from optimized service:",s),s;try{const n=await ze();return z.set(t,n),n}catch(n){return console.error("Error fetching DD coins in optimized service:",n),0}},Re=async r=>{console.log("Fetching initial data in parallel...");try{const t=await Promise.allSettled([$e(r),Be(),ve(),Yt(r)]),s=t[0].status==="fulfilled"?t[0].value:null,n=t[1].status==="fulfilled"?t[1].value:[],o=t[2].status==="fulfilled"?t[2].value:[],a=t[3].status==="fulfilled"?t[3].value:0;return t[0].status==="rejected"&&console.error("Failed to fetch profile:",t[0].reason),t[1].status==="rejected"&&console.error("Failed to fetch orders:",t[1].reason),t[2].status==="rejected"&&console.error("Failed to fetch products:",t[2].reason),t[3].status==="rejected"&&console.error("Failed to fetch DD coins balance:",t[3].reason),{profile:s,orders:n,products:o,ddCoinsBalance:a}}catch(t){return console.error("Error in parallel fetch:",t),v.error("Error loading data. Some features may be limited."),{profile:null,orders:[],products:[],ddCoinsBalance:0}}},Vt=async r=>{try{Re(r).then(()=>console.log("Background prefetch completed")).catch(t=>console.error("Background prefetch failed:",t));return}catch(t){console.error("Error starting prefetch:",t)}},Qt=async r=>{try{const t=`profile_${r}`,s=`orders_${r}`,n=be.DD_COINS(r);z.invalidate(t),z.invalidate(s),z.invalidate(n),z.invalidate("products"),await Re(r),v.success("Data refreshed successfully")}catch(t){console.error("Error refreshing data:",t),v.error("Failed to refresh data")}},Le=g.createContext(void 0),Zt=({children:r})=>{const[t,s]=g.useState(null),[n,o]=g.useState(""),[a,m]=g.useState(""),[c,l]=g.useState(null),[i,h]=g.useState(Pt()),[d,u]=g.useState(!0),[b,N]=g.useState(!1),p=g.useCallback(x=>{if(!x)return;console.log("Updating Telegram user data:",x),s(x),x.username?o(x.username):o(`user_${x.id}`);let k=x.first_name;x.last_name&&(k+=` ${x.last_name}`),m(k);try{localStorage.setItem("telegramUser",JSON.stringify(x)),localStorage.getItem("telegramUserData")&&localStorage.removeItem("telegramUserData")}catch{console.warn("Failed to store user data in localStorage")}const S=x.username||`user_${x.id}`;Vt(S,x.id).then(()=>{j(S,x.id)}).catch(D=>{console.error("Error during prefetch:",D),j(S,x.id)})},[]),j=g.useCallback(async(x,k)=>{try{console.log("Checking user profile...");const S=await $e(x,k);console.log("User profile loaded"),l(S)}catch(S){console.error("Error fetching user profile:",S);const D={telegram_username:x,rank:1,total_orders:0};console.log("Using default profile"),l(D)}},[]),_=g.useCallback(async()=>{try{if(u(!0),t){const x=t.username||`user_${t.id}`;await Qt(x,t.id),await j(x,t.id)}else v.error("No user data available for refresh")}catch(x){console.error("Error refreshing user data:",x),v.error(`Error refreshing data: ${x.message}`)}finally{u(!1)}},[t,j]);return g.useCallback(()=>{if(console.log("DEBUG - RAW TELEGRAM DATA:"),window.Telegram)if(console.log("window.Telegram exists"),window.Telegram.WebApp){if(console.log("window.Telegram.WebApp exists"),console.log("initData:",window.Telegram.WebApp.initData),window.Telegram.WebApp.initDataUnsafe)if(console.log("initDataUnsafe contents:",JSON.stringify(window.Telegram.WebApp.initDataUnsafe||{},null,2)),window.Telegram.WebApp.initDataUnsafe.user){const x=window.Telegram.WebApp.initDataUnsafe.user;return console.log("RAW USER OBJECT:",x),x}else console.log("No user data in initDataUnsafe");else console.log("No initDataUnsafe available");if(window.Telegram.WebApp.initData)try{const x=new URLSearchParams(window.Telegram.WebApp.initData);if(console.log("Parsed initData params:",Array.from(x.entries())),x.has("user"))try{const k=JSON.parse(decodeURIComponent(x.get("user")||"{}"));return console.log("User data parsed from initData:",k),k}catch(k){console.error("Error parsing user data from initData:",k)}else console.log("No user param in initData")}catch(x){console.error("Error parsing initData:",x)}else console.log("initData is empty")}else console.log("No WebApp in Telegram object");else console.log("No Telegram object in window");return null},[]),g.useEffect(()=>{if(b)return;(async()=>{try{u(!0),N(!0),console.log("Initializing user data...");const k=we();if(k){console.log("User data retrieved from Telegram WebApp:",k),p(k),u(!1);return}try{const S=localStorage.getItem("telegramUser")||localStorage.getItem("telegramUserData");if(S){const D=JSON.parse(S);console.log("Using stored user data:",D),p(D),u(!1);return}}catch{console.warn("Failed to retrieve user data from localStorage")}try{const S=await O();if(S){console.log("User data retrieved from API:",S),p(S),u(!1);return}}catch(S){console.error("Error getting user data from API:",S)}console.log("No user data available, using default values"),o("guest"),m("Guest User"),u(!1)}catch(k){console.error("Error initializing user data:",k),o("guest"),m("Guest User"),u(!1)}})()},[p,b]),e.jsx(Le.Provider,{value:{username:n,displayName:a,telegramUser:t,profile:c,avatarEmoji:i,loading:d,setUsername:o,setAvatarEmoji:h,updateTelegramUser:p,refreshUserData:_},children:r})},ue=()=>{const r=g.useContext(Le);if(r===void 0)throw new Error("useUser must be used within a UserProvider");return r},We=g.createContext(void 0),Xt=({children:r})=>{const[t,s]=g.useState([]),n=t.reduce((d,u)=>d+u.quantity,0),o=t.reduce((d,u)=>d+u.price*u.quantity,0);g.useEffect(()=>{const d=localStorage.getItem("cart");if(d)try{s(JSON.parse(d))}catch(u){console.error("Failed to parse cart from localStorage:",u)}},[]),g.useEffect(()=>{localStorage.setItem("cart",JSON.stringify(t))},[t]);const a=(d,u)=>{s(b=>{const N=b.findIndex(p=>p.productId===d.id&&p.size===u);if(N>=0){const p=[...b];return p[N].quantity+=1,p}else return[...b,{productId:d.id,name:d.name,color:d.color,size:u,price:d.price,quantity:1,item_type:"stock",photo_url:d.photo_url}]})},m=d=>{const u=`preorder-${btoa(d.dewu_url)}-${d.size}`;s(b=>{const N=b.findIndex(p=>p.productId===u);if(N>=0){const p=[...b];return p[N].quantity+=1,p}else return[...b,{productId:u,name:d.name,color:"",size:d.size,price:d.price,quantity:1,item_type:"preorder",dewu_url:d.dewu_url,category_type:d.category_type,delivery_type:d.delivery_type,shipping_type:d.shipping_type,price_cny:d.price_cny,photo_url:d.photo_url}]})},c=(d,u)=>{s(b=>{const N=b.findIndex(p=>p.productId===d&&p.size===u);if(N>=0){const p=[...b];return p[N].quantity>1?p[N].quantity-=1:p.splice(N,1),p}return b})},l=(d,u,b)=>{s(N=>{const p=N.findIndex(j=>j.productId===d&&j.size===u);if(p>=0){const j=[...N];return b<=0?j.splice(p,1):j[p].quantity=b,j}else b>0&&console.warn("Attempted to update quantity for non-existent item");return N})},i=(d,u)=>{const b=t.find(N=>N.productId===d&&N.size===u);return b?b.quantity:0},h=()=>{s([])};return e.jsx(We.Provider,{value:{items:t,addToCart:a,addPreorderToCart:m,removeFromCart:c,clearCart:h,itemCount:n,totalPrice:o,updateQuantity:l,getItemQuantity:i},children:r})},me=()=>{const r=g.useContext(We);if(r===void 0)throw new Error("useCart must be used within a CartProvider");return r},er=()=>{const[r,t]=g.useState(null),[s,n]=g.useState(!1),[o,a]=g.useState(!1);return g.useEffect(()=>{(()=>{try{const c=new URL(window.location.href),l=c.searchParams.get("ref"),i=c.searchParams.get("start");if(i&&i.startsWith("ref_")){const d=i.substring(4);if(d){console.log("Referral code detected from Telegram deep link:",d),t(d),c.searchParams.delete("start"),window.history.replaceState({},document.title,c.toString());return}}const h=window.location.pathname.split("/");if(h.length>=3&&h[1]==="ref"){const d=h[2];if(d){console.log("Referral code detected from path:",d),t(d);const u=window.location.pathname.replace(/\/ref\/[^\/]+/,"");window.history.replaceState({},document.title,u+window.location.search);return}}l&&(console.log("Referral code detected from query parameter:",l),t(l),c.searchParams.delete("ref"),window.history.replaceState({},document.title,c.toString()))}catch(c){console.error("Error detecting referral code:",c)}})()},[]),g.useEffect(()=>{(async()=>{if(!(!r||o||s)){n(!0);try{const c=JSON.parse(localStorage.getItem("processedReferrals")||"[]");if(c.includes(r)){console.log("Referral already processed:",r),a(!0),n(!1);return}await Gt(r)&&(console.log("Referral registered successfully"),c.push(r),localStorage.setItem("processedReferrals",JSON.stringify(c))),a(!0)}catch(c){console.error("Error processing referral:",c)}finally{n(!1)}}})()},[r,o,s]),{referralCode:r,isProcessing:s,isProcessed:o}},tr=r=>{const[t,s]=g.useState(!1),[n,o]=g.useState(!1),[a,m]=g.useState(!1);return g.useEffect(()=>{(async()=>{if(!(a||n)){o(!0);try{if(!O()){console.log("No Telegram user available, cannot check registration status"),o(!1);return}const i=await re(!0);if(console.log("User check response:",i),i&&typeof i!="boolean"){const h=i;s(h.is_new_client),h.is_new_client&&(r!=null&&r.onNewUser)&&r.onNewUser(!0)}else s(!1);m(!0)}catch(l){console.error("Error checking user registration:",l)}finally{o(!1)}}})()},[a,n,r]),{isNewUser:t,isChecking:n,hasChecked:a}},Rr="data:image/webp;base64,UklGRiwDAABXRUJQVlA4ICADAACQQwCdASpiAoUBPpFIoE0lpCMiIAgAsBIJaW7hcQEqxNZ99z/6/h/84fwCt/3P+5A8/5G0AJ7APfbJyHvtk5D32ych77ZOQ99snIe+2TkPfbJyHvtk5D32ych77ZOQ99snIe+2TkPfbJyHvtk5D32ych77ZOQ99snIe+2TkPfbJyHvtk5D32ych77ZOQ99snIe+2TkPfbJyHvtk5D32ych77ZOQ99snIe+2TkPfbJyHvtk5D32ych77ZOQ99snIe+2TkPfbJyHvtk5D322aG7z1FT956ip+89RU/eeoqfvPUVM7PUVP3nqKn7z1FT956ip+89RU/eealYCrJtsBVk22AqybbAVZNtgKsm2vA+mHBi2Lckw/l5qYfL2kOjk+SgRyaIEdZNtgKsm2wFWTbYCrJtsBVk22ASNH6I6ybbAVZNtgKsm2wFWTbYCrJgaCrJtsBVk22AqybbAVZNtgKsm2wFM1Sqn8nbgw+TtwYfJ24MPk7cGHydtjJ9NtgKsm2wFWTbYCrJtsBVk22AqvAaI6ybamLOfNgKsm2wEcvDkCrJtqMrJtsBVk22AqybbAVZNtgKsm2wFWSJ6n8nbj5bFtwYfJ24MPl7SGHyduC/YqhJP5e2wFWTbYCrJtsBVk22Aqya7sPk7cHRy8ODD5O3Bh/Lckw+TtwYddUJJ/J24MPk7cGHyduDD5O3Bh8nbYzWTDkCOXtqYf021MWxblARyfNgI2wAA/v5r0AAAAAAAAAAAAAAPK6tAEMNI4DopnQ5qGV4JSELz2aXNZvl6qQPP1x3gAAAAZY8NwDoYIQBsBZDNHfON9N/b3wxoY0MaGNDGhjQxoY0MaGNDGhjQxoY0MdDBJNk1VAAAAAAY/N4vkUe78sBNR43M7wAAjnR/74MsGWDLBldgiWYOmlsWQqDb9N9+1vpv7e+GNDHQwSYU7wR+6vOjYAAAAtpp+s1vrfW+VqpT4qVjGhjQxoY0MY8VKfFSsY0MaGNDHQw0dec8TtSJvo+zd7p1Ou5snvdOp1/UmL4ZJKh1GFX7F0FVEOVal7TH0E+NjYTLdo7WQgAAAA==",te=()=>{g.useEffect(()=>{window.scrollTo({top:0,behavior:"smooth"})},[])},rr="/dd-app-v1/assets/jointgbanner-z8r3ZTiB.webp",sr="/dd-app-v1/assets/catsofa_banner-DZMOOpqY.webp",or="/dd-app-v1/assets/ddcoins_banner-BdNzn1Na.webp",ar="/dd-app-v1/assets/calcbanner-DYKRYP7q.webp",nr="/dd-app-v1/assets/gotoshopbanner-BBwQ6dpk.webp",lr="/dd-app-v1/assets/sneakers_category_banner-DKr6-pVn.webp",ir="/dd-app-v1/assets/clothes_category_banner-v623PAGN.webp",cr="/dd-app-v1/assets/jeans_category_banner-DZUGsAeq.webp",dr="/dd-app-v1/assets/belt_category_banner-hZV84ikf.webp",ur="/dd-app-v1/assets/st_preview_1-BIvncD5e.png",mr="/dd-app-v1/assets/st_beginner_guide-YHVZx0at.png",gr="/dd-app-v1/assets/st_beginner_guide_2-COM6dVYm.jpg",pr=()=>{te();const{username:r,displayName:t,telegramUser:s,avatarEmoji:n,updateTelegramUser:o}=ue(),a=Z(),[m,c]=g.useState(0),[l,i]=g.useState(!1),[h,d]=g.useState(null),[u,b]=g.useState([]),N=[{id:"beginner-guide",title:`Что есть в приложении?
Кратко.`,previewImage:ur,images:[mr,gr],viewed:u.includes("beginner-guide")}],p=D=>{Y();const T=N.find(A=>A.id===D);T&&d(T)},j=D=>{u.includes(D)||b(T=>[...T,D])};g.useEffect(()=>{s!=null&&s.id&&_(s.id)},[s]);const _=async D=>{if(D){i(!0);try{console.log(`Fetching DD coins for user ID: ${D}`);const T=await re(!0);T&&typeof T!="boolean"?(console.log("Home page: DD coins balance received:",T.dd_coins_balance),c(T.dd_coins_balance),T.is_new_client&&T.dd_coins_balance===500&&setTimeout(()=>{v.success("Добро пожаловать! Только что начислили вам 500 $DD коинов в честь нашего знакомства!",{duration:6e3})},1500)):(console.error("Failed to get DD coins balance from user check"),c(0))}catch(T){console.error("Error fetching DD coins balance:",T),v.error("Failed to load DD coins balance")}finally{i(!1)}}},x=[{image:or,link:"/profile"},{image:rr,link:"https://t.me/dd_concept",external:!0},{image:sr,link:"/shop?brand=Cat%26Sofa"}],k=(s==null?void 0:s.username)||r,S=D=>{D.preventDefault(),Y(),a("/profile")};return e.jsxs(F,{fullHeight:!0,className:"p-4 pb-20",children:[e.jsx("header",{className:"mb-6",children:e.jsxs("div",{className:"flex items-start",children:[e.jsxs(J,{to:"/profile",className:"flex flex-col items-center shrink-0 mr-5 hover:opacity-90 transition-opacity",onClick:S,children:[e.jsxs("div",{className:"relative mb-1",children:[e.jsx(Pe,{user:s,emoji:n,size:"md",className:"hover-lift shadow-md"}),e.jsx("div",{className:"absolute -inset-1 bg-telegram-blue/30 rounded-full blur-md -z-10"})]}),e.jsxs("div",{className:"flex flex-col items-center text-center",children:[e.jsxs("span",{className:"text-xs text-gray-600 dark:text-gray-400",children:["@",k]}),e.jsx("span",{className:"text-xs font-medium text-telegram-blue",children:"DD:Профиль"})]})]}),e.jsx("div",{className:"flex-1 overflow-x-auto no-scrollbar pt-1",children:e.jsx(ht,{stories:N,onStoryClick:p})})]})}),h&&e.jsx(xt,{story:h,onClose:()=>d(null),onStoryViewed:j}),e.jsx("section",{className:"mb-8 animate-slide-up",children:e.jsx(bt,{banners:x})}),e.jsxs("section",{className:"mb-8",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsx(J,{to:"/shop",className:"bg-cover bg-center rounded-lg p-4 h-full col-span-1 shadow-sm hover-lift flex flex-col justify-end",style:{backgroundImage:`url(${nr})`},children:e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("h3",{className:"text-xl font-medium text-white",children:"Заказать"}),e.jsx(Q,{size:20,className:"text-white"})]})}),e.jsxs("div",{className:"col-span-1 space-y-4",children:[e.jsxs(J,{to:"/profile",className:"bg-telegram-blue text-white dark:bg-telegram-blue rounded-lg p-4 shadow-sm hover:shadow-md transition-all duration-300 transform hover:-translate-y-1 flex flex-col justify-between",children:[e.jsx("h3",{className:"font-medium text-white",children:"$DD COINS:"}),e.jsx("div",{className:"text-4xl font-bold mb-1 text-white",children:l?e.jsx("div",{className:"flex items-center justify-center h-10",children:e.jsx(q,{size:"md",className:"text-white"})}):m||0}),e.jsx("p",{className:"text-xs text-white/80",children:"Баланс и реферальная программа"}),e.jsx("div",{className:"flex justify-end mt-1",children:e.jsx(Q,{size:20,className:"text-white"})})]}),e.jsx(yt,{})]})]}),e.jsxs(J,{to:"/calculator",onClick:()=>window.scrollTo(0,0),className:"w-full rounded-lg overflow-hidden relative hover-lift h-16 block mt-4",style:{backgroundImage:`url(${ar})`,backgroundSize:"cover",backgroundPosition:"center"},children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-t from-black/70 to-transparent"}),e.jsxs("div",{className:"absolute inset-0 flex items-center p-4",children:[e.jsx("h3",{className:"font-medium text-white text-lg flex-1 text-center",children:"Рассчитать доставку"}),e.jsx(Q,{className:"text-white",size:20})]})]})]}),e.jsxs("section",{className:"mb-8",children:[e.jsx("h2",{className:"text-xl font-medium mb-4",children:"Что купить?"}),e.jsxs("div",{className:"grid grid-cols-2 gap-4 mb-4",children:[e.jsxs(J,{to:"/shop?category=обувь",className:"rounded-lg overflow-hidden relative hover-lift aspect-[5/3]",style:{backgroundImage:`url(${lr})`,backgroundSize:"cover",backgroundPosition:"center"},children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-t from-black/70 to-transparent"}),e.jsxs("div",{className:"absolute bottom-0 w-full p-4 flex justify-between items-center",children:[e.jsx("h3",{className:"font-medium text-white",children:"Кроссовки"}),e.jsx(Q,{className:"text-white",size:20})]})]}),e.jsxs(J,{to:"/shop?category=верх",className:"rounded-lg overflow-hidden relative hover-lift aspect-[5/3]",style:{backgroundImage:`url(${ir})`,backgroundSize:"cover",backgroundPosition:"center"},children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-t from-black/70 to-transparent"}),e.jsxs("div",{className:"absolute bottom-0 w-full p-4 flex justify-between items-center",children:[e.jsx("h3",{className:"font-medium text-white",children:"Верх"}),e.jsx(Q,{className:"text-white",size:20})]})]}),e.jsxs(J,{to:"/shop?category=низ",className:"rounded-lg overflow-hidden relative hover-lift aspect-[5/3]",style:{backgroundImage:`url(${cr})`,backgroundSize:"cover",backgroundPosition:"center"},children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-t from-black/70 to-transparent"}),e.jsxs("div",{className:"absolute bottom-0 w-full p-4 flex justify-between items-center",children:[e.jsx("h3",{className:"font-medium text-white",children:"Низ"}),e.jsx(Q,{className:"text-white",size:20})]})]}),e.jsxs(J,{to:"/shop?category=аксессуары",className:"rounded-lg overflow-hidden relative hover-lift aspect-[5/3]",style:{backgroundImage:`url(${dr})`,backgroundSize:"cover",backgroundPosition:"center"},children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-t from-black/70 to-transparent"}),e.jsxs("div",{className:"absolute bottom-0 w-full p-4 flex justify-between items-center",children:[e.jsx("h3",{className:"font-medium text-white",children:"Аксессуары"}),e.jsx(Q,{className:"text-white",size:20})]})]})]})]})]})},fr=r=>{const t=c=>/^[\d.,]+$/.test(c),s=c=>{const l={XXXS:1,XXS:2,XS:3,S:4,M:5,L:6,XL:7,XXL:8,XXXL:9,"3XS":1,"2XS":2,"3XL":9},i=c.toUpperCase().trim();return l[i]||999},n=r.filter(t),o=r.filter(c=>!t(c)),a=n.sort((c,l)=>parseFloat(c)-parseFloat(l)),m=o.sort((c,l)=>s(c)-s(l));return[...a,...m]},hr=()=>{const[r,t]=Ke();Z();const[s,n]=g.useState(""),[o,a]=g.useState([]),[m,c]=g.useState([]),[l,i]=g.useState([]),[h,d]=g.useState(!1),{itemCount:u}=me();te();const{data:b,isLoading:N,error:p,isError:j,refetch:_}=le({queryKey:["products"],queryFn:ve,staleTime:5*60*1e3,retry:1,retryDelay:1e3});le({queryKey:["categories"],queryFn:Oe,staleTime:5*60*1e3,retry:1,retryDelay:1e3}),g.useEffect(()=>{const f=r.get("brand"),y=r.get("category"),w=r.get("size"),I=r.get("search");f&&c(f.split(",")),y&&i(y.split(",")),w&&a(w.split(",")),I&&n(I)},[r]),g.useEffect(()=>{const f=new URLSearchParams;m.length>0&&f.set("brand",m.join(",")),l.length>0&&f.set("category",l.join(",")),o.length>0&&f.set("size",o.join(",")),s&&f.set("search",s),f.toString()!==r.toString()&&t(f)},[m,l,o,s,t,r]),g.useEffect(()=>{j&&p instanceof Error&&v.error(`Shop error: ${p.message}`)},[j,p]);const x=g.useMemo(()=>{if(!b)return[];const f=new Set;return b.forEach(y=>{Array.isArray(y.sizes)&&y.sizes.forEach(w=>{w.quantity>0&&f.add(w.size)})}),Array.from(f).sort()},[b]),k=g.useMemo(()=>{if(!b)return[];const f=new Set;return b.forEach(y=>{y.brand&&f.add(y.brand)}),Array.from(f).sort()},[b]),S=g.useMemo(()=>{if(!b)return[];const f=new Set;return b.forEach(y=>{y.category&&f.add(y.category)}),Array.from(f).sort()},[b]),D=f=>{a(y=>y.includes(f)?y.filter(w=>w!==f):[...y,f])},T=f=>{c(y=>y.includes(f)?y.filter(w=>w!==f):[...y,f])},A=f=>{i(y=>y.includes(f)?y.filter(w=>w!==f):[...y,f])},U=g.useMemo(()=>b?b.filter(f=>{const y=s===""||f.item_name.toLowerCase().includes(s.toLowerCase())||f.color_code.toLowerCase().includes(s.toLowerCase())||f.brand&&f.brand.toLowerCase().includes(s.toLowerCase()),w=o.length===0||Array.isArray(f.sizes)&&f.sizes.some(E=>o.includes(E.size)&&E.quantity>0),I=m.length===0||f.brand&&m.includes(f.brand),C=l.length===0||f.category&&l.includes(f.category);return y&&w&&I&&C}):[],[b,s,o,m,l]),W=()=>{a([]),c([]),i([]),n("")},B=f=>{a(y=>y.filter(w=>w!==f))},K=f=>{c(y=>y.filter(w=>w!==f))},se=f=>{i(y=>y.filter(w=>w!==f))},V=o.length>0||m.length>0||l.length>0||s.length>0;return e.jsx(F,{className:"pb-20",children:e.jsxs("div",{className:"p-4",children:[e.jsxs("header",{className:"mb-6",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h1",{className:"text-2xl font-semibold",children:"Магазин"}),e.jsxs(J,{to:"/cart",className:"relative flex items-center justify-center w-10 h-10 bg-telegram-button text-white rounded-full hover:bg-telegram-button/90 transition-colors","aria-label":"View Cart",children:[e.jsx(ye,{size:20,className:"text-white"}),u>0&&e.jsx("span",{className:"absolute -top-1 -right-1 bg-red-500 text-white text-xs font-bold w-5 h-5 flex items-center justify-center rounded-full",children:u})]})]}),e.jsxs("div",{className:"relative mb-4",children:[e.jsx("div",{className:"absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none",children:e.jsx(je,{size:20,className:"text-telegram-hint"})}),e.jsx("input",{type:"text",placeholder:"Искать товары...",className:"w-full p-3 pl-10 pr-4 border border-telegram-hint/30 rounded-lg bg-telegram-bg text-telegram-text focus:outline-none focus:ring-2 focus:ring-telegram-button focus:border-transparent",value:s,onChange:f=>n(f.target.value)})]}),e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("button",{className:"flex items-center gap-2 text-sm text-telegram-text",onClick:()=>d(!h),children:[e.jsx(Ge,{size:18,className:"text-telegram-hint"}),e.jsx("span",{children:h?"Скрыть фильтры":"Показать фильтры"})]}),V&&e.jsxs("button",{className:"flex items-center gap-1 text-xs text-red-500",onClick:W,children:[e.jsx(oe,{size:14}),e.jsx("span",{children:"Очистить фильтры"})]})]}),V&&e.jsxs("div",{className:"flex flex-wrap gap-2 mb-4",children:[o.map(f=>e.jsxs("span",{className:"inline-flex items-center gap-1 px-2 py-1 bg-telegram-light text-telegram-blue text-xs rounded-full",children:[e.jsx(pe,{size:12}),"Размер: ",f,e.jsx("button",{className:"ml-1",onClick:()=>B(f),children:e.jsx(oe,{size:12})})]},`filter-size-${f}`)),m.map(f=>e.jsxs("span",{className:"inline-flex items-center gap-1 px-2 py-1 bg-telegram-light text-telegram-blue text-xs rounded-full",children:[e.jsx(pe,{size:12}),"Бренд: ",f,e.jsx("button",{className:"ml-1",onClick:()=>K(f),children:e.jsx(oe,{size:12})})]},`filter-brand-${f}`)),l.map(f=>e.jsxs("span",{className:"inline-flex items-center gap-1 px-2 py-1 bg-telegram-light text-telegram-blue text-xs rounded-full",children:[e.jsx(pe,{size:12}),"Категория: ",f,e.jsx("button",{className:"ml-1",onClick:()=>se(f),children:e.jsx(oe,{size:12})})]},`filter-category-${f}`)),s&&e.jsxs("span",{className:"inline-flex items-center gap-1 px-2 py-1 bg-telegram-light text-telegram-blue text-xs rounded-full",children:[e.jsx(je,{size:12}),'"',s,'"',e.jsx("button",{className:"ml-1",onClick:()=>n(""),children:e.jsx(oe,{size:12})})]})]}),h&&e.jsxs("div",{className:"mb-4 p-4 bg-telegram-secondary-bg rounded-lg animate-slide-down space-y-4",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-sm font-medium mb-2 text-telegram-text",children:"Фильтр по размеру"}),e.jsx("div",{className:"flex flex-wrap gap-2",children:x.map(f=>e.jsx("button",{className:`px-3 py-1 text-sm rounded-full border transition-colors ${o.includes(f)?"bg-telegram-button text-telegram-button-text border-telegram-button":"bg-telegram-bg text-telegram-text border-telegram-hint/30 hover:border-telegram-hint/50"}`,onClick:()=>D(f),children:f},f))})]}),k.length>0&&e.jsxs("div",{children:[e.jsx("h3",{className:"text-sm font-medium mb-2 text-telegram-text",children:"Фильтр по бренду"}),e.jsx("div",{className:"flex flex-wrap gap-2",children:k.map(f=>e.jsx("button",{className:`px-3 py-1 text-sm rounded-full border transition-colors ${m.includes(f)?"bg-telegram-button text-telegram-button-text border-telegram-button":"bg-telegram-bg text-telegram-text border-telegram-hint/30 hover:border-telegram-hint/50"}`,onClick:()=>T(f),children:f},f))})]}),S.length>0&&e.jsxs("div",{children:[e.jsx("h3",{className:"text-sm font-medium mb-2 text-telegram-text",children:"Фильтр по категории"}),e.jsx("div",{className:"flex flex-wrap gap-2",children:S.map(f=>e.jsx("button",{className:`px-3 py-1 text-sm rounded-full border transition-colors ${l.includes(f)?"bg-telegram-button text-telegram-button-text border-telegram-button":"bg-telegram-bg text-telegram-text border-telegram-hint/30 hover:border-telegram-hint/50"}`,onClick:()=>A(f),children:f},f))})]})]})]}),j&&e.jsxs("div",{className:"p-3 bg-red-50 border border-red-300 rounded-lg mb-4",children:[e.jsx("h3",{className:"text-sm font-medium text-red-700",children:"Error Loading Products:"}),e.jsx("p",{className:"text-xs text-red-600",children:p instanceof Error?p.message:"Unknown error"})]}),N?e.jsx("div",{className:"flex justify-center items-center h-64",children:e.jsx(q,{size:"lg"})}):j?e.jsxs("div",{className:"text-center py-10",children:[e.jsx("h2",{className:"text-lg font-medium text-red-600 mb-2",children:"Ошибка загрузки товаров"}),e.jsx("p",{className:"text-gray-600 mb-4",children:"Пожалуйста, попробуйте позже"}),e.jsx("button",{className:"px-4 py-2 bg-telegram-blue text-white rounded-lg",onClick:()=>_(),children:"Попробовать снова"})]}):U.length===0?e.jsxs("div",{className:"text-center py-10",children:[e.jsx("h2",{className:"text-lg font-medium text-gray-700",children:"Товары не найдены"}),e.jsx("p",{className:"text-gray-500 mt-2",children:"Попробуйте изменить ваши фильтры или поисковый запрос"}),V&&e.jsx("button",{className:"mt-4 px-4 py-2 bg-telegram-blue text-white rounded-lg",onClick:W,children:"Очистить все фильтры"})]}):e.jsx("div",{className:"grid grid-cols-2 gap-4",children:U.map(f=>e.jsx(wt,{product:f,className:"animate-fade-in"},f.sku))})]})})},xr=()=>{const{productId:r}=Ye(),t=Z(),{addToCart:s,updateQuantity:n,getItemQuantity:o}=me(),[a,m]=g.useState(""),{data:c,isLoading:l,error:i,isError:h,refetch:d}=le({queryKey:["products"],queryFn:ve,staleTime:5*60*1e3,retry:1,retryDelay:1e3}),u=c==null?void 0:c.find(T=>T.sku===r),b=g.useMemo(()=>{if(!u)return[];if(Array.isArray(u.sizes)){const T=u.sizes.filter(A=>A.quantity>0).map(A=>A.size);return fr(T)}return[]},[u]);g.useEffect(()=>{b.length>0&&!a&&m(b[0])},[b,a]);const N=u?It(`${u.item_name}-${u.color_code}`,"product"):"📦",p=g.useMemo(()=>!u||!a?0:o(u.sku,a),[u,a,o]),j=g.useMemo(()=>!u||!u.photos?[]:Array.isArray(u.photos)?u.photos.map(T=>typeof T=="string"?T:T.photo_url||"").filter(T=>T):[],[u]),_=g.useMemo(()=>{if(!u||!a)return 0;const T=u.sizes.find(A=>A.size===a);return T?T.quantity:0},[u,a]),x=()=>{if(!u||!a)return;if(p>=_){v.error(`Извините, доступно только ${_} шт. размера ${a}`);return}Y();const T=typeof u.price_rub=="string"?parseFloat(u.price_rub.replace(/[^\d.-]/g,"")):u.price_rub,A={id:u.sku,name:u.item_name,color:u.color_code,sizes:b,price:T,quantity:1,photo_url:j.length>0?j[0]:void 0};s(A,a),Jt(u.sku,a)},k=()=>{if(!(!u||!a)){if(p>=_){v.error(`Извините, доступно только ${_} шт. размера ${a}`);return}Y(),n(u.sku,a,p+1)}},S=()=>{!u||!a||p<=0||(Y(),n(u.sku,a,p-1))},D=()=>{Y(),t("/cart")};return te(),l?e.jsx(F,{children:e.jsx("div",{className:"flex justify-center items-center h-screen",children:e.jsx(q,{size:"lg"})})}):h||!u?e.jsx(F,{children:e.jsxs("div",{className:"p-4 text-center",children:[e.jsx("h2",{className:"text-lg font-medium text-red-600 mb-2",children:h?"Ошибка загрузки товара":"Товар не найден"}),e.jsx("p",{className:"text-gray-600 dark:text-gray-400 mb-4",children:h?"Пожалуйста, попробуйте позже":"Этот товар может быть больше не доступен"}),e.jsxs("div",{className:"flex justify-center gap-4",children:[h&&e.jsx("button",{className:"px-4 py-2 bg-telegram-blue text-white rounded-lg",onClick:()=>d(),children:"Повторить"}),e.jsx("button",{className:"px-4 py-2 bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 rounded-lg",onClick:()=>t("/shop"),children:"В магазин"})]})]})}):e.jsx(F,{children:e.jsxs("div",{className:"flex flex-col min-h-screen",children:[e.jsx(vt,{photos:j,productName:u.item_name,fallbackEmoji:N}),e.jsxs("div",{className:"p-4 flex-1",children:[e.jsxs("div",{className:"flex justify-between items-start mb-4",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold mb-2",children:u.item_name}),e.jsxs("div",{className:"flex items-center gap-2",children:[u.brand&&e.jsx(J,{to:`/shop?brand=${encodeURIComponent(u.brand)}`,className:"px-2 py-1 bg-gray-100 dark:bg-gray-800 text-gray-800 dark:text-gray-200 text-xs rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors",children:u.brand}),e.jsx("span",{className:"px-2 py-1 bg-telegram-light dark:bg-telegram-dark/20 text-telegram-blue dark:text-telegram-blue text-xs rounded-full",children:u.color_code})]})]}),e.jsxs("p",{className:"text-2xl font-bold text-telegram-blue",children:["₽",typeof u.price_rub=="string"?parseFloat(u.price_rub.replace(/[^\d.-]/g,"")).toLocaleString():u.price_rub.toLocaleString()]})]}),e.jsxs("div",{className:"mb-6",children:[e.jsx("h2",{className:"font-medium mb-2",children:"Выберите размер"}),e.jsx(jt,{availableSizes:b,selectedSize:a,onChange:m})]}),e.jsx("div",{className:"mb-6",children:u.description&&e.jsxs(e.Fragment,{children:[e.jsx("h2",{className:"font-medium mb-2",children:"Описание"}),e.jsx("p",{className:"text-gray-700 dark:text-gray-300 text-sm",children:u.description})]})}),e.jsx("div",{className:"h-2"}),e.jsx("div",{className:"fixed bottom-0 left-0 right-0 z-50 bg-white dark:bg-sidebar-primary border-t border-gray-200 dark:border-gray-800 pb-16",children:e.jsx("div",{className:"max-w-md mx-auto px-4 py-4",children:a&&e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("span",{className:"font-medium",children:["Размер: ",a]}),o(u.sku,a)>0&&e.jsxs("span",{className:"text-sm text-gray-500",children:["В корзине: ",o(u.sku,a)," шт."]})]}),o(u.sku,a)===0?e.jsxs("button",{onClick:x,disabled:!a||b.length===0,className:"w-full py-3 px-4 bg-telegram-blue text-white rounded-lg flex items-center justify-center gap-2 hover:bg-telegram-dark transition-colors disabled:opacity-50 disabled:cursor-not-allowed",children:[e.jsx(De,{size:20}),e.jsx("span",{children:"Добавить в корзину"})]}):e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("button",{onClick:D,className:"flex-1 py-3 px-4 bg-telegram-blue text-white rounded-lg flex items-center justify-center gap-2 hover:bg-telegram-dark transition-colors",children:[e.jsx(ye,{size:20}),e.jsx("span",{children:"Перейти в корзину"})]}),e.jsxs("div",{className:"flex items-center justify-between border border-gray-200 dark:border-gray-700 rounded-lg p-1",children:[e.jsx("button",{onClick:S,className:"w-10 h-10 flex items-center justify-center text-telegram-text bg-gray-100 dark:bg-gray-800 rounded-md",children:e.jsx(Ve,{size:18})}),e.jsx("span",{className:"font-medium px-4",children:o(u.sku,a)}),e.jsx("button",{onClick:k,className:"w-10 h-10 flex items-center justify-center text-telegram-text bg-gray-100 dark:bg-gray-800 rounded-md",children:e.jsx(Qe,{size:18})})]})]})]})})})]})]})})},Fe=g.createContext(null),br=({children:r})=>{var c,l,i;const t=typeof window<"u"?(c=window.Telegram)==null?void 0:c.WebApp:void 0,m={tg:t,onClose:()=>{t&&t.close()},onToggleButton:()=>{var h;(h=t==null?void 0:t.MainButton)!=null&&h.isVisible?t.MainButton.hide():t!=null&&t.MainButton&&t.MainButton.show()},initWebApp:()=>{console.log("Initializing Telegram WebApp with direct access..."),t?(t.ready(),console.log("Telegram WebApp initialized successfully")):console.error("Telegram WebApp is not available")},getUserData:()=>{var h;if((h=t==null?void 0:t.initDataUnsafe)!=null&&h.user){console.log("User data found in initDataUnsafe:",t.initDataUnsafe.user);try{localStorage.setItem("telegramUser",JSON.stringify(t.initDataUnsafe.user))}catch(d){console.error("Error storing user data in localStorage:",d)}return t.initDataUnsafe.user}console.log("No user data found in initDataUnsafe");try{const d=localStorage.getItem("telegramUser");if(d){const u=JSON.parse(d);return console.log("Using stored user data from localStorage:",u),u}}catch(d){console.error("Error retrieving user data from localStorage:",d)}return null},user:(l=t==null?void 0:t.initDataUnsafe)==null?void 0:l.user,queryId:(i=t==null?void 0:t.initDataUnsafe)==null?void 0:i.query_id};return e.jsx(Fe.Provider,{value:m,children:r})},yr=()=>{const r=g.useContext(Fe);if(!r)throw new Error("useTelegram must be used within a TelegramProvider");return r},wr=()=>{const{username:r,displayName:t,telegramUser:s,profile:n,avatarEmoji:o,updateTelegramUser:a}=ue(),[m,c]=g.useState(!0),[l,i]=g.useState(0),[h,d]=g.useState(!1),[u,b]=g.useState(!1),N=Z(),{tg:p,initWebApp:j,getUserData:_}=yr();te(),g.useEffect(()=>{(async()=>{try{console.log("Initializing Telegram WebApp on Profile page..."),j();const W=_();if(W){console.log("Telegram user found on Profile page:",W),a(W);const B=await re(!0);B&&typeof B!="boolean"?(c(!0),i(B.dd_coins_balance),d(!1)):c(!1)}else console.log("No Telegram user data found on Profile page"),setTimeout(async()=>{const B=_();if(B){console.log("Telegram user found after delay:",B),a(B);const K=await re(!0);K&&typeof K!="boolean"?(c(!0),i(K.dd_coins_balance),d(!1)):c(!1)}else console.log("Still no Telegram user data after retry")},500)}catch(W){console.error("Error initializing Telegram on Profile page:",W)}})()},[a,j,_,p]);const{data:x,isLoading:k,error:S,isError:D,refetch:T}=le({queryKey:["orders"],queryFn:Be,staleTime:60*1e3,retry:1,retryDelay:1e3,enabled:m});if(k)return e.jsx(F,{children:e.jsx("div",{className:"flex justify-center items-center h-64",children:e.jsx(q,{size:"lg"})})});if(D&&S instanceof Error&&!S.message.includes("not found"))return e.jsx(F,{className:"pb-20",children:e.jsxs("div",{className:"p-4 text-center",children:[e.jsx("h2",{className:"text-lg font-medium text-red-600 dark:text-red-400 mb-2",children:"Error loading profile"}),e.jsx("p",{className:"text-gray-600 dark:text-gray-400 mb-4",children:S instanceof Error?S.message:"Please try again later"}),e.jsx("button",{className:"px-4 py-2 bg-telegram-blue text-white rounded-lg",onClick:()=>T(),children:"Retry"})]})});const A=x||[];return e.jsx(F,{className:"pb-32",children:e.jsxs("div",{className:"p-4 relative",children:[e.jsxs("div",{className:"flex items-center justify-between mb-8 animate-fade-in",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx(Pe,{user:s,emoji:o,size:"lg",className:"hover-lift"}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-semibold",children:s!=null&&s.username?`@${s.username}`:t}),s&&e.jsxs("p",{className:"text-gray-600 dark:text-gray-400",children:[s.first_name," ",s.last_name||""]})]})]}),e.jsx("button",{onClick:()=>N("/settings"),className:"w-10 h-10 flex items-center justify-center rounded-full bg-telegram-light dark:bg-sidebar-accent hover:bg-telegram-secondary-bg dark:hover:bg-sidebar-primary transition-colors","aria-label":"Settings",children:e.jsx(Ze,{size:20,className:"text-telegram-blue"})})]}),e.jsx("div",{className:"mb-8 bg-telegram-blue dark:bg-telegram-blue rounded-lg p-5 shadow-sm animate-slide-up text-white",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(Ae,{size:28,className:"text-yellow-400"}),e.jsxs("div",{className:"flex items-baseline gap-3",children:[e.jsx("h2",{className:"text-xl font-semibold text-white",children:"$DD Баланс:"}),h?e.jsx(q,{size:"sm",className:"text-white ml-2"}):e.jsx("span",{className:"text-3xl font-bold text-white",children:l||0})]})]}),e.jsx("button",{onClick:()=>b(!0),className:"text-white hover:bg-white/20 rounded-full p-2 transition-colors","aria-label":"DD Coins Information",children:e.jsx(Xe,{size:22})})]})}),e.jsxs("div",{className:"mb-8",children:[e.jsx("h2",{className:"text-xl font-medium mb-4",children:"Пригласи друзей"}),e.jsxs("div",{className:"bg-white dark:bg-sidebar-accent rounded-lg shadow-sm overflow-hidden",children:[e.jsx(Nt,{className:"animate-fade-in"}),e.jsx("div",{className:"p-4 border-b border-gray-100 dark:border-gray-800/50",children:e.jsx("p",{className:"text-sm text-gray-600 dark:text-gray-400",children:"*Поделись своей реферальной ссылкой с друзьями и получай награду в $DD, когда они присоединятся и сделают покупки!"})})]})]}),e.jsxs("div",{className:"grid grid-cols-3 gap-4 mb-8 animate-slide-up",children:[e.jsxs("div",{className:"bg-white dark:bg-sidebar-accent rounded-lg p-4 text-center shadow-sm",children:[e.jsx("h2",{className:"text-xl font-semibold text-telegram-blue",children:A.length}),e.jsx("p",{className:"text-gray-600 dark:text-gray-400 text-sm",children:"Всего заказов"})]}),e.jsxs("div",{className:"bg-white dark:bg-sidebar-accent rounded-lg p-4 text-center shadow-sm",children:[e.jsx("h2",{className:"text-xl font-semibold text-telegram-blue",children:A.filter(U=>U.status==="delivered").length}),e.jsx("p",{className:"text-gray-600 dark:text-gray-400 text-sm",children:"Завершенных"})]}),e.jsxs("div",{className:"bg-white dark:bg-sidebar-accent rounded-lg p-4 text-center shadow-sm",children:[e.jsx("h2",{className:"text-xl font-semibold text-telegram-blue",children:A.filter(U=>U.status!=="delivered").length}),e.jsx("p",{className:"text-gray-600 dark:text-gray-400 text-sm",children:"Активных"})]})]}),e.jsxs("div",{className:"mb-8",children:[e.jsx("h2",{className:"text-xl font-medium mb-4",children:"История заказов"}),x&&x.length>0?e.jsx("div",{className:"space-y-4",children:x.map(U=>e.jsx(kt,{order:U},U.order_id))}):e.jsxs("div",{className:"p-6 text-center bg-telegram-secondary-bg rounded-lg",children:[e.jsx("h3",{className:"font-medium text-lg mb-2",children:"Еще нет заказов"}),e.jsx("p",{className:"text-gray-600 dark:text-gray-400 mb-4",children:"Вы еще не сделали ни одного заказа. Начните покупки, чтобы увидеть их здесь."}),e.jsx("button",{onClick:()=>N("/shop"),className:"px-4 py-2 bg-telegram-blue text-white rounded-lg",children:"В магазин!"})]})]}),e.jsx("div",{className:"h-16"}),e.jsx(_t,{isOpen:u,onClose:()=>b(!1)})]})})},Lr=async r=>{try{const t=O();if(!t)throw new Error("No Telegram user data available");const{options:s,clearTimeout:n}=R("POST",{telegram_id:t.id,promocode_text:r}),o=await fetch(`${M}/promocodes/validate`,s);if(n(),!o.ok){const m=await o.text();throw new Error(m||"Failed to validate promocode")}return await o.json()}catch(t){throw console.error("Error validating promocode:",t),t}},Wr=(r,t)=>{let s=r;if(t.discount_fixed>0&&(s=Math.max(0,s-t.discount_fixed)),t.discount_percent&&t.discount_percent!=="null"){const n=s*parseFloat(t.discount_percent)/100;s=Math.max(0,s-n)}return Math.round(s)},vr=()=>{const{items:r,removeFromCart:t,clearCart:s}=me(),[n,o]=g.useState(!1),[a,m]=g.useState(!1),[c,l]=g.useState(!1),[i,h]=g.useState(),[d,u]=g.useState(0),[b,N]=g.useState(0),[p,j]=g.useState(0),[_,x]=g.useState(!1),[k,S]=g.useState(null),[D,T]=g.useState(null);te(),g.useEffect(()=>{(async()=>{if(O()){x(!0);try{const I=await ze();N(I)}catch(I){console.error("Error fetching DD coins balance:",I)}finally{x(!1)}}})()},[]),g.useEffect(()=>{const y=r.reduce((w,I)=>w+(I.sale_price||I.price)*I.quantity,0);if(i){let w=y;if(i.discount_fixed&&(w=Math.max(0,w-i.discount_fixed)),i.discount_percent&&i.discount_percent!=="null"){const I=w*parseFloat(i.discount_percent)/100;w=Math.max(0,w-I)}k&&(w+=k.price_rub),u(Math.round(w))}else{let w=y;k&&(w+=k.price_rub),u(w)}j(0)},[r,i,k]);const A=Math.min(b,Math.floor(d*.5)),U=d-p,W=y=>{const w=parseInt(y.target.value);j(w)},B=(y,w)=>{h(y),u(Math.round(w))},K=()=>{h(void 0),u(r.reduce((y,w)=>y+(w.sale_price||w.price)*w.quantity,0))},se=async()=>{try{if(o(!0),r.length===0){v.error("Ваша корзина пуста!"),o(!1);return}if(!O()){v.error("Пожалуйста, войдите, чтобы создать заказ"),o(!1);return}try{const w=await xe();T(w?{email:w.email||"",phone_number:w.phone_number||"",address:w.address||""}:null),l(!0),o(!1)}catch(w){console.error("Error getting client information:",w),v.error("Ошибка загрузки данных. Пожалуйста, попробуйте позже."),o(!1)}}catch(y){console.error("Error in order creation process:",y),v.error(`Error: ${y.message}`),o(!1)}},V=y=>{l(!1),y?S(y):alert("No delivery rate provided"),f(y)},f=async y=>{try{o(!0);const w=O();if(!w){v.error("Пожалуйста, войдите, чтобы создать заказ");return}const I=await xe(),C=r.map(P=>{if(P.item_type==="preorder"){let ge=P.category_type;return ge==="shoes"&&(ge="sneakers"),{item_type:"preorder",dewu_url:P.dewu_url,size:P.size,category_type:ge,shipping_type:P.shipping_type||(P.delivery_type==="cargo"?"cargo":"aero"),price_cny:P.price_cny||Math.round(P.price/12),quantity:P.quantity}}else return{item_type:"stock",stock_id:parseInt(P.productId)||void 0,sku:parseInt(P.productId)?void 0:P.productId,size:P.size,quantity:P.quantity}}),E={telegram_user_id:w.id,delivery_method:(y==null?void 0:y.delivery_type)||"self_pickup",delivery_address:(I==null?void 0:I.address)||"",promocode_text:i==null?void 0:i.promocode_text,dd_coins_amount:p,items:C,final_price:U};console.log("Creating unified order with data:",JSON.stringify(E));const L=await Ht(E);L.success?(s(),v.success("Заказ создан успешно")):v.error(L.message||"Не удалось создать заказ. Пожалуйста, попробуйте позже.")}catch(w){console.error("Error creating order:",w),v.error("Ошибка при создании заказа. Пожалуйста, попробуйте позже."),o(!1)}};return e.jsxs(F,{className:"pb-20",children:[e.jsxs("div",{className:"max-w-4xl mx-auto px-4 py-4",children:[e.jsx("h1",{className:"text-2xl font-bold mb-6",children:"Корзина"}),r.length===0?e.jsxs("div",{className:"text-center py-12",children:[e.jsx(ye,{className:"mx-auto h-12 w-12 text-gray-400"}),e.jsx("h3",{className:"mt-4 text-lg font-medium text-gray-900 dark:text-gray-100",children:"Ваша корзина пуста"}),e.jsx("p",{className:"mt-2 text-sm text-gray-500 dark:text-gray-400",children:"Добавьте товары в корзину, чтобы продолжить покупки"}),e.jsxs(J,{to:"/shop",className:"mt-6 inline-flex items-center text-sm font-medium text-telegram-blue hover:text-telegram-dark",children:[e.jsx(et,{className:"mr-2 h-4 w-4"}),"Продолжить покупки"]})]}):e.jsxs("div",{children:[e.jsx("div",{className:"space-y-4",children:r.map(y=>e.jsx(Tt,{item:y,onRemove:()=>t(y.productId,y.size)},`${y.productId}-${y.size}`))}),e.jsxs("div",{className:"bg-white dark:bg-sidebar-accent rounded-lg p-4 shadow-sm mb-4 mt-6",children:[e.jsx("h3",{className:"text-sm font-medium mb-2",children:"У вас есть промокод?"}),e.jsx(St,{originalPrice:r.reduce((y,w)=>y+(w.sale_price||w.price)*w.quantity,0),onPromocodeApplied:B,onPromocodeRemoved:K,currentPromocode:i})]}),e.jsxs("div",{className:"bg-white dark:bg-sidebar-accent rounded-lg p-4 shadow-sm mb-2",children:[e.jsx("h3",{className:"text-lg font-medium mb-4",children:"Информация о заказе"}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-600 dark:text-gray-400",children:"Сумма товаров"}),e.jsxs("span",{children:["₽",r.reduce((y,w)=>y+(w.sale_price||w.price)*w.quantity,0)]})]}),k&&e.jsxs("div",{className:"flex justify-between",children:[e.jsxs("span",{className:"text-gray-600 dark:text-gray-400",children:["Доставка (",k.delivery_type==="self_pickup"?"Самовывоз":k.delivery_type==="courier"?"Курьер":"Почта",")"]}),e.jsx("span",{children:k.price_rub>0?`₽${k.price_rub.toLocaleString()}`:"Бесплатно"})]}),i&&e.jsxs("div",{className:"flex justify-between text-telegram-blue",children:[e.jsx("span",{children:"Скидка по промокоду"}),e.jsx("span",{children:i.discount_fixed?`-₽${i.discount_fixed}`:i.discount_percent&&i.discount_percent!=="null"?`-${i.discount_percent}%`:""})]}),b>0&&d>0&&e.jsxs("div",{className:"pt-3 border-t border-gray-200 dark:border-gray-700",children:[e.jsxs("div",{className:"flex justify-between items-center mb-2",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(Ae,{size:16,className:"text-yellow-500"}),e.jsx("span",{className:"font-medium",children:"DD Коины"})]}),e.jsxs("span",{className:"text-sm text-gray-600 dark:text-gray-400",children:["Баланс: ",b]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{children:"Использовать DD Коины для оплаты"}),e.jsxs("span",{className:"text-telegram-blue",children:[p," коинов (-₽",p,")"]})]}),e.jsx("input",{type:"range",min:"0",max:A,value:p,onChange:W,className:"w-full",disabled:A<=0}),e.jsxs("div",{className:"flex justify-between text-xs text-gray-500",children:[e.jsx("span",{children:"0"}),e.jsxs("span",{children:["Макс: ",A," коинов (50% от суммы)"]})]})]})]}),e.jsxs("div",{className:"flex justify-between font-medium pt-2 border-t border-gray-200 dark:border-gray-700",children:[e.jsx("span",{children:"Итого"}),e.jsxs("span",{children:["₽",U]})]})]}),e.jsx("button",{onClick:se,disabled:n||a,className:"w-full mt-4 bg-telegram-blue text-white py-3 rounded-lg font-medium hover:bg-telegram-dark transition-colors disabled:opacity-50 disabled:cursor-not-allowed",children:n||a?e.jsxs(e.Fragment,{children:[e.jsx(q,{size:"xs",inline:!0,className:"mr-2"}),a?"Проверка данных...":"Создание заказа..."]}):"Оформить заказ"})]})]})]}),c&&e.jsx(Ct,{onComplete:V,onCancel:()=>l(!1),clientInfo:D})]})},jr=()=>{const r=Z();return e.jsx(F,{fullHeight:!0,children:e.jsxs("div",{className:"min-h-screen flex flex-col items-center justify-center p-4 text-center",children:[e.jsx("div",{className:"text-8xl mb-4 animate-float",children:"🔍"}),e.jsx("h1",{className:"text-4xl font-bold mb-4",children:"404"}),e.jsx("p",{className:"text-xl text-gray-600 mb-6",children:"Oops! We couldn't find that page"}),e.jsx("button",{onClick:()=>r("/"),className:"px-6 py-3 bg-telegram-blue text-white rounded-lg hover:bg-telegram-dark transition-colors",children:"Return to Home"})]})})},Nr=r=>r.split(" ").map(t=>t.charAt(0).toUpperCase()+t.slice(1).toLowerCase()).join(" "),kr=()=>{te();const{addPreorderToCart:r}=me(),[t,s]=g.useState(""),[n,o]=g.useState(""),[a,m]=g.useState("car"),[c,l]=g.useState(""),[i,h]=g.useState(""),[d,u]=g.useState(!1),[b,N]=g.useState(!1),[p,j]=g.useState([]),[_,x]=g.useState(!1),[k,S]=g.useState(""),[D,T]=g.useState(""),[A,U]=g.useState(null);g.useEffect(()=>{(async()=>{x(!0);try{const E=await Oe();j(E);const L=E.find(P=>P.name.toLowerCase()==="обувь");L?o(L.name):E.length>0&&o(E[0].name)}catch(E){console.error("Failed to load categories:",E),v.error("Failed to load item categories")}finally{x(!1)}})()},[]);const W=async()=>{if(!t||k){v.error("Введите корректную цену для расчёта");return}if(!n){v.error("Выберите категорию товара");return}const C=B(n);if(!C){v.error("Неверный тип категории");return}u(!0);try{const E=parseInt(t),L=await Mt(E,a,C);U(L)}catch(E){console.error("Error calculating shipping:",E),v.error(`Ошибка расчёта доставки: ${E.message}`),U(null)}finally{u(!1)}},B=C=>C.toLowerCase(),K=C=>{const E=C.target.value;E&&!/^\d+$/.test(E)?S("Введите только цифры"):S(""),s(E)},se=C=>{const E=C.target.value,L=V(E),P=L||E;P&&!f(P)?T("Введите корректную ссылку"):T(""),l(L||E)},V=C=>{const E=[/https?:\/\/dw4\.co\/[^\s]+/i,/https?:\/\/m\.dewu\.com\/[^\s]+/i,/https?:\/\/www\.dewu\.com\/[^\s]+/i,/https?:\/\/dewu\.com\/[^\s]+/i];for(const L of E){const P=C.match(L);if(P&&P[0])return console.log("Extracted DEWU URL:",P[0]),P[0]}return null},f=C=>{try{return new URL(C),!0}catch{return!1}},y=C=>{Y(),o(C.target.value),U(null)},w=C=>{Y(),m(C),U(null)},I=async()=>{if(!c){v.error("Введите ссылку на товар");return}if(D){v.error("Введите корректную ссылку на товар");return}if(!A){v.error("Сначала рассчитайте стоимость");return}const C=B(n);if(!C){v.error("Неверный тип категории");return}N(!0);try{const E=t?parseInt(t):0;r({dewu_url:c,size:i||"Не указан",category_type:C,shipping_type:a==="car"?"cargo":"aero",price:A,price_cny:E,name:`Предзаказ - ${C==="обувь"?"Обувь":C==="одежда"?"Одежда":C==="аксессуары"?"Аксессуары":n} - ${i||"Размер не указан"}`}),v.success("Предзаказ добавлен в корзину"),l(""),h(""),U(null)}catch(E){console.error("Error adding preorder to cart:",E),v.error("Ошибка при добавлении предзаказа в корзину")}finally{N(!1)}};return e.jsx(F,{className:"pb-20",children:e.jsxs("div",{className:"p-4",children:[e.jsxs("div",{className:"flex items-center mb-6",children:[e.jsx(tt,{className:"mr-2 text-telegram-blue",size:24}),e.jsx("h1",{className:"text-2xl font-semibold",children:"Калькулятор доставки"})]}),e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"block text-sm font-medium",children:"Цена товара (юани)"}),e.jsx("input",{type:"text",value:t,onChange:K,placeholder:"Введите цену в юанях",className:`w-full p-3 rounded-lg border ${k?"border-red-500":"border-gray-300 dark:border-gray-700"} bg-white dark:bg-sidebar-accent`}),k&&e.jsx("p",{className:"text-red-500 text-sm",children:k}),e.jsx("div",{className:"flex items-center text-xs text-telegram-hint",children:e.jsxs("a",{onClick:()=>Te("https://telegra.ph/Poisk-i-kartochka-tovara-ceny-razmernaya-setka-i-sroki-dostavki-04-11"),className:"flex items-center text-telegram-link",children:["Как проверить цену? ",e.jsx(Ne,{size:12,className:"ml-1"})]})})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"block text-sm font-medium",children:"Категория товара"}),e.jsx("select",{value:n,onChange:y,className:"w-full p-3 rounded-lg border border-gray-300 dark:border-gray-700 bg-white dark:bg-sidebar-accent",disabled:_,children:_?e.jsx("option",{value:"",children:"Загрузка категорий..."}):p.length===0?e.jsx("option",{value:"",children:"Нет доступных категорий"}):p.map(C=>e.jsx("option",{value:C.name,children:Nr(C.name)},C.id))})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"block text-sm font-medium",children:"Тип доставки"}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("button",{type:"button",onClick:()=>w("car"),className:`p-3 rounded-lg flex flex-col items-center justify-center ${a==="car"?"bg-telegram-blue text-white":"bg-white dark:bg-sidebar-accent border border-gray-300 dark:border-gray-700"}`,children:[e.jsx(rt,{size:24,className:"mb-2"}),e.jsx("span",{className:"font-medium",children:"Автомобиль"}),e.jsx("span",{className:"text-xs mt-1 opacity-80",children:"21-35 дней"})]}),e.jsxs("button",{type:"button",onClick:()=>w("plane"),className:`p-3 rounded-lg flex flex-col items-center justify-center ${a==="plane"?"bg-telegram-blue text-white":"bg-white dark:bg-sidebar-accent border border-gray-300 dark:border-gray-700"}`,children:[e.jsx(st,{size:24,className:"mb-2"}),e.jsx("span",{className:"font-medium",children:"Самолет"}),e.jsx("span",{className:"text-xs mt-1 opacity-80",children:"5-10 дней"})]})]})]}),e.jsx("button",{type:"button",onClick:W,disabled:d||!t||!!k||!n,className:"w-full bg-green-600 text-white p-4 rounded-lg font-medium disabled:opacity-50 disabled:cursor-not-allowed",children:d?e.jsxs(e.Fragment,{children:[e.jsx(q,{size:"xs",inline:!0,className:"mr-2"}),"Идет расчет..."]}):"Рассчитать стоимость доставки"}),A!==null&&e.jsxs("div",{className:"mt-8 p-4 bg-telegram-secondary-bg rounded-lg",children:[e.jsx("h2",{className:"text-lg font-medium mb-2",children:"Предварительная стоимость"}),e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{children:"Итоговая цена:"}),e.jsxs("span",{className:"text-2xl font-bold text-telegram-blue",children:["₽",A.toLocaleString()]})]}),e.jsx("div",{className:"mt-4 text-xs text-telegram-hint",children:e.jsx("p",{children:"Включает стоимость товара, доставки и комиссии"})})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("label",{className:"block text-sm font-medium",children:["Ссылка на товар ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx("input",{type:"text",value:c,onChange:se,placeholder:"Вставьте ссылку Poizon (DEWU)",className:`w-full p-3 rounded-lg border ${D?"border-red-500":"border-gray-300 dark:border-gray-700"} bg-white dark:bg-sidebar-accent`}),D&&e.jsx("p",{className:"text-red-500 text-sm",children:D}),e.jsx("div",{className:"flex items-center text-xs text-telegram-hint",children:e.jsxs("a",{onClick:()=>Te("https://telegra.ph/Gde-vzyat-ssylku-na-tovar-v-POIZON-05-10"),className:"flex items-center text-telegram-link",children:["Как получить ссылку? ",e.jsx(Ne,{size:12,className:"ml-1"})]})})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"block text-sm font-medium",children:"Размер (Необязательно)"}),e.jsx("input",{type:"text",value:i,onChange:C=>h(C.target.value),placeholder:"например, 42, XL и т.д.",className:"w-full p-3 rounded-lg border border-gray-300 dark:border-gray-700 bg-white dark:bg-sidebar-accent"})]}),A!==null&&e.jsx("button",{onClick:I,disabled:b||!c||!!D,className:"w-full mt-4 bg-telegram-blue text-white py-3 rounded-lg font-medium hover:bg-telegram-dark transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2",children:b?e.jsxs(e.Fragment,{children:[e.jsx(q,{size:"xs",inline:!0,className:"mr-2"}),"Добавление в корзину..."]}):e.jsxs(e.Fragment,{children:[e.jsx(De,{size:20}),"Добавить в корзину"]})})]})]})})},_r=()=>{const r=Z();ue(),te();const[t,s]=g.useState(""),[n,o]=g.useState(""),[a,m]=g.useState(""),[c,l]=g.useState(!0),[i,h]=g.useState(!1),[d,u]=g.useState(!0),[b,N]=g.useState(!1);g.useState("light"),g.useState(!1),g.useEffect(()=>{(async()=>{u(!0);try{const _=await xe();_&&(s(_.email||""),o(_.phone_number||""),m(_.address||""),l(_.mailing_flg!==void 0?_.mailing_flg:!0))}catch(_){console.error("Error loading client info:",_)}finally{u(!1)}})()},[]);const p=async j=>{j.preventDefault(),h(!0);try{if(!t.trim()){v.error("Пожалуйста, введите ваш email"),h(!1);return}if(!n.trim()){v.error("Пожалуйста, введите ваш номер телефона"),h(!1);return}if(!a.trim()){v.error("Пожалуйста, введите ваш адрес"),h(!1);return}await Kt(n,t,a,c)&&r("/profile")}catch(_){console.error("Error saving settings:",_),v.error("Ошибка сохранения настроек. Пожалуйста, попробуйте позже.")}finally{h(!1)}};return e.jsx(F,{children:e.jsxs("div",{className:"p-4",children:[e.jsxs("div",{className:"flex items-center gap-4 mb-6",children:[e.jsx("button",{onClick:()=>r("/profile"),className:"w-8 h-8 flex items-center justify-center rounded-full bg-gray-100 dark:bg-gray-800",children:e.jsx(ot,{size:18})}),e.jsx("h1",{className:"text-xl font-semibold",children:"Настройки"})]}),d?e.jsx("div",{className:"flex items-center justify-center py-8",children:e.jsx(q,{size:"md"})}):e.jsxs("form",{onSubmit:p,className:"space-y-6",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{htmlFor:"email",className:"text-sm font-medium text-gray-700 dark:text-gray-300",children:"Адрес электронной почты *"}),e.jsx("input",{id:"email",type:"email",value:t,onChange:j=>s(j.target.value),className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded-md shadow-sm focus:outline-none focus:ring-telegram-blue focus:border-telegram-blue dark:bg-gray-800",placeholder:"your@email.com",required:!0})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{htmlFor:"phone",className:"text-sm font-medium text-gray-700 dark:text-gray-300",children:"Номер телефона *"}),e.jsx("input",{id:"phone",type:"tel",value:n,onChange:j=>o(j.target.value),className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded-md shadow-sm focus:outline-none focus:ring-telegram-blue focus:border-telegram-blue dark:bg-gray-800",placeholder:"+7 (999) 123-4567",required:!0})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{htmlFor:"address",className:"text-sm font-medium text-gray-700 dark:text-gray-300",children:"Адрес *"}),e.jsx("textarea",{id:"address",value:a,onChange:j=>m(j.target.value),className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded-md shadow-sm focus:outline-none focus:ring-telegram-blue focus:border-telegram-blue dark:bg-gray-800",placeholder:"Ваш полный адрес",rows:3,required:!0})]}),e.jsx("div",{className:"space-y-1",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(at,{size:18,className:"text-gray-600 dark:text-gray-400"}),e.jsx("label",{htmlFor:"mailing",className:"text-sm font-medium text-gray-700 dark:text-gray-300",children:"Получать уведомления"})]}),e.jsx("button",{type:"button",id:"mailing",onClick:()=>l(!c),className:`relative inline-flex items-center h-6 rounded-full w-11 transition-colors focus:outline-none focus:ring-2 focus:ring-telegram-blue focus:ring-offset-2 ${c?"bg-telegram-blue":"bg-gray-300 dark:bg-gray-600"}`,children:e.jsx("span",{className:`inline-block w-4 h-4 transform transition-transform bg-white rounded-full ${c?"translate-x-6":"translate-x-1"}`})})]})}),e.jsx("button",{type:"submit",disabled:i,className:"w-full flex items-center justify-center gap-2 bg-telegram-blue text-white py-2 px-4 rounded-md hover:bg-telegram-dark transition-colors disabled:opacity-50 disabled:cursor-not-allowed",children:i?e.jsxs(e.Fragment,{children:[e.jsx(q,{size:"xs",inline:!0,className:"mr-2"}),"Сохраняем..."]}):e.jsxs(e.Fragment,{children:[e.jsx(nt,{size:16}),"Сохранить"]})})]}),b&&e.jsx("div",{className:"flex justify-center py-6",children:e.jsx(q,{size:"md"})})]})})},Tr=new lt({defaultOptions:{queries:{refetchOnWindowFocus:!1,staleTime:1e3*60*5}}}),Sr=()=>{var r;return{tg:(r=window.Telegram)==null?void 0:r.WebApp,initWebApp:()=>{var t,s,n;console.log("Mock initWebApp called"),(t=window.Telegram)!=null&&t.WebApp&&((n=(s=window.Telegram.WebApp).ready)==null||n.call(s))},getUserData:()=>{var t,s,n;if(console.log("Mock getUserData called"),(n=(s=(t=window.Telegram)==null?void 0:t.WebApp)==null?void 0:s.initDataUnsafe)!=null&&n.user)return window.Telegram.WebApp.initDataUnsafe.user;try{const o=localStorage.getItem("telegramUser");if(o)return JSON.parse(o)}catch(o){console.error("Error retrieving user data from localStorage:",o)}return null}}},Cr=({children:r})=>{const t=gt(),s=Z(),{updateTelegramUser:n}=ue(),[o,a]=g.useState(!1),[m,c]=g.useState(!0),{tg:l,initWebApp:i,getUserData:h}=Sr(),{referralCode:d,isProcessing:u}=er();tr({onNewUser:p=>{p&&d&&(console.log(`New user registered with referral code: ${d}`),v.success("Добро пожаловать! Вас пригласил друг."))}}),g.useEffect(()=>{const p=Wt();return()=>{p()}},[]);const b=g.useCallback(async()=>{try{const p=await re(!0);console.log("API user check result:",p),p&&typeof p!="boolean"&&p.is_new_client&&p.dd_coins_balance===500&&setTimeout(()=>{v.success("Добро пожаловать! Только что начислили вам 500 $DD коинов в честь нашего знакомства!",{duration:6e3})},1500)}catch(p){console.error("Error checking user in API:",p)}},[]),N=g.useCallback(async()=>{if(o)return;console.log("Initializing Telegram interface...");const p=navigator.userAgent.toLowerCase().includes("telegram")||window.location.href.includes("tgwebapp");console.log(p?"Running in Telegram browser":"Not running in Telegram browser");try{if(l){i(),H(),ae(),await new Promise(_=>setTimeout(_,300));const j=h();j?(console.log("User data retrieved:",j),n(j),await b(),a(!0),c(!1)):p?(console.log("No user data available despite being in Telegram browser"),setTimeout(()=>{const _=h();if(_)console.log("User data retrieved after delay:",_),n(_);else{console.log("Still no user data after retry. This might indicate:"),console.log("1. The Mini App is not properly configured in BotFather"),console.log("2. The user is not using the official Telegram app"),console.log("3. There's an issue with the initData validation");try{const x=localStorage.getItem("telegramUser");if(x){const k=JSON.parse(x);console.log("Using stored user data from localStorage:",k),n(k)}}catch(x){console.error("Error retrieving user data from localStorage:",x)}}a(!0),c(!1)},800)):(console.log("Not in Telegram browser, continuing without user data"),a(!0),c(!1))}else{console.log("Telegram WebApp is not available, using fallback method"),Bt(),H(),await new Promise(_=>setTimeout(_,300));const j=we();j&&(console.log("User data retrieved using fallback method:",j),n(j)),a(!0),c(!1)}}catch(j){console.error("Error during Telegram initialization:",j),a(!0),c(!1)}},[o,n,l,i,h,b]);return g.useEffect(()=>(["/","/calculator","/shop"].includes(t.pathname)?(console.log("Hiding back button for path:",t.pathname),_e()):(console.log("Showing back button for path:",t.pathname),Lt(()=>{console.log("Back button pressed, navigating back"),s(-1)})),()=>{_e()}),[t.pathname,s]),g.useEffect(()=>{["/","/calculator","/cart","/product"].some(_=>t.pathname===_||t.pathname.startsWith("/product/"))&&(console.log("Scrolling to top for path:",t.pathname),window.scrollTo({top:0,behavior:"smooth"}))},[t.pathname]),g.useEffect(()=>{console.log("Setting up theme change listener"),ae(),H();const p=()=>{console.log("Theme change detected, adapting to user theme"),H()};return window.addEventListener("themechange",p),()=>{window.removeEventListener("themechange",p)}},[]),g.useEffect(()=>{N().finally(()=>{c(!1)})},[N]),m?e.jsx("div",{className:"min-h-screen flex items-center justify-center",children:e.jsx(q,{size:"xl"})}):r},Er=()=>e.jsx(it,{defaultTheme:"dark",attribute:"class",children:e.jsx(ct,{client:Tr,children:e.jsx(Et,{children:e.jsx(Zt,{children:e.jsxs(Xt,{children:[e.jsx(dt,{richColors:!0,closeButton:!0,position:"top-center"}),e.jsx(ut,{children:e.jsx(Cr,{children:e.jsxs(mt,{children:[e.jsx(G,{path:"/",element:e.jsx(pr,{})}),e.jsx(G,{path:"/shop",element:e.jsx(hr,{})}),e.jsx(G,{path:"/product/:productId",element:e.jsx(xr,{})}),e.jsx(G,{path:"/profile",element:e.jsx(wr,{})}),e.jsx(G,{path:"/cart",element:e.jsx(vr,{})}),e.jsx(G,{path:"/calculator",element:e.jsx(kr,{})}),e.jsx(G,{path:"/settings",element:e.jsx(_r,{})}),e.jsx(G,{path:"*",element:e.jsx(jr,{})})]})})})]})})})})});ae();H();window.addEventListener("load",()=>{H(),setTimeout(()=>{ae()},1e3)});window.toast=v;pt.createRoot(document.getElementById("root")).render(e.jsx(br,{children:e.jsx(ft.StrictMode,{children:e.jsx(Er,{})})}));export{Pt as a,$r as b,Ur as c,Se as d,Or as e,Br as f,It as g,Y as h,zr as i,xe as j,Kt as k,Wr as l,Rr as m,Ir as n,fr as s,me as u,Lr as v};
//# sourceMappingURL=main-BdqkSZIr.js.map
